---
phase: 11-qol-wins
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/desktop/src/lib/csv-export.ts
  - apps/desktop/src/pages/RosterPage.tsx
  - apps/desktop/src/pages/RecordsPage.tsx
  - apps/desktop/src/pages/DashboardPage.tsx
  - apps/desktop/src/components/LogGameModal.tsx
  - apps/desktop/src/components/EditPlayerModal.tsx
  - apps/desktop/src/pages/PlayerProfilePage.tsx
autonomous: true
requirements: [QOL-05, QOL-06, QOL-07, QOL-08]

must_haves:
  truths:
    - "RosterPage has an Export CSV button that opens the OS save dialog and writes a CSV of all visible players"
    - "RecordsPage has an Export CSV button on each leaderboard table"
    - "When creating a new season (seasons already exist), the year input defaults to activeSeason.year + 1"
    - "LogGameModal shows up to 5 recent opponent chips above the team select; clicking one fills the opponent field"
    - "EditPlayerModal has a Notes textarea for the Player.notes field"
    - "PlayerProfilePage displays the notes section when notes are non-empty"
  artifacts:
    - path: "apps/desktop/src/lib/csv-export.ts"
      provides: "exportTableToCsv(rows, filename) utility using papaparse + Tauri save dialog"
    - path: "apps/desktop/src/pages/RosterPage.tsx"
      provides: "Export CSV button using csv-export.ts"
    - path: "apps/desktop/src/pages/RecordsPage.tsx"
      provides: "Export CSV button on each leaderboard table"
    - path: "apps/desktop/src/pages/DashboardPage.tsx"
      provides: "handleCreateFirstSeason uses seasons[0].year + 1 when seasons exist"
    - path: "apps/desktop/src/components/LogGameModal.tsx"
      provides: "Recent opponents chips row above TeamSelect"
    - path: "apps/desktop/src/components/EditPlayerModal.tsx"
      provides: "Notes textarea field for Player.notes"
    - path: "apps/desktop/src/pages/PlayerProfilePage.tsx"
      provides: "Notes display section when player.notes is non-empty"
  key_links:
    - from: "apps/desktop/src/pages/RosterPage.tsx"
      to: "apps/desktop/src/lib/csv-export.ts"
      via: "exportTableToCsv(players as rows, 'roster.csv')"
      pattern: "exportTableToCsv"
    - from: "apps/desktop/src/lib/csv-export.ts"
      to: "@tauri-apps/plugin-dialog save()"
      via: "save() dialog then writeTextFile()"
      pattern: "writeTextFile"
---

<objective>
Implement four targeted UX improvements: (1) CSV export utility + buttons on RosterPage and RecordsPage; (2) auto-suggest year on new season creation; (3) recent opponents quick-select in LogGameModal; (4) player notes field in EditPlayerModal and display in PlayerProfilePage.

Purpose: QOL-05 lets coaches extract data for external analysis; QOL-06 reduces friction when starting a new season; QOL-07 speeds up the most common modal action; QOL-08 adds a free-form notes field that uses the already-typed Player.notes field.

Output: New csv-export.ts utility; modified pages and modals with the four targeted enhancements.
</objective>

<execution_context>
@/Users/chanmoore/.claude/get-shit-done/workflows/execute-plan.md
@/Users/chanmoore/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-qol-wins/11-RESEARCH.md
@apps/desktop/src/lib/export-import.ts
@apps/desktop/src/pages/RosterPage.tsx
@apps/desktop/src/pages/DashboardPage.tsx
@apps/desktop/src/components/LogGameModal.tsx
@apps/desktop/src/components/EditPlayerModal.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: CSV export utility + RosterPage and RecordsPage export buttons</name>
  <files>
    apps/desktop/src/lib/csv-export.ts
    apps/desktop/src/pages/RosterPage.tsx
    apps/desktop/src/pages/RecordsPage.tsx
  </files>
  <action>
**Create apps/desktop/src/lib/csv-export.ts:**

```typescript
import Papa from 'papaparse';
import { save } from '@tauri-apps/plugin-dialog';
import { writeTextFile } from '@tauri-apps/plugin-fs';

/**
 * Export an array of plain objects to a CSV file via the OS save dialog.
 * Uses papaparse for RFC 4180-compliant CSV (headers inferred from first row keys).
 * Uses writeTextFile (fs:allow-write-text-file permission already present in capabilities/default.json).
 * Note: Do NOT use writeFile (binary) — only writeTextFile is permitted for text export.
 */
export async function exportTableToCsv(
  rows: Record<string, unknown>[],
  filename: string
): Promise<void> {
  if (rows.length === 0) return;
  const csv = Papa.unparse(rows);
  const filePath = await save({
    defaultPath: filename,
    filters: [{ name: 'CSV', extensions: ['csv'] }],
  });
  if (!filePath) return; // user cancelled — not an error
  await writeTextFile(filePath, csv);
}
```

**RosterPage.tsx — add export button:**

Import `exportTableToCsv` from '../lib/csv-export'.

In the sub-header section (near the "+ Add Player" button), add an "Export CSV" button:
```tsx
<button
  onClick={handleExportCsv}
  className="px-4 py-2 border border-gray-600 hover:border-gray-500 text-gray-300 hover:text-white text-sm font-semibold rounded-lg transition-colors"
>
  Export CSV
</button>
```

Add the handler:
```typescript
async function handleExportCsv() {
  const rows = sortedPlayers.map((p) => ({
    firstName: p.firstName,
    lastName: p.lastName,
    position: p.position,
    status: p.status,
    recruitingStars: p.recruitingStars ?? '',
    homeState: p.homeState ?? '',
    overallRating: p.overallRating ?? '',
    notes: p.notes ?? '',
  }));
  await exportTableToCsv(rows, 'roster.csv');
}
```

Use `sortedPlayers` (already computed from filtered players) so the CSV reflects the current filter view.

**RecordsPage.tsx — read file first, then add export:**

Read RecordsPage.tsx first to understand its leaderboard table structure. Add an "Export CSV" button near each leaderboard table heading. Shape row objects from the displayed leaderboard data (player name, stat value, season year) for each table. Use `exportTableToCsv(rows, 'records-{statCategory}.csv')`.
  </action>
  <verify>
    <automated>cd /Users/chanmoore/dev/dynasty-os && pnpm --filter @dynasty-os/desktop build 2>&1 | tail -20</automated>
    <manual>Click Export CSV on RosterPage — OS save dialog appears, save as roster.csv, open in a text editor — confirm CSV has correct headers and player rows. Repeat for RecordsPage.</manual>
  </verify>
  <done>csv-export.ts exists; exportTableToCsv exported and importable; RosterPage and RecordsPage have Export CSV buttons that invoke the save dialog; TypeScript build clean.</done>
</task>

<task type="auto">
  <name>Task 2: Year auto-suggest (QOL-06), recent opponents chips (QOL-07), player notes (QOL-08)</name>
  <files>
    apps/desktop/src/pages/DashboardPage.tsx
    apps/desktop/src/components/LogGameModal.tsx
    apps/desktop/src/components/EditPlayerModal.tsx
    apps/desktop/src/pages/PlayerProfilePage.tsx
  </files>
  <action>
**DashboardPage.tsx — QOL-06 year auto-suggest:**

Find `handleCreateFirstSeason`:
```typescript
const handleCreateFirstSeason = async () => {
  await useSeasonStore.getState().createSeason(activeDynasty.id, activeDynasty.currentYear);
};
```

The "Start First Season" button is only shown when `seasons.length === 0`. For the auto-suggest, add a second "New Season" button/flow for when `seasons.length > 0`. Add a "New Season" button in the sidebar (or an inline button near the season widgets) that calls:

```typescript
const handleNewSeason = async () => {
  const suggestedYear = activeSeason ? activeSeason.year + 1 : activeDynasty.currentYear;
  await useSeasonStore.getState().createSeason(activeDynasty.id, suggestedYear);
};
```

Also update the button label on the empty-state button to show the correct year using `activeDynasty.currentYear` (already done — no change needed there since it's the first season case).

Add the "New Season" button to the sidebar's primary CTAs section (beneath "End Season"), visible when `activeSeason` exists:
```tsx
{activeSeason && (
  <button
    onClick={handleNewSeason}
    className="w-full px-3 py-2 bg-gray-700 hover:bg-gray-600 text-white text-sm font-semibold rounded-lg transition-colors"
  >
    + New Season
  </button>
)}
```

This satisfies QOL-06 — the next season year is always `activeSeason.year + 1`, no user typing required.

**LogGameModal.tsx — QOL-07 recent opponents chips:**

Read LogGameModal.tsx first to understand the full component structure.

The `games` array is already available via `useGameStore((s) => s.games)`. Add a `useMemo` to derive the 5 most recent unique opponents:

```typescript
const recentOpponents = useMemo(() => {
  const seen = new Set<string>();
  return [...games]
    .sort((a, b) => b.week - a.week)
    .map((g) => g.opponent)
    .filter((opp) => {
      if (seen.has(opp)) return false;
      seen.add(opp);
      return true;
    })
    .slice(0, 5);
}, [games]);
```

Above the `TeamSelect` component in the JSX, add a chips row (only shown when `recentOpponents.length > 0`):

```tsx
{recentOpponents.length > 0 && (
  <div className="mb-3">
    <label className="block text-xs text-gray-500 mb-1.5">Recent opponents</label>
    <div className="flex flex-wrap gap-1.5">
      {recentOpponents.map((opp) => (
        <button
          key={opp}
          type="button"
          onClick={() => setOpponent(opp)}
          className="px-2.5 py-1 bg-gray-700 hover:bg-gray-600 text-gray-300 hover:text-white text-xs rounded-full transition-colors border border-gray-600"
        >
          {opp}
        </button>
      ))}
    </div>
  </div>
)}
```

Read the file to find the correct state setter name for the opponent field (likely `setOpponent` or similar).

**EditPlayerModal.tsx — QOL-08 player notes:**

Read EditPlayerModal.tsx first. The `Player.notes?: string` field already exists in core-types (confirmed in RESEARCH.md sources).

Add a `notes` state field initialized from `player.notes ?? ''`.

In the form, add a textarea below the existing fields:
```tsx
<div>
  <label className="block text-xs text-gray-500 mb-1.5">Notes</label>
  <textarea
    value={notes}
    onChange={(e) => setNotes(e.target.value)}
    rows={3}
    className="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-white text-sm focus:outline-none focus:border-blue-500 resize-none placeholder-gray-600"
    placeholder="Free-form notes about this player..."
  />
</div>
```

Include `notes` in the `updatePlayer` call when the form is submitted.

**PlayerProfilePage.tsx — QOL-08 display notes:**

Read PlayerProfilePage.tsx first. Find where player attributes are displayed. Add a notes section after the player info block, only shown when `player.notes` is non-empty:

```tsx
{player.notes && (
  <div className="bg-gray-800 rounded-lg p-4">
    <h3 className="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">Notes</h3>
    <p className="text-gray-300 text-sm whitespace-pre-wrap">{player.notes}</p>
  </div>
)}
```
  </action>
  <verify>
    <automated>cd /Users/chanmoore/dev/dynasty-os && pnpm --filter @dynasty-os/desktop build 2>&1 | tail -20</automated>
    <manual>
1. (QOL-06) With an active season, click "+ New Season" — confirm new season created with year = current + 1.
2. (QOL-07) Open Log Game modal after logging 2+ games — confirm recent opponent chips appear above the team selector; clicking one fills the opponent field.
3. (QOL-08) Open Edit Player modal — confirm Notes textarea is present. Save a note, navigate to player profile — confirm notes section displays.
    </manual>
  </verify>
  <done>DashboardPage has New Season button with auto-suggested year; LogGameModal shows recent opponent chips; EditPlayerModal has notes textarea that saves; PlayerProfilePage displays notes when non-empty; TypeScript build clean.</done>
</task>

</tasks>

<verification>
Run `pnpm --filter @dynasty-os/desktop build` — no errors.
Run `grep -n "exportTableToCsv" apps/desktop/src/pages/RosterPage.tsx` — present.
File `apps/desktop/src/lib/csv-export.ts` exists.
Run `grep -n "recentOpponents" apps/desktop/src/components/LogGameModal.tsx` — present.
Run `grep -n "notes" apps/desktop/src/components/EditPlayerModal.tsx` — present.
</verification>

<success_criteria>
1. csv-export.ts exports exportTableToCsv using papaparse + Tauri writeTextFile (not blob URLs).
2. RosterPage and RecordsPage have Export CSV buttons.
3. New season creation always auto-suggests activeSeason.year + 1.
4. LogGameModal shows recent opponent quick-select chips.
5. Player notes can be added in EditPlayerModal and viewed on PlayerProfilePage.
6. TypeScript build clean.
</success_criteria>

<output>
After completion, create `.planning/phases/11-qol-wins/11-04-SUMMARY.md`
</output>
