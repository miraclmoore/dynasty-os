---
phase: 11-qol-wins
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/desktop/src/store/game-store.ts
  - apps/desktop/src/store/player-store.ts
  - apps/desktop/src/store/player-season-store.ts
  - apps/desktop/src/store/season-store.ts
  - apps/desktop/src/pages/RosterPage.tsx
autonomous: true
requirements: [QOL-01, QOL-02]

must_haves:
  truths:
    - "After logging a game, a green toast appears confirming 'Game logged'"
    - "After updating or deleting a game, a green toast with an Undo button appears"
    - "Clicking Undo restores the deleted/edited game and shows a 'Game restored' toast"
    - "After adding, updating, or deleting a player, a confirming toast appears"
    - "After saving player season stats, a confirming toast appears"
    - "RosterPage delete no longer shows window.confirm() — it uses toast-with-undo instead"
  artifacts:
    - path: "apps/desktop/src/store/game-store.ts"
      provides: "logGame/updateGame/deleteGame with toast + undo wiring"
    - path: "apps/desktop/src/store/player-store.ts"
      provides: "addPlayer/updatePlayer/deletePlayer with toast + undo wiring"
    - path: "apps/desktop/src/store/player-season-store.ts"
      provides: "addPlayerSeason/updatePlayerSeason/deletePlayerSeason with toast"
    - path: "apps/desktop/src/store/season-store.ts"
      provides: "createSeason/updateSeason with toast"
    - path: "apps/desktop/src/pages/RosterPage.tsx"
      provides: "handleDelete uses toast-undo pattern, no window.confirm()"
  key_links:
    - from: "apps/desktop/src/store/game-store.ts"
      to: "apps/desktop/src/store/toast-store.ts"
      via: "useToastStore.getState().success() inside store actions"
      pattern: "useToastStore\\.getState\\(\\)"
    - from: "apps/desktop/src/store/game-store.ts"
      to: "apps/desktop/src/store/undo-store.ts"
      via: "useUndoStore.getState().pushUndo() before delete/update"
      pattern: "useUndoStore\\.getState\\(\\)\\.pushUndo"
    - from: "apps/desktop/src/pages/RosterPage.tsx"
      to: "apps/desktop/src/store/undo-store.ts"
      via: "handleDelete calls pushUndo then shows toast with undo action"
      pattern: "pushUndo"
---

<objective>
Wire toast notifications and undo capability into every write operation in game, player, player-season, and season stores. Replace the window.confirm() delete guard in RosterPage with a toast-with-undo pattern.

Purpose: QOL-01 gives coaches immediate feedback on every save; QOL-02 makes destructive actions recoverable without navigation. Both were scaffolded in Phase 10 — this plan wires the call sites.

Output: Modified store files with useToastStore.getState() and useUndoStore.getState() calls at every mutation; RosterPage with window.confirm() removed.
</objective>

<execution_context>
@/Users/chanmoore/.claude/get-shit-done/workflows/execute-plan.md
@/Users/chanmoore/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-qol-wins/11-RESEARCH.md
@apps/desktop/src/store/game-store.ts
@apps/desktop/src/store/player-store.ts
@apps/desktop/src/store/player-season-store.ts
@apps/desktop/src/store/season-store.ts
@apps/desktop/src/store/toast-store.ts
@apps/desktop/src/store/undo-store.ts
@apps/desktop/src/pages/RosterPage.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire toast notifications into all Zustand store write operations</name>
  <files>
    apps/desktop/src/store/game-store.ts
    apps/desktop/src/store/player-store.ts
    apps/desktop/src/store/player-season-store.ts
    apps/desktop/src/store/season-store.ts
  </files>
  <action>
Add `import { useToastStore } from './toast-store';` and `import { useUndoStore, type UndoableOperation } from './undo-store';` at the top of game-store.ts and player-store.ts. Add only `import { useToastStore } from './toast-store';` to player-season-store.ts and season-store.ts.

CRITICAL: Always call `useToastStore.getState().success()` (not the hook) — Zustand actions run outside the React render cycle. Never import toast() from sonner directly (STATE.md Phase 10-04 decision).

**game-store.ts changes:**

`logGame`: After `set({ games, loading: false })`, add:
```typescript
useToastStore.getState().success('Game logged', `vs ${input.opponent}`);
```
In the catch block, add:
```typescript
useToastStore.getState().error('Failed to log game', String(err));
```

`updateGame`: Before calling `svcUpdate(id, updates)`, snapshot the existing game and push undo:
```typescript
const { games } = get();
const existing = games.find((g) => g.id === id);
if (existing) {
  const op: UndoableOperation = {
    id: crypto.randomUUID(),
    table: 'games',
    operation: 'update',
    recordId: id,
    snapshot: existing as Record<string, unknown>,
    description: `Edit game vs ${existing.opponent}`,
    performedAt: Date.now(),
  };
  useUndoStore.getState().pushUndo(op);
}
```
After successful update, add:
```typescript
useToastStore.getState().success('Game updated');
```
In catch: `useToastStore.getState().error('Failed to update game', String(err));`

`deleteGame`: After `const existing = games.find((g) => g.id === id);` and before `await svcDelete(id)`, push undo snapshot:
```typescript
if (existing) {
  const op: UndoableOperation = {
    id: crypto.randomUUID(),
    table: 'games',
    operation: 'delete',
    recordId: id,
    snapshot: existing as Record<string, unknown>,
    description: `Delete game vs ${existing.opponent}`,
    performedAt: Date.now(),
  };
  useUndoStore.getState().pushUndo(op);
}
```
After successful delete, add toast with undo action. Import `toast` from 'sonner' ONLY in game-store.ts for the action button pattern (because the Undo onClick needs a reload callback — use sonner directly for the action button, but keep useToastStore for simple success/error calls):
```typescript
import { toast } from 'sonner';
// ...
const seasonId = existing?.seasonId;
toast.success('Game deleted', {
  action: {
    label: 'Undo',
    onClick: async () => {
      await useUndoStore.getState().undo();
      if (seasonId) await useGameStore.getState().loadGames(seasonId);
      toast.success('Game restored');
    },
  },
});
```
In catch: `useToastStore.getState().error('Failed to delete game', String(err));`

**player-store.ts changes:**

`addPlayer`: After `set({ players, loading: false })`, add:
```typescript
useToastStore.getState().success('Player added', `${input.firstName} ${input.lastName}`);
```
In catch: `useToastStore.getState().error('Failed to add player', String(err));`

`updatePlayer`: Before `svcUpdate`, snapshot existing player and push undo:
```typescript
const { players } = get();
const existing = players.find((p) => p.id === id);
if (existing) {
  useUndoStore.getState().pushUndo({
    id: crypto.randomUUID(),
    table: 'players',
    operation: 'update',
    recordId: id,
    snapshot: existing as Record<string, unknown>,
    description: `Edit player ${existing.firstName} ${existing.lastName}`,
    performedAt: Date.now(),
  });
}
```
After success: `useToastStore.getState().success('Player updated');`
In catch: `useToastStore.getState().error('Failed to update player', String(err));`

`deletePlayer`: Before `svcDelete`, snapshot and push undo (use same pattern as game store, with `toast` from sonner for the action button):
```typescript
import { toast } from 'sonner'; // add at top of player-store.ts
// snapshot existing player already captured in get().players.find(...)
if (existing) {
  useUndoStore.getState().pushUndo({
    id: crypto.randomUUID(),
    table: 'players',
    operation: 'delete',
    recordId: id,
    snapshot: existing as Record<string, unknown>,
    description: `Delete player ${existing.firstName} ${existing.lastName}`,
    performedAt: Date.now(),
  });
}
// ...after svcDelete:
const dynastyId = existing?.dynastyId;
toast.success('Player deleted', {
  action: {
    label: 'Undo',
    onClick: async () => {
      await useUndoStore.getState().undo();
      if (dynastyId) await usePlayerStore.getState().loadPlayers(dynastyId);
      toast.success('Player restored');
    },
  },
});
```
In catch: `useToastStore.getState().error('Failed to delete player', String(err));`

**player-season-store.ts changes:**

`addPlayerSeason`: After success: `useToastStore.getState().success('Season stats saved');`
In catch: `useToastStore.getState().error('Failed to save stats', String(err));`

`updatePlayerSeason`: After success: `useToastStore.getState().success('Season stats updated');`
In catch: `useToastStore.getState().error('Failed to update stats', String(err));`

`deletePlayerSeason`: After success: `useToastStore.getState().success('Season stats deleted');`
In catch: `useToastStore.getState().error('Failed to delete stats', String(err));`

**season-store.ts changes:**

`createSeason`: After `set({ seasons, activeSeason: season, loading: false })`, add:
```typescript
useToastStore.getState().success('Season started', `${season.year} season`);
```
In catch: `useToastStore.getState().error('Failed to start season', String(err));`

`updateSeason`: After `set({ seasons: reloaded, activeSeason, loading: false })`, add:
```typescript
useToastStore.getState().success('Season data saved');
```
In catch: `useToastStore.getState().error('Failed to save season data', String(err));`
  </action>
  <verify>
    <automated>cd /Users/chanmoore/dev/dynasty-os && pnpm --filter @dynasty-os/desktop build 2>&1 | tail -20</automated>
    <manual>Launch app in dev mode, log a game — confirm green toast "Game logged" appears bottom-right. Delete a game — confirm toast with "Undo" button appears. Click Undo — confirm game reappears in game log.</manual>
  </verify>
  <done>All write operations in all 4 stores emit toasts; deleteGame and deletePlayer push undo operations and show toast-with-undo-button; TypeScript build passes with no new errors.</done>
</task>

<task type="auto">
  <name>Task 2: Replace window.confirm() in RosterPage with toast-undo delete pattern</name>
  <files>
    apps/desktop/src/pages/RosterPage.tsx
  </files>
  <action>
In RosterPage.tsx, find the `handleDelete` function:

```typescript
async function handleDelete(player: Player) {
  const confirmed = window.confirm(
    `Delete ${player.firstName} ${player.lastName}? This will also delete all their season stats.`
  );
  if (!confirmed) return;
  await usePlayerStore.getState().deletePlayer(player.id);
}
```

Replace it with the non-blocking version that relies on the undo-toast now emitted by `deletePlayer` in player-store (Task 1 wired this):

```typescript
async function handleDelete(player: Player) {
  await usePlayerStore.getState().deletePlayer(player.id);
}
```

The `window.confirm()` blocking dialog is removed entirely. The toast-with-undo button emitted by `deletePlayer` is the recovery mechanism (STATE.md: "state of the art" section in RESEARCH.md).

No other changes to RosterPage in this task — filter persistence wiring is in Plan 02.
  </action>
  <verify>
    <automated>cd /Users/chanmoore/dev/dynasty-os && grep -n "window.confirm" apps/desktop/src/pages/RosterPage.tsx; echo "Exit: $?"</automated>
    <manual>In the app, delete a player from RosterPage — confirm no blocking confirm dialog appears, player disappears immediately, and a toast with "Undo" appears. Click Undo — confirm player reappears in the roster list.</manual>
  </verify>
  <done>window.confirm() is gone from RosterPage.handleDelete; deleting a player emits toast-with-undo pattern; TypeScript build still passes.</done>
</task>

</tasks>

<verification>
Run `pnpm --filter @dynasty-os/desktop build` — no TypeScript errors.
Run `grep -rn "window.confirm" apps/desktop/src/` — zero matches.
Run `grep -rn "useToastStore.getState()" apps/desktop/src/store/` — present in game-store.ts, player-store.ts, player-season-store.ts, season-store.ts.
Run `grep -rn "useUndoStore.getState().pushUndo" apps/desktop/src/store/` — present in game-store.ts and player-store.ts.
</verification>

<success_criteria>
1. Every write in game/player/player-season/season stores emits a toast (success or error).
2. deleteGame and deletePlayer push an undo snapshot and show a sonner action button.
3. Clicking the Undo button in the toast restores the record and reloads the relevant Zustand store.
4. RosterPage uses the toast-undo path — no blocking confirm dialog.
5. TypeScript build passes clean.
</success_criteria>

<output>
After completion, create `.planning/phases/11-qol-wins/11-01-SUMMARY.md`
</output>
