---
phase: 11-qol-wins
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/desktop/src/components/CommandPalette.tsx
  - apps/desktop/src/App.tsx
autonomous: true
requirements: [QOL-04]

must_haves:
  truths:
    - "Pressing Cmd+K (macOS) or Ctrl+K (Windows) from any page opens the command palette"
    - "Typing in the palette fuzzy-filters navigation destinations"
    - "Selecting any item navigates to that page and closes the palette"
    - "Pressing Escape closes the palette"
    - "The palette input receives focus when it opens (not blocked by Tauri WebView)"
  artifacts:
    - path: "apps/desktop/src/components/CommandPalette.tsx"
      provides: "cmdk Command.Dialog with all 18 nav pages + quick actions"
      min_lines: 80
    - path: "apps/desktop/src/App.tsx"
      provides: "commandPaletteOpen state + Cmd+K listener wired to toggle; CommandPalette mounted"
  key_links:
    - from: "apps/desktop/src/App.tsx"
      to: "apps/desktop/src/components/CommandPalette.tsx"
      via: "open prop + onOpenChange prop from App useState"
      pattern: "CommandPalette.*open="
    - from: "apps/desktop/src/components/CommandPalette.tsx"
      to: "apps/desktop/src/store/navigation-store.ts"
      via: "useNavigationStore.getState().goToXxx() in onSelect callbacks"
      pattern: "useNavigationStore\\.getState\\(\\)"
---

<objective>
Create the CommandPalette component using cmdk's Command.Dialog, register all 18 navigation pages and key quick actions, then wire App.tsx's Cmd+K stub to open/close the palette.

Purpose: QOL-04 gives power users a keyboard-first way to jump anywhere in the app. The Cmd+K keydown listener was registered in Phase 10 as a stub — this plan replaces the stub with real toggle logic and mounts the palette.

Output: New CommandPalette.tsx component; App.tsx updated to render it with open state.
</objective>

<execution_context>
@/Users/chanmoore/.claude/get-shit-done/workflows/execute-plan.md
@/Users/chanmoore/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-qol-wins/11-RESEARCH.md
@apps/desktop/src/App.tsx
@apps/desktop/src/store/navigation-store.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CommandPalette.tsx with all navigation pages and quick actions</name>
  <files>
    apps/desktop/src/components/CommandPalette.tsx
  </files>
  <action>
Create `apps/desktop/src/components/CommandPalette.tsx`.

Import `Command` from 'cmdk' and `useNavigationStore` from '../store/navigation-store'. Import `useDynastyStore` from '../store' to check active dynasty sport for CFB-only items.

The component accepts `{ open: boolean; onOpenChange: (open: boolean) => void }` props.

Use `Command.Dialog` as the root (renders in Radix portal, handles focus trap + Escape key automatically). Add an `onOpenChange` prop forwarded to `Command.Dialog`.

**cmdk styling note:** cmdk components are unstyled — apply Tailwind classes directly. Use `data-[selected=true]:` prefix for selected item highlight (cmdk sets `data-selected` attribute). Target `[cmdk-input-wrapper]`, `[cmdk-list]`, `[cmdk-group-heading]`, `[cmdk-item]` for structural styling.

**Structure:**
```tsx
import React, { useEffect, useRef } from 'react';
import { Command } from 'cmdk';
import { useNavigationStore } from '../store/navigation-store';
import { useDynastyStore } from '../store';

interface CommandPaletteProps {
  open: boolean;
  onOpenChange: (open: boolean) => void;
}

export function CommandPalette({ open, onOpenChange }: CommandPaletteProps) {
  const nav = useNavigationStore.getState();
  const activeDynasty = useDynastyStore.getState().activeDynasty;
  const inputRef = useRef<HTMLInputElement>(null);

  // Tauri WebView focus fix: imperatively focus input after dialog opens
  useEffect(() => {
    if (open) {
      setTimeout(() => inputRef.current?.focus(), 50);
    }
  }, [open]);

  const select = (action: () => void) => {
    action();
    onOpenChange(false);
  };

  return (
    <Command.Dialog
      open={open}
      onOpenChange={onOpenChange}
      label="Command Palette"
      className="fixed inset-0 z-50 flex items-start justify-center pt-[20vh]"
    >
      {/* Backdrop */}
      <div className="fixed inset-0 bg-black/60" onClick={() => onOpenChange(false)} />
      {/* Palette card */}
      <div className="relative z-10 w-full max-w-xl bg-gray-900 border border-gray-700 rounded-xl shadow-2xl overflow-hidden">
        <Command className="[&_[cmdk-input-wrapper]]:border-b [&_[cmdk-input-wrapper]]:border-gray-700">
          <Command.Input
            ref={inputRef}
            placeholder="Type a command or search..."
            className="w-full bg-transparent px-4 py-3 text-white placeholder-gray-500 outline-none text-sm"
          />
          <Command.List className="max-h-80 overflow-y-auto p-2">
            <Command.Empty className="py-6 text-center text-sm text-gray-500">
              No results found.
            </Command.Empty>

            {/* Navigate group */}
            <Command.Group
              heading="Navigate"
              className="[&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:py-1.5 [&_[cmdk-group-heading]]:text-xs [&_[cmdk-group-heading]]:font-semibold [&_[cmdk-group-heading]]:text-gray-500 [&_[cmdk-group-heading]]:uppercase [&_[cmdk-group-heading]]:tracking-wider"
            >
              <PaletteItem value="nav-dashboard" onSelect={() => select(() => nav.goToDashboard())}>Dashboard</PaletteItem>
              <PaletteItem value="nav-roster" onSelect={() => select(() => nav.goToRoster())}>Roster</PaletteItem>
              <PaletteItem value="nav-legends" onSelect={() => select(() => nav.goToLegends())}>Program Legends</PaletteItem>
              <PaletteItem value="nav-records" onSelect={() => select(() => nav.goToRecords())}>Records &amp; Leaderboards</PaletteItem>
              <PaletteItem value="nav-trophy-room" onSelect={() => select(() => nav.goToTrophyRoom())}>Trophy Room</PaletteItem>
              <PaletteItem value="nav-coaching-resume" onSelect={() => select(() => nav.goToCoachingResume())}>Coaching Resume</PaletteItem>
              <PaletteItem value="nav-scouting-card" onSelect={() => select(() => nav.goToScoutingCard())}>Scouting Cards</PaletteItem>
              <PaletteItem value="nav-screenshot-ingestion" onSelect={() => select(() => nav.goToScreenshotIngestion())}>Parse Screenshot</PaletteItem>
              {activeDynasty?.sport === 'madden' && (
                <PaletteItem value="nav-madden-sync" onSelect={() => select(() => nav.goToMaddenSync())}>Sync Franchise Save</PaletteItem>
              )}
              {(activeDynasty?.sport === 'madden' || activeDynasty?.sport === 'nfl2k') && (
                <PaletteItem value="nav-roster-hub" onSelect={() => select(() => nav.goToRosterHub())}>Community Rosters</PaletteItem>
              )}
            </Command.Group>

            {/* CFB group — only for cfb dynasties */}
            {activeDynasty?.sport === 'cfb' && (
              <Command.Group
                heading="CFB Program"
                className="[&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:py-1.5 [&_[cmdk-group-heading]]:text-xs [&_[cmdk-group-heading]]:font-semibold [&_[cmdk-group-heading]]:text-gray-500 [&_[cmdk-group-heading]]:uppercase [&_[cmdk-group-heading]]:tracking-wider"
              >
                <PaletteItem value="nav-recruiting" onSelect={() => select(() => nav.goToRecruiting())}>Recruiting</PaletteItem>
                <PaletteItem value="nav-transfer-portal" onSelect={() => select(() => nav.goToTransferPortal())}>Transfer Portal</PaletteItem>
                <PaletteItem value="nav-draft-tracker" onSelect={() => select(() => nav.goToDraftTracker())}>NFL Draft Tracker</PaletteItem>
                <PaletteItem value="nav-prestige-tracker" onSelect={() => select(() => nav.goToPrestigeTracker())}>Program Prestige</PaletteItem>
                <PaletteItem value="nav-rivalry-tracker" onSelect={() => select(() => nav.goToRivalryTracker())}>Rivalry Tracker</PaletteItem>
                <PaletteItem value="nav-program-timeline" onSelect={() => select(() => nav.goToProgramTimeline())}>Program Timeline</PaletteItem>
              </Command.Group>
            )}
          </Command.List>
        </Command>
      </div>
    </Command.Dialog>
  );
}

// Reusable styled item to keep JSX DRY
function PaletteItem({
  value,
  onSelect,
  children,
}: {
  value: string;
  onSelect: () => void;
  children: React.ReactNode;
}) {
  return (
    <Command.Item
      value={value}
      onSelect={onSelect}
      className="flex items-center px-3 py-2 rounded-lg text-sm text-gray-300 cursor-pointer data-[selected=true]:bg-gray-700 data-[selected=true]:text-white transition-colors"
    >
      {children}
    </Command.Item>
  );
}
```

Note: `Command.Item value` must be unique across all groups — use prefixed IDs like `nav-dashboard`, `nav-roster`, etc. cmdk filters against the `value` prop (not the children text), so set the value to descriptive unique IDs. The children text is what the user sees.
  </action>
  <verify>
    <automated>cd /Users/chanmoore/dev/dynasty-os && pnpm --filter @dynasty-os/desktop build 2>&1 | tail -20</automated>
    <manual>Inspect CommandPalette.tsx exists at apps/desktop/src/components/CommandPalette.tsx and has no TypeScript errors.</manual>
  </verify>
  <done>CommandPalette.tsx created with Command.Dialog, all 18 navigation items (sport-gated appropriately), PaletteItem helper, focus fix, and Tailwind styling. TypeScript build passes.</done>
</task>

<task type="auto">
  <name>Task 2: Wire App.tsx Cmd+K stub to CommandPalette open state</name>
  <files>
    apps/desktop/src/App.tsx
  </files>
  <action>
In App.tsx, add `import React, { useEffect, useRef, useState } from 'react';` (add `useState` to the existing import — currently only useEffect and useRef are imported).

Add `import { CommandPalette } from './components/CommandPalette';` with the other component imports.

In the `App` function body, add state:
```typescript
const [commandPaletteOpen, setCommandPaletteOpen] = useState(false);
```

Replace the Cmd+K listener stub comment with the actual toggle:
```typescript
// Replace this line:
// Command palette toggle — wired in Phase 11
// console.log('Command palette trigger registered');

// With:
setCommandPaletteOpen((prev) => !prev);
```

So the full handler becomes:
```typescript
const handleKeyDown = (e: KeyboardEvent) => {
  if (e.key === 'k' && (e.metaKey || e.ctrlKey)) {
    e.preventDefault();
    setCommandPaletteOpen((prev) => !prev);
  }
};
```

In the JSX return, add `<CommandPalette>` after `<PageContent />` and before `<TickerBar />`:
```tsx
return (
  <div className="pb-10">
    <input
      ref={hiddenInputRef}
      style={{ position: 'fixed', opacity: 0, pointerEvents: 'none', width: 0, height: 0 }}
      tabIndex={-1}
      readOnly
      aria-hidden="true"
    />
    <PageContent />
    <CommandPalette open={commandPaletteOpen} onOpenChange={setCommandPaletteOpen} />
    <TickerBar />
    <Toaster richColors position="bottom-right" />
  </div>
);
```

The `CommandPalette` renders into a Radix Dialog portal so its z-index is unaffected by the `pb-10` wrapper.
  </action>
  <verify>
    <automated>cd /Users/chanmoore/dev/dynasty-os && pnpm --filter @dynasty-os/desktop build 2>&1 | tail -20</automated>
    <manual>Press Cmd+K in the app — command palette opens with search input. Type "rost" — Roster item appears highlighted. Press Enter or click it — navigates to RosterPage and palette closes. Press Cmd+K again — palette reopens. Press Escape — palette closes.</manual>
  </verify>
  <done>App.tsx has commandPaletteOpen useState; Cmd+K toggles it; CommandPalette is mounted in JSX and functional. TypeScript build passes clean.</done>
</task>

</tasks>

<verification>
Run `pnpm --filter @dynasty-os/desktop build` — no errors.
Run `grep -n "commandPaletteOpen" apps/desktop/src/App.tsx` — state and setter present.
Run `grep -n "Command.Dialog" apps/desktop/src/components/CommandPalette.tsx` — present.
File `apps/desktop/src/components/CommandPalette.tsx` exists and has > 80 lines.
</verification>

<success_criteria>
1. Cmd+K / Ctrl+K opens the palette from any page.
2. Typing fuzzy-filters all navigation items.
3. Selecting an item navigates and closes.
4. Escape closes the palette.
5. Palette input auto-focuses on open (including in Tauri WebView).
6. TypeScript build clean.
</success_criteria>

<output>
After completion, create `.planning/phases/11-qol-wins/11-03-SUMMARY.md`
</output>
