---
phase: 05-cfb-features
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - apps/desktop/src/lib/transfer-portal-service.ts
  - apps/desktop/src/store/transfer-portal-store.ts
  - apps/desktop/src/store/index.ts
  - apps/desktop/src/pages/TransferPortalPage.tsx
  - apps/desktop/src/App.tsx
autonomous: true

must_haves:
  truths:
    - "User can log a transfer portal arrival with player name, position, stars, and origin school"
    - "User can log a transfer portal departure with player name, position, and destination school"
    - "User can view the annual War Room showing arrivals and departures side by side with net impact rating"
    - "Transfer portal features are hidden for Madden dynasties"
  artifacts:
    - path: "apps/desktop/src/lib/transfer-portal-service.ts"
      provides: "CRUD for transfer portal entries"
      exports: ["createTransferPortalEntry", "getTransferPortalEntriesBySeason", "getTransferPortalEntriesByDynasty", "deleteTransferPortalEntry"]
    - path: "apps/desktop/src/store/transfer-portal-store.ts"
      provides: "Zustand store for transfer portal state"
      exports: ["useTransferPortalStore"]
    - path: "apps/desktop/src/pages/TransferPortalPage.tsx"
      provides: "War Room UI with arrival/departure tables and net impact score"
  key_links:
    - from: "apps/desktop/src/lib/transfer-portal-service.ts"
      to: "@dynasty-os/db"
      via: "db.transferPortalEntries"
      pattern: "db\\.transferPortalEntries"
    - from: "apps/desktop/src/store/transfer-portal-store.ts"
      to: "transfer-portal-service.ts"
      via: "service function calls"
      pattern: "import.*transfer-portal-service"
    - from: "apps/desktop/src/pages/TransferPortalPage.tsx"
      to: "transfer-portal-store.ts"
      via: "useTransferPortalStore hook"
      pattern: "useTransferPortalStore"
---

<objective>
Build the transfer portal war room — service layer for logging arrivals and departures, Zustand store, and a War Room page that shows arrivals and departures side by side with a calculated net impact rating.

Purpose: Coaches need to track player movement through the transfer portal to understand their program's roster churn and evaluate whether the portal helped or hurt their team each season.

Output: TransferPortal service with CRUD, Zustand store, TransferPortalPage with entry forms, arrival/departure tables, season filter, and net impact score.
</objective>

<execution_context>
@/Users/chanmoore/.claude/get-shit-done/workflows/execute-plan.md
@/Users/chanmoore/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-cfb-features/05-01-SUMMARY.md

@packages/core-types/src/transfer-portal.ts
@packages/db/src/dynasty-db.ts
@apps/desktop/src/lib/player-service.ts
@apps/desktop/src/store/navigation-store.ts
@apps/desktop/src/App.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Transfer portal service and store</name>
  <files>
    apps/desktop/src/lib/transfer-portal-service.ts
    apps/desktop/src/store/transfer-portal-store.ts
    apps/desktop/src/store/index.ts
  </files>
  <action>
  1. Create `apps/desktop/src/lib/transfer-portal-service.ts`:
     - Import db from @dynasty-os/db, TransferPortalEntry from @dynasty-os/core-types, generateId from ./uuid.
     - CRUD functions following player-service.ts pattern:
       - `createTransferPortalEntry(input: Omit<TransferPortalEntry, 'id' | 'createdAt' | 'updatedAt'>)` — add timestamps, generateId, db.transferPortalEntries.add(), return the entry
       - `getTransferPortalEntriesBySeason(seasonId: string)` — db.transferPortalEntries.where('seasonId').equals(seasonId).toArray() (use the [dynastyId+seasonId] compound index if needed, but simple seasonId index works since seasonId is indexed)
         Actually, check the schema — transferPortalEntries has `[dynastyId+seasonId]` compound index. For season-level query, use db.transferPortalEntries.where('[dynastyId+seasonId]').equals([dynastyId, seasonId]).toArray(). Alternatively just filter: db.transferPortalEntries.where('seasonId').equals(seasonId).toArray(). The seasonId field IS individually indexed in SCHEMA, so direct where is fine.
       - `getTransferPortalEntriesByDynasty(dynastyId: string)` — db.transferPortalEntries.where('dynastyId').equals(dynastyId).toArray()
       - `deleteTransferPortalEntry(id: string)` — db.transferPortalEntries.delete(id)
     - Net impact calculation helper (pure function, exported):
       - `calculateNetImpact(entries: TransferPortalEntry[]): { arrivals: TransferPortalEntry[], departures: TransferPortalEntry[], arrivalStars: number, departureCount: number, netImpactScore: number, netImpactLabel: string }`
       - Filter arrivals (type === 'arrival') and departures (type === 'departure')
       - arrivalStars = sum of stars for all arrivals (default 0 for missing)
       - departureCount = departures.length
       - netImpactScore = arrivalStars - (departureCount * 2.5)
       - netImpactLabel: if score > 5 "Strong Gain", if score > 0 "Net Positive", if score === 0 "Even", if score > -5 "Net Negative", else "Significant Loss"

  2. Create `apps/desktop/src/store/transfer-portal-store.ts`:
     - Zustand store with state: entries: TransferPortalEntry[], loading: boolean
     - Actions:
       - `loadEntries(seasonId: string)` — calls getTransferPortalEntriesBySeason, sets entries
       - `addEntry(input)` — calls createTransferPortalEntry, then loadEntries(input.seasonId)
       - `removeEntry(id, seasonId)` — calls deleteTransferPortalEntry, then loadEntries(seasonId)

  3. Update `apps/desktop/src/store/index.ts` — add:
     ```ts
     export { useTransferPortalStore } from './transfer-portal-store';
     ```
  </action>
  <verify>Run `cd /Users/chanmoore/dev/dynasty-os && pnpm turbo build --filter=desktop` — must compile with no type errors.</verify>
  <done>Transfer portal service has CRUD + net impact calculation. Store manages entries state with load/add/remove actions. Store exported from barrel.</done>
</task>

<task type="auto">
  <name>Task 2: Transfer Portal War Room page and App.tsx routing</name>
  <files>
    apps/desktop/src/pages/TransferPortalPage.tsx
    apps/desktop/src/App.tsx
  </files>
  <action>
  1. Create `apps/desktop/src/pages/TransferPortalPage.tsx`:
     - Import useTransferPortalStore, useDynastyStore, useSeasonStore, useNavigationStore, calculateNetImpact from transfer-portal-service.
     - CFB-only guard: if activeDynasty.sport !== 'cfb', show "Transfer Portal is only available for College Football dynasties." with back button.
     - Layout: dark theme (bg-gray-900 text-white), header with "Transfer Portal War Room" title, back button (goToDashboard).
     - Season selector: dropdown of all seasons for the dynasty (from useSeasonStore.seasons), defaults to active season. On change, call loadEntries(selectedSeasonId).
     - Load entries on mount for active season (loadEntries(activeSeason.id)).
     - Net Impact banner at top: use calculateNetImpact(entries) to get score and label. Display score as large number (green if positive, red if negative, gray if zero) and label text beside it. Show arrival stars total and departure count.
     - Two-column layout (side by side on lg, stacked on mobile):
       - **Arrivals column** (left): table with columns: Player Name, Position, Stars (1-5 select), Origin School. "Add Arrival" form at top with input fields for playerName, position (text input), stars (1-5 select), originSchool. Submit button. List of arrivals below with delete (X) button per row.
       - **Departures column** (right): table with columns: Player Name, Position, Destination. "Add Departure" form at top with input fields for playerName, position, destinationSchool. Submit button. List of departures below with delete (X) button per row.
     - Forms clear after submission. Use local state for form fields.
     - When adding arrival, set type: 'arrival' and pass stars/originSchool. When adding departure, set type: 'departure' and pass destinationSchool.

  2. Update `apps/desktop/src/App.tsx`:
     - Import TransferPortalPage.
     - Add case 'transfer-portal': return <TransferPortalPage /> to the switch.
  </action>
  <verify>Run `cd /Users/chanmoore/dev/dynasty-os && pnpm turbo build` — full build passes. Verify App.tsx switch has 'transfer-portal' case.</verify>
  <done>TransferPortalPage shows War Room with season selector, net impact banner, arrivals table with add form, departures table with add form. App.tsx routes to TransferPortalPage. CFB-only guard active.</done>
</task>

</tasks>

<verification>
1. `pnpm turbo build` passes with no errors
2. Transfer portal service exports CRUD functions and calculateNetImpact
3. TransferPortalPage has CFB-only guard
4. War Room shows arrivals and departures side by side
5. Net impact score calculates correctly: arrivalStars - (departureCount * 2.5)
6. App.tsx routes 'transfer-portal' to TransferPortalPage
</verification>

<success_criteria>
- User can log transfer portal arrivals with name, position, stars, origin school
- User can log transfer portal departures with name, position, destination
- War Room displays arrivals/departures side by side with net impact rating
- Season filter allows viewing historical portal activity
- CFB-only guard prevents Madden dynasties from accessing this feature
- Full build compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/05-cfb-features/05-02-SUMMARY.md`
</output>
