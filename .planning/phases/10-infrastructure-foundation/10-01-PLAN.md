---
phase: 10-infrastructure-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/db/src/schema.ts
  - packages/db/src/dynasty-db.ts
  - packages/core-types/src/player.ts
  - packages/core-types/src/coaching-staff.ts
  - packages/core-types/src/nil-entry.ts
  - packages/core-types/src/future-game.ts
  - packages/core-types/src/player-link.ts
  - packages/core-types/src/ai-cache.ts
  - packages/core-types/src/index.ts
autonomous: true
requirements:
  - INFRA-GATE-1

must_haves:
  truths:
    - "App opens on an existing DB at schema v5 without VersionError — Dexie upgrades cleanly to v6"
    - "All 5 new tables (coachingStaff, nilEntries, futureGames, playerLinks, aiCache) are present in IndexedDB after upgrade"
    - "Player type includes birthYear?: number field without schema migration required"
    - "5 new core type interfaces are exported from @dynasty-os/core-types with all Phase 12-13 required fields"
  artifacts:
    - path: "packages/db/src/schema.ts"
      provides: "SCHEMA_V6 const with 5 new tables spread over existing SCHEMA, DB_VERSION bumped to 6"
      contains: "coachingStaff, nilEntries, futureGames, playerLinks, aiCache"
    - path: "packages/db/src/dynasty-db.ts"
      provides: "DynastyDB class with this.version(6).stores(SCHEMA_V6) and db.on('versionchange') handler"
      exports: ["DynastyDB", "db"]
    - path: "packages/core-types/src/coaching-staff.ts"
      provides: "CoachingStaff interface"
    - path: "packages/core-types/src/nil-entry.ts"
      provides: "NilEntry interface"
    - path: "packages/core-types/src/future-game.ts"
      provides: "FutureGame interface"
    - path: "packages/core-types/src/player-link.ts"
      provides: "PlayerLink interface"
    - path: "packages/core-types/src/ai-cache.ts"
      provides: "AiCacheEntry interface and AiContentType union type"
  key_links:
    - from: "packages/db/src/dynasty-db.ts"
      to: "packages/db/src/schema.ts"
      via: "import { SCHEMA_V6, DB_NAME } from './schema'"
      pattern: "SCHEMA_V6"
    - from: "packages/core-types/src/index.ts"
      to: "packages/core-types/src/ai-cache.ts"
      via: "export * from './ai-cache'"
      pattern: "export.*ai-cache"
---

<objective>
Bump the Dexie schema from v5 to v6 (adding 5 new tables) and define all new core types that Phases 12–13 depend on.

Purpose: Every downstream phase requires the DB tables and TypeScript types to exist before it can build features. This plan establishes those contracts.
Output: Updated schema.ts and dynasty-db.ts; 5 new type files; Player.birthYear added; all new types exported from core-types.
</objective>

<execution_context>
@/Users/chanmoore/.claude/get-shit-done/workflows/execute-plan.md
@/Users/chanmoore/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@packages/db/src/schema.ts
@packages/db/src/dynasty-db.ts
@packages/core-types/src/index.ts
@packages/core-types/src/player.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Dexie schema v6 migration — add 5 new tables</name>
  <files>packages/db/src/schema.ts</files>
  <files>packages/db/src/dynasty-db.ts</files>
  <action>
In `packages/db/src/schema.ts`:
- Keep the existing `SCHEMA` const exactly as-is (do NOT modify it — it is the v5 schema used by version(5) call)
- Add a new `SCHEMA_V6` const using spread: `export const SCHEMA_V6 = { ...SCHEMA, coachingStaff: 'id, dynastyId, role, hireYear, [dynastyId+role]', nilEntries: 'id, dynastyId, playerId, year, [dynastyId+playerId]', futureGames: 'id, dynastyId, year, [dynastyId+year]', playerLinks: 'id, dynastyId, playerId, [dynastyId+playerId]', aiCache: 'id, dynastyId, cacheKey, contentType, createdAt, [dynastyId+contentType]' } as const;`
- Bump `DB_VERSION` from 5 to 6

In `packages/db/src/dynasty-db.ts`:
- Import `SCHEMA_V6` from `./schema` alongside existing `SCHEMA, DB_NAME`
- Import the 5 new types from `@dynasty-os/core-types`: `CoachingStaff, NilEntry, FutureGame, PlayerLink, AiCacheEntry`
- Add 5 new typed Table declarations after `achievements!`:
  ```
  coachingStaff!: Table<CoachingStaff, string>;
  nilEntries!: Table<NilEntry, string>;
  futureGames!: Table<FutureGame, string>;
  playerLinks!: Table<PlayerLink, string>;
  aiCache!: Table<AiCacheEntry, string>;
  ```
- In the constructor, keep `this.version(1).stores(SCHEMA)`, `this.version(4).stores(SCHEMA)`, `this.version(5).stores(SCHEMA)` exactly as-is
- Add `this.version(6).stores(SCHEMA_V6);` after the v5 line
- Add after all version() calls: `this.on('versionchange', () => { this.close(); window.location.reload(); });`

CRITICAL — do NOT write `this.version(6).stores(SCHEMA)` (old schema). Must use `SCHEMA_V6` to avoid dropping existing tables. All 3 prior version() calls must remain unchanged.
  </action>
  <verify>
    <automated>cd /Users/chanmoore/dev/dynasty-os && pnpm --filter @dynasty-os/db build 2>&1 | tail -5</automated>
    <manual>Confirm `packages/db/src/schema.ts` has both SCHEMA and SCHEMA_V6 consts; DB_VERSION is 6; dynasty-db.ts has all 5 new Table declarations and version(6) call</manual>
  </verify>
  <done>@dynasty-os/db builds cleanly; dynasty-db.ts declares this.version(6).stores(SCHEMA_V6) and the versionchange handler; SCHEMA_V6 spreads all 13 existing tables plus 5 new ones</done>
</task>

<task type="auto">
  <name>Task 2: New core types — CoachingStaff, NilEntry, FutureGame, PlayerLink, AiCacheEntry, Player.birthYear</name>
  <files>packages/core-types/src/coaching-staff.ts</files>
  <files>packages/core-types/src/nil-entry.ts</files>
  <files>packages/core-types/src/future-game.ts</files>
  <files>packages/core-types/src/player-link.ts</files>
  <files>packages/core-types/src/ai-cache.ts</files>
  <files>packages/core-types/src/player.ts</files>
  <files>packages/core-types/src/index.ts</files>
  <action>
Create all 5 new type files. Define complete type shapes (not stubs) since the Dexie schema indexes commit to these field names.

`packages/core-types/src/coaching-staff.ts`:
```typescript
export type CoachingRole = 'head-coach' | 'offensive-coordinator' | 'defensive-coordinator' | 'special-teams' | 'position-coach' | 'other';

export interface CoachingStaff {
  id: string;
  dynastyId: string;
  name: string;
  role: CoachingRole;
  hireYear: number;
  fireYear?: number;
  schemeNotes?: string;
  createdAt: number;
  updatedAt: number;
}
```

`packages/core-types/src/nil-entry.ts`:
```typescript
export interface NilEntry {
  id: string;
  dynastyId: string;
  playerId: string;
  playerName: string;
  year: number;
  brand: string;
  amount: number;
  durationMonths?: number;
  notes?: string;
  createdAt: number;
  updatedAt: number;
}
```

`packages/core-types/src/future-game.ts`:
```typescript
export interface FutureGame {
  id: string;
  dynastyId: string;
  year: number;
  week?: number;
  opponent: string;
  isHome?: boolean;
  gameType?: string;
  notes?: string;
  createdAt: number;
  updatedAt: number;
}
```

`packages/core-types/src/player-link.ts`:
```typescript
export interface PlayerLink {
  id: string;
  dynastyId: string;
  playerId: string;
  linkedDynastyId: string;
  linkedPlayerId: string;
  linkType: 'cfb-to-nfl' | 'nfl-to-cfb' | 'cross-dynasty';
  notes?: string;
  createdAt: number;
  updatedAt: number;
}
```

`packages/core-types/src/ai-cache.ts`:
```typescript
export type AiContentType = 'legacy-blurb' | 'season-narrative' | 'recruiting-grade' | 'journalist-blurb' | 'hot-seat' | 'dossier' | 'rival-prophecy' | 'obituary' | 'generational-arc' | 'what-if' | 'dna-report' | 'living-chronicle';

export interface AiCacheEntry {
  id: string;
  dynastyId: string;
  cacheKey: string;
  contentType: AiContentType;
  content: string;
  createdAt: number;
  updatedAt: number;
}
```

In `packages/core-types/src/player.ts`, add `birthYear?: number;` as an optional field to the `Player` interface. Place it after `departureReason?: string;` (no schema migration needed — birthYear is unindexed, stored as plain object field).

In `packages/core-types/src/index.ts`, add 5 new export lines:
```typescript
export * from './coaching-staff';
export * from './nil-entry';
export * from './future-game';
export * from './player-link';
export * from './ai-cache';
```
  </action>
  <verify>
    <automated>cd /Users/chanmoore/dev/dynasty-os && pnpm --filter @dynasty-os/core-types build 2>&1 | tail -5</automated>
    <manual>Confirm all 5 new type files exist; Player interface has birthYear?; index.ts exports all 5</manual>
  </verify>
  <done>@dynasty-os/core-types builds cleanly; all 5 new types are exported; Player.birthYear is optional; AiContentType union includes all Phase 13 content types</done>
</task>

</tasks>

<verification>
After both tasks complete:
1. `pnpm --filter @dynasty-os/db build` passes with no TypeScript errors
2. `pnpm --filter @dynasty-os/core-types build` passes with no TypeScript errors
3. `packages/db/src/schema.ts` has `SCHEMA_V6` const with exactly 18 tables (13 existing + 5 new)
4. `packages/db/src/dynasty-db.ts` has `this.version(6).stores(SCHEMA_V6)` AND the versionchange handler
5. `packages/db/src/dynasty-db.ts` still has all 3 prior version() calls unchanged
6. `Player` interface in player.ts has `birthYear?: number`
</verification>

<success_criteria>
- DB builds cleanly with Dexie version(6) declared
- Core types package builds cleanly with 5 new type files
- No existing code is broken — SCHEMA and prior version() calls are preserved exactly
- INFRA-GATE-1: Dexie v6 migration runs clean on existing databases with all 5 new tables present
</success_criteria>

<output>
After completion, create `.planning/phases/10-infrastructure-foundation/10-01-SUMMARY.md` following the summary template.
</output>
