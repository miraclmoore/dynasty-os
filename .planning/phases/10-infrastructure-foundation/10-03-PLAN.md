---
phase: 10-infrastructure-foundation
plan: 03
type: execute
wave: 2
depends_on:
  - 10-01
files_modified:
  - apps/desktop/src/lib/ai-cache-service.ts
  - apps/desktop/src/lib/narrative-service.ts
  - apps/desktop/src/lib/legacy-card-service.ts
autonomous: true
requirements:
  - INFRA-GATE-2

must_haves:
  truths:
    - "AI content (narrative, legacy blurbs) is read from and written to the Dexie aiCache table — not localStorage"
    - "No AI content is written to localStorage after this plan executes"
    - "API keys remain in localStorage — only AI-generated content migrates"
    - "The aiCache service enforces LRU eviction at 100 entries per dynasty"
  artifacts:
    - path: "apps/desktop/src/lib/ai-cache-service.ts"
      provides: "getAiCache(), setAiCache(), deleteAiCache() functions wrapping Dexie aiCache table with LRU eviction"
      exports: ["getAiCache", "setAiCache", "deleteAiCache", "AiContentType"]
      min_lines: 50
    - path: "apps/desktop/src/lib/narrative-service.ts"
      provides: "Season narrative caching via aiCache (replaces localStorage dynasty-os-narrative-{seasonId} keys)"
    - path: "apps/desktop/src/lib/legacy-card-service.ts"
      provides: "Legacy blurb caching via aiCache (replaces localStorage legacy-blurb-{playerId} keys)"
  key_links:
    - from: "apps/desktop/src/lib/narrative-service.ts"
      to: "apps/desktop/src/lib/ai-cache-service.ts"
      via: "import { getAiCache, setAiCache } from './ai-cache-service'"
      pattern: "getAiCache|setAiCache"
    - from: "apps/desktop/src/lib/legacy-card-service.ts"
      to: "apps/desktop/src/lib/ai-cache-service.ts"
      via: "import { getAiCache, setAiCache } from './ai-cache-service'"
      pattern: "getAiCache|setAiCache"
    - from: "apps/desktop/src/lib/ai-cache-service.ts"
      to: "packages/db/src/dynasty-db.ts"
      via: "import { db } from '@dynasty-os/db'"
      pattern: "db\\.aiCache"
---

<objective>
Create the aiCache service layer and migrate the two existing localStorage AI caching paths (season narratives, legacy blurbs) to use the new Dexie aiCache table.

Purpose: Phase 10 success criterion 2 requires no AI content written to localStorage after this phase. The aiCache Dexie table (created in Plan 01) must replace both existing localStorage usages. Future Phase 13 AI features will write directly to aiCache from day one.
Output: ai-cache-service.ts (new), narrative-service.ts (updated), legacy-card-service.ts (updated).
</objective>

<execution_context>
@/Users/chanmoore/.claude/get-shit-done/workflows/execute-plan.md
@/Users/chanmoore/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/phases/10-infrastructure-foundation/10-01-SUMMARY.md
@apps/desktop/src/lib/narrative-service.ts
@apps/desktop/src/lib/legacy-card-service.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ai-cache-service.ts with LRU eviction</name>
  <files>apps/desktop/src/lib/ai-cache-service.ts</files>
  <action>
Create `apps/desktop/src/lib/ai-cache-service.ts` — a new service module wrapping the Dexie `aiCache` table.

The service must provide:
1. `getAiCache(dynastyId: string, cacheKey: string): Promise<string | null>` — looks up by dynastyId + cacheKey, returns content string or null
2. `setAiCache(dynastyId: string, cacheKey: string, contentType: AiContentType, content: string): Promise<void>` — upserts the entry (update if cacheKey exists, insert if new), then runs LRU eviction
3. `deleteAiCache(dynastyId: string, cacheKey: string): Promise<void>` — deletes a single cache entry by cacheKey
4. LRU eviction: after each insert (NOT update), fetch all entries for dynastyId sorted by createdAt ascending, if count > 100 delete the oldest (count - 100) entries using bulkDelete

Import `db` from `@dynasty-os/db`. Import `AiContentType` from `@dynasty-os/core-types`.
Import a uuid function — look at how existing services import it: `import { v4 as uuidv4 } from 'uuid'` or check the existing pattern in `apps/desktop/src/lib/uuid.ts`.

For the upsert in `setAiCache`: query `db.aiCache.where('cacheKey').equals(cacheKey).first()`. If found, call `db.aiCache.update(existing.id, { content, updatedAt: Date.now() })`. If not found, call `db.aiCache.add({ id: uuidv4(), dynastyId, cacheKey, contentType, content, createdAt: Date.now(), updatedAt: Date.now() })`.

For LRU eviction (only on insert path):
```typescript
const all = await db.aiCache.where('dynastyId').equals(dynastyId).sortBy('createdAt');
if (all.length > 100) {
  const toDelete = all.slice(0, all.length - 100).map((e) => e.id);
  await db.aiCache.bulkDelete(toDelete);
}
```

The `AiContentType` type is already defined in `packages/core-types/src/ai-cache.ts` (created in Plan 01). Re-export it for convenience: `export type { AiContentType } from '@dynasty-os/core-types';`
  </action>
  <verify>
    <automated>cd /Users/chanmoore/dev/dynasty-os && pnpm --filter @dynasty-os/desktop build 2>&1 | grep -E "error|Error" | head -10</automated>
    <manual>Confirm ai-cache-service.ts exports getAiCache, setAiCache, deleteAiCache; no direct db.aiCache usage outside this file</manual>
  </verify>
  <done>ai-cache-service.ts created with all 3 exported functions; desktop build passes with no TypeScript errors</done>
</task>

<task type="auto">
  <name>Task 2: Migrate narrative-service.ts and legacy-card-service.ts from localStorage to aiCache</name>
  <files>apps/desktop/src/lib/narrative-service.ts</files>
  <files>apps/desktop/src/lib/legacy-card-service.ts</files>
  <action>
Read the current implementations of both files first, then make targeted replacements.

**In `narrative-service.ts`:**
Find all `localStorage.getItem('dynasty-os-narrative-{seasonId}')` and `localStorage.setItem('dynasty-os-narrative-{seasonId}', ...)` patterns.

The cacheKey format to preserve: `dynasty-os-narrative-${seasonId}` — use the same key string, just store it in aiCache instead.

Replace:
- `localStorage.getItem(cacheKey)` → `await getAiCache(dynastyId, cacheKey)` (function becomes async if not already)
- `localStorage.setItem(cacheKey, content)` → `await setAiCache(dynastyId, cacheKey, 'season-narrative', content)`
- `localStorage.removeItem(cacheKey)` → `await deleteAiCache(dynastyId, cacheKey)` (if any)

Add import: `import { getAiCache, setAiCache, deleteAiCache } from './ai-cache-service';`
Remove the `localStorage.*('dynasty-os-narrative-...')` calls entirely — do NOT keep them as fallback.

The `dynastyId` must be available in the narrative functions. Examine the existing function signatures to see how to thread it through. If functions don't currently receive dynastyId, add it as a required parameter. The narrative-store.ts calls these functions and has access to `activeDynasty.id`.

**In `legacy-card-service.ts`:**
Find all `localStorage.getItem('legacy-blurb-{playerId}')` and `localStorage.setItem('legacy-blurb-{playerId}', ...)` patterns.

The cacheKey format: `legacy-blurb-${playerId}`.

Apply the same replacement pattern. The API key (`localStorage.getItem('anthropic-api-key')`) is a credential — leave it in localStorage. Only the blurb content itself migrates.

Add import: `import { getAiCache, setAiCache } from './ai-cache-service';`

NOTE: Old localStorage entries (`dynasty-os-narrative-*` and `legacy-blurb-*`) will orphan silently — do NOT write migration code to copy them. Users regenerate AI content on next request (it is AI-generated, not user data). This is the documented decision from RESEARCH.md.
  </action>
  <verify>
    <automated>cd /Users/chanmoore/dev/dynasty-os && grep -r "localStorage.*narrative\|localStorage.*legacy-blurb" apps/desktop/src/lib/ 2>/dev/null && echo "FAIL: localStorage still used" || echo "PASS: No localStorage AI content writes found"</automated>
    <automated>cd /Users/chanmoore/dev/dynasty-os && pnpm --filter @dynasty-os/desktop build 2>&1 | grep -E "error TS|Error" | head -10</automated>
    <manual>Confirm narrative-service.ts and legacy-card-service.ts have no localStorage.setItem/getItem for AI content keys; ai-cache-service functions are imported and used instead</manual>
  </verify>
  <done>Neither narrative-service.ts nor legacy-card-service.ts write AI content to localStorage; both import and use ai-cache-service functions; desktop build passes with no TypeScript errors</done>
</task>

</tasks>

<verification>
After both tasks complete:
1. `grep -r "localStorage.*narrative\|localStorage.*legacy-blurb" apps/desktop/src/lib/` returns no matches
2. `grep -r "getAiCache\|setAiCache" apps/desktop/src/lib/narrative-service.ts apps/desktop/src/lib/legacy-card-service.ts` returns matches
3. `pnpm --filter @dynasty-os/desktop build` exits 0
4. `apps/desktop/src/lib/ai-cache-service.ts` exists and is non-empty
</verification>

<success_criteria>
- ai-cache-service.ts created with getAiCache/setAiCache/deleteAiCache + LRU eviction at 100 entries per dynasty
- narrative-service.ts reads/writes season narrative via aiCache (cacheKey: dynasty-os-narrative-{seasonId})
- legacy-card-service.ts reads/writes legacy blurbs via aiCache (cacheKey: legacy-blurb-{playerId})
- API key remains in localStorage — only AI-generated content migrated
- Desktop build passes
- INFRA-GATE-2: aiCache Dexie table replaces localStorage for all AI content caching — no AI content written to localStorage after this phase
</success_criteria>

<output>
After completion, create `.planning/phases/10-infrastructure-foundation/10-03-SUMMARY.md` following the summary template.
</output>
