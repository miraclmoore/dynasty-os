---
phase: 03-player-tracking-and-records
plan: "03"
type: execute
wave: 3
depends_on: ["03-02"]
files_modified:
  - apps/desktop/src/lib/legacy-card-service.ts
  - apps/desktop/src/components/LegacyCard.tsx
  - apps/desktop/src/components/LegacyCardExport.tsx
  - apps/desktop/src/pages/LegendsPage.tsx
  - apps/desktop/src/pages/PlayerProfilePage.tsx
  - apps/desktop/src/App.tsx
  - apps/desktop/package.json
autonomous: true

must_haves:
  truths:
    - "When a player departs, a Legacy Card auto-generates with career stats and awards"
    - "If an Anthropic API key is configured, the Legacy Card includes an AI-written Hall of Fame blurb"
    - "If no API key is set or the call fails, the Legacy Card still generates without the blurb (graceful degradation)"
    - "User can export any Legacy Card as a PNG image saved to disk via Tauri file dialog"
    - "User can browse all Legacy Cards in a Program Legends gallery"
    - "User can filter the Legends gallery by position, era (decade), or award"
  artifacts:
    - path: "apps/desktop/src/lib/legacy-card-service.ts"
      provides: "Legacy card generation and Claude API blurb"
      exports: ["generateLegacyBlurb", "buildLegacyCardData"]
    - path: "apps/desktop/src/components/LegacyCard.tsx"
      provides: "Visual Legacy Card component"
      min_lines: 80
    - path: "apps/desktop/src/components/LegacyCardExport.tsx"
      provides: "PNG export wrapper using html-to-image + Tauri file save"
      min_lines: 30
    - path: "apps/desktop/src/pages/LegendsPage.tsx"
      provides: "Program Legends gallery with filters"
      min_lines: 80
  key_links:
    - from: "apps/desktop/src/pages/PlayerProfilePage.tsx"
      to: "apps/desktop/src/lib/legacy-card-service.ts"
      via: "auto-generate on departure"
      pattern: "generateLegacyBlurb|buildLegacyCardData"
    - from: "apps/desktop/src/components/LegacyCardExport.tsx"
      to: "@tauri-apps/plugin-dialog"
      via: "save() for file path"
      pattern: "import.*plugin-dialog"
    - from: "apps/desktop/src/components/LegacyCardExport.tsx"
      to: "@tauri-apps/plugin-fs"
      via: "writeFile() for binary PNG"
      pattern: "import.*plugin-fs"
---

<objective>
Build Legacy Cards: auto-generated at player departure with career stats, awards, an optional AI Hall of Fame blurb via Claude API, PNG export using Tauri-safe file saving, and a Program Legends gallery with filters.

Purpose: Legacy Cards are the emotional payoff of player tracking — they transform raw stats into a shareable artifact that commemorates a player's career. The Legends gallery lets users browse all their program greats.

Output: Working Legacy Card generation, Claude AI blurb (optional), PNG export, and filterable Legends gallery page.
</objective>

<execution_context>
@/Users/chanmoore/.claude/get-shit-done/workflows/execute-plan.md
@/Users/chanmoore/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-player-tracking-and-records/03-01-SUMMARY.md
@.planning/phases/03-player-tracking-and-records/03-02-SUMMARY.md

Source files:
@packages/core-types/src/player.ts
@apps/desktop/src/lib/export-import.ts
@apps/desktop/src/lib/career-stats.ts
@apps/desktop/src-tauri/Cargo.toml
@apps/desktop/src-tauri/tauri.conf.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Legacy card service with Claude API blurb generation</name>
  <files>
    apps/desktop/src/lib/legacy-card-service.ts
  </files>
  <action>
    **legacy-card-service.ts** — Service for building Legacy Card data and generating AI blurbs:

    Define a LegacyCardData interface:
    ```typescript
    export interface LegacyCardData {
      player: Player;
      careerStats: Record<string, number>;
      careerAwards: string[];
      seasonCount: number;
      blurb?: string;  // AI-generated, may be absent
    }
    ```

    **buildLegacyCardData(player: Player, seasons: PlayerSeason[]): LegacyCardData** — Pure function:
    - Uses computeCareerStats, computeCareerAwards, computeSeasonCount from career-stats.ts
    - Returns the assembled card data (no blurb yet)

    **generateLegacyBlurb(cardData: LegacyCardData, teamName: string): Promise<string | null>** — Claude API call:
    - Read API key from localStorage key 'dynasty-os-anthropic-api-key' (simple storage — no Tauri secure store needed for V1)
    - If no API key: return null immediately (graceful skip)
    - Make a fetch POST to `https://api.anthropic.com/v1/messages` with:
      - Header: `x-api-key: {key}`, `anthropic-version: 2023-06-01`, `content-type: application/json`
      - Model: `claude-haiku-4-5-20251001` (cheapest, fastest — a blurb doesn't need Sonnet)
      - max_tokens: 200
      - Prompt: System message: "You are a college football Hall of Fame ceremony announcer. Write a 2-3 sentence Hall of Fame induction blurb for a departing player. Be specific about their stats. Be dramatic but not corny. No emojis."
      - User message: Build from cardData — include player name, position, team name, seasons played, key career stats (top 3-5 non-zero stats), awards, departure type. Example: "{firstName} {lastName}, {position}, played {seasonCount} seasons for the {teamName}. Career stats: {formatted stats}. Awards: {awards}. Departed via {status}."
    - Wrap in try/catch: on ANY error (network, auth, rate limit), log to console.warn and return null
    - Never throw — the blurb is optional enhancement, not critical path

    **getApiKey(): string | null** — Read from localStorage
    **setApiKey(key: string): void** — Write to localStorage
    **clearApiKey(): void** — Remove from localStorage

    Export: buildLegacyCardData, generateLegacyBlurb, getApiKey, setApiKey, clearApiKey, LegacyCardData type
  </action>
  <verify>
    Run `pnpm run build` from root. TypeScript compiles cleanly. Verify legacy-card-service.ts exports all 6 items. Verify that generateLegacyBlurb returns null when no API key is set (no crash, no thrown error).
  </verify>
  <done>
    Legacy card data builder assembles career stats from PlayerSeason data. Claude API blurb generator calls Haiku with a Hall of Fame prompt. Missing API key or failed API call gracefully returns null. API key stored in localStorage.
  </done>
</task>

<task type="auto">
  <name>Task 2: Legacy Card component, PNG export, Legends gallery, and departure trigger wiring</name>
  <files>
    apps/desktop/src/components/LegacyCard.tsx
    apps/desktop/src/components/LegacyCardExport.tsx
    apps/desktop/src/pages/LegendsPage.tsx
    apps/desktop/src/pages/PlayerProfilePage.tsx
    apps/desktop/src/App.tsx
    apps/desktop/package.json
  </files>
  <action>
    **Install html-to-image:** Run `pnpm add html-to-image` in apps/desktop. This library converts DOM nodes to image buffers without blob URLs.

    **LegacyCard.tsx** — Visual card component (renders in the DOM, also used as PNG source):
    - Props: `cardData: LegacyCardData`, `teamName: string`
    - Design: A styled card (fixed width ~400px, auto height) with:
      - Header: player name large, position + jersey number
      - Subtitle: "{seasonCount} Seasons | Class of {departureYear}"
      - Career stats grid: 2-3 columns, show top 6-8 non-zero stats with labels (use sport config statCategories to get labels from keys)
      - Awards row: badges/chips for each career award
      - AI blurb section: italic text if blurb exists, otherwise omit this section entirely
      - Footer: "Dynasty OS | {teamName} Program Legends"
    - Styling: premium look — dark gradient background (gray-900 to gray-800), gold/amber accent color for stats, clean typography
    - Give the card's root div a ref prop for PNG capture
    - The component should accept a React ref via forwardRef so the export wrapper can grab the DOM node

    **LegacyCardExport.tsx** — PNG export button component:
    - Props: `cardRef: React.RefObject<HTMLDivElement>`
    - On click:
      1. Use `toPng(cardRef.current)` from html-to-image to get a data URL
      2. Convert data URL to Uint8Array: strip the `data:image/png;base64,` prefix, decode with atob(), convert to byte array
      3. Use `save()` from @tauri-apps/plugin-dialog to get file path (default filename: `{lastName}-legacy-card.png`, filter: PNG)
      4. If user picked a path, use `writeFile()` from @tauri-apps/plugin-fs to write the Uint8Array
    - IMPORTANT: Do NOT use blob URLs or anchor.click() — these don't work in Tauri WebView. The dialog + fs approach is the only supported method (per project decisions).
    - Show loading state while generating PNG
    - Handle errors gracefully (toast or inline error message)

    **PlayerProfilePage.tsx** — Wire Legacy Card auto-generation on departure:
    - After the departure form submits and player status changes:
      1. Build card data via buildLegacyCardData(player, playerSeasons)
      2. Call generateLegacyBlurb(cardData, dynasty.teamName) — await but don't block on failure
      3. Store the blurb on the player's notes field or in a new localStorage key `legacy-blurb-{playerId}` (since Player type has no blurb field, use localStorage for V1)
    - For departed players, show the LegacyCard component below the departure info section
    - Show "Export as PNG" button (LegacyCardExport) next to the card
    - Show "Regenerate Blurb" button that re-calls generateLegacyBlurb and updates storage
    - Add a small "API Key" settings section (or a gear icon) at the bottom of the profile page: text input for Anthropic API key, save/clear buttons using setApiKey/clearApiKey from legacy-card-service. Show masked key if set.

    **LegendsPage.tsx** — Program Legends gallery:
    - Load all players for dynasty via usePlayerStore
    - Filter to departed players only (status !== 'active')
    - For each departed player, load their playerSeasons and build LegacyCardData
    - Display as a grid of LegacyCard components (2 columns on lg, 1 on mobile)
    - Filter controls at top:
      - Position filter: dropdown of all positions from sport config + "All"
      - Era filter: dropdown of decades derived from player departure years (e.g., "2020s", "2030s") + "All"
      - Award filter: dropdown of all unique awards across all departed players + "All"
    - Empty state: "No legends yet. Players who depart your program will appear here with their Legacy Cards."
    - "Back to Dashboard" navigation link
    - Each card in the gallery is clickable — navigates to the player's profile page
    - Styling consistent with other pages: bg-gray-900, bg-gray-800 cards

    **App.tsx** — Replace the LegendsPage placeholder with the real component:
    - Import LegendsPage and wire it to the 'legends' case in the page switch
    - Add a way to navigate to Legends from the dashboard (add "Program Legends" button in the Actions panel of DashboardPage, similar to "Manage Roster")

    Also update DashboardPage.tsx to add a "Program Legends" button in the Actions panel that calls useNavigationStore.getState().goToLegends().
  </action>
  <verify>
    Run `pnpm run build` from root. Zero TypeScript errors. Verify via dev server:
    1. Navigate to a player profile, record departure
    2. Legacy Card appears on the profile after departure
    3. If API key is configured, blurb appears on the card (test with a valid key)
    4. If no API key, card generates without blurb (no error)
    5. "Export as PNG" opens Tauri save dialog and writes a valid PNG file
    6. Navigate to Program Legends from dashboard
    7. Legends gallery shows all departed players as Legacy Cards
    8. Position, era, and award filters narrow the gallery correctly
    9. Clicking a card in the gallery navigates to that player's profile
    10. Empty gallery shows helpful message when no players have departed
  </verify>
  <done>
    Legacy Cards auto-generate at player departure with career stats and awards. AI blurb generates via Claude Haiku when API key is present, degrades gracefully when absent. PNG export uses Tauri dialog + fs (not blob URLs). Legends gallery shows all departed player cards with position/era/award filters.
  </done>
</task>

</tasks>

<verification>
- `pnpm run build` passes from repo root
- Legacy Card renders correctly for departed players
- PNG export produces a valid image file via Tauri save dialog
- Claude API call uses Haiku model with proper headers
- Missing API key or API failure results in card without blurb (no crash)
- Legends gallery filters work correctly
- API key settings UI allows set/clear/view (masked)
- html-to-image dependency added to package.json
</verification>

<success_criteria>
1. Departing a player auto-generates a Legacy Card with career stats and awards
2. AI blurb generates when API key is configured, skips gracefully when not
3. PNG export works through Tauri file dialog (not blob URLs)
4. Legends gallery shows all departed players filterable by position, era, and award
5. API key management UI exists on the player profile page
6. Zero TypeScript errors on build
</success_criteria>

<output>
After completion, create `.planning/phases/03-player-tracking-and-records/03-03-SUMMARY.md`
</output>
