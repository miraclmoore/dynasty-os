---
phase: 03-player-tracking-and-records
plan: "02"
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - apps/desktop/src/lib/player-season-service.ts
  - apps/desktop/src/lib/career-stats.ts
  - apps/desktop/src/store/player-season-store.ts
  - apps/desktop/src/store/index.ts
  - apps/desktop/src/components/LogPlayerSeasonModal.tsx
  - apps/desktop/src/pages/PlayerProfilePage.tsx
  - apps/desktop/src/pages/RosterPage.tsx
  - apps/desktop/src/App.tsx
autonomous: true

must_haves:
  truths:
    - "User can log per-season stats for a player across all stat categories (passing, rushing, receiving, defense, special teams)"
    - "User can view a player's career stat totals auto-calculated from all their logged seasons"
    - "User can view a player profile page showing bio info, all season stat entries, and career totals"
    - "User can record a player departure (graduation, transfer, NFL Draft, injury) and see status change reflected"
    - "User can navigate from the roster to a player's profile and back"
  artifacts:
    - path: "apps/desktop/src/lib/player-season-service.ts"
      provides: "PlayerSeason CRUD service"
      exports: ["createPlayerSeason", "getPlayerSeasonsByPlayer", "getPlayerSeasonsByDynasty", "updatePlayerSeason", "deletePlayerSeason"]
    - path: "apps/desktop/src/lib/career-stats.ts"
      provides: "Career stat aggregation logic"
      exports: ["computeCareerStats", "computeCareerAwards"]
    - path: "apps/desktop/src/store/player-season-store.ts"
      provides: "Zustand store for player season data"
      exports: ["usePlayerSeasonStore"]
    - path: "apps/desktop/src/pages/PlayerProfilePage.tsx"
      provides: "Full player profile with career arc"
      min_lines: 100
    - path: "apps/desktop/src/components/LogPlayerSeasonModal.tsx"
      provides: "Modal for logging season stats"
      min_lines: 80
  key_links:
    - from: "apps/desktop/src/pages/PlayerProfilePage.tsx"
      to: "apps/desktop/src/lib/career-stats.ts"
      via: "computeCareerStats call"
      pattern: "computeCareerStats"
    - from: "apps/desktop/src/pages/PlayerProfilePage.tsx"
      to: "apps/desktop/src/store/player-season-store.ts"
      via: "usePlayerSeasonStore hook"
      pattern: "usePlayerSeasonStore"
    - from: "apps/desktop/src/pages/RosterPage.tsx"
      to: "apps/desktop/src/store/navigation-store.ts"
      via: "goToPlayerProfile on row click"
      pattern: "goToPlayerProfile"
---

<objective>
Build season stat logging, career totals engine, player departure recording, and the Player Profile page that shows a player's complete career arc.

Purpose: This turns the roster from a static list into a living record. Each player accumulates stats season by season, and career totals auto-calculate — the raw data that feeds Legacy Cards and leaderboards.

Output: Users can log season stats, view auto-calculated career totals on a player profile, and record when a player departs.
</objective>

<execution_context>
@/Users/chanmoore/.claude/get-shit-done/workflows/execute-plan.md
@/Users/chanmoore/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-player-tracking-and-records/03-01-SUMMARY.md

Source files:
@packages/core-types/src/player.ts
@packages/core-types/src/sport-config.ts
@packages/sport-configs/src/cfb.ts
@apps/desktop/src/lib/game-service.ts
@apps/desktop/src/store/game-store.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: PlayerSeason service, career stats engine, and player-season store</name>
  <files>
    apps/desktop/src/lib/player-season-service.ts
    apps/desktop/src/lib/career-stats.ts
    apps/desktop/src/store/player-season-store.ts
    apps/desktop/src/store/index.ts
  </files>
  <action>
    **player-season-service.ts** — Follow the game-service.ts pattern:
    - `createPlayerSeason(input: Omit<PlayerSeason, 'id' | 'createdAt' | 'updatedAt'>): Promise<PlayerSeason>` — generateId(), Date.now() timestamps, db.playerSeasons.add()
    - `getPlayerSeasonsByPlayer(playerId: string): Promise<PlayerSeason[]>` — query db.playerSeasons.where('playerId').equals(playerId), sort by year ascending
    - `getPlayerSeasonsByDynasty(dynastyId: string): Promise<PlayerSeason[]>` — query db.playerSeasons.where('dynastyId').equals(dynastyId).toArray()
    - `getPlayerSeasonsBySeason(seasonId: string): Promise<PlayerSeason[]>` — query db.playerSeasons.where('seasonId').equals(seasonId).toArray()
    - `updatePlayerSeason(id: string, updates: Partial<Omit<PlayerSeason, 'id' | 'playerId' | 'dynastyId' | 'createdAt'>>): Promise<void>` — db.playerSeasons.update()
    - `deletePlayerSeason(id: string): Promise<void>` — db.playerSeasons.delete()

    **career-stats.ts** — Pure computation functions (no DB access):
    - `computeCareerStats(seasons: PlayerSeason[]): Record<string, number>` — Iterate over all seasons, sum every stat key across all seasons. For each key that appears in any season's stats, accumulate the total. Return a single Record<string, number> with all accumulated stat keys. Handle the case where a stat key only appears in some seasons (treat missing as 0). For 'passerRating' and 'puntAverage' and 'sacks' (decimal type stats from sport config), compute a weighted average by gamesPlayed instead of raw sum — if no gamesPlayed data, fall back to simple average across seasons that have the stat.
    - `computeCareerAwards(seasons: PlayerSeason[]): string[]` — Flatten all awards arrays from all seasons, deduplicate, return sorted array.
    - `computeSeasonCount(seasons: PlayerSeason[]): number` — Return number of distinct years.

    **player-season-store.ts** — Zustand store:
    - State: `playerSeasons: PlayerSeason[]`, `loading: boolean`, `error: string | null`
    - Actions: `loadPlayerSeasons(playerId: string)` — calls getPlayerSeasonsByPlayer, `addPlayerSeason(input)`, `updatePlayerSeason(id, updates)`, `deletePlayerSeason(id)`, `clearError()`
    - Reload-after-mutation pattern: every mutation reloads via loadPlayerSeasons

    **store/index.ts** — Add usePlayerSeasonStore export.
  </action>
  <verify>
    Run `pnpm run build` from root. Zero TypeScript errors. Verify player-season-service.ts exports 6 functions, career-stats.ts exports 3 functions, player-season-store.ts exports usePlayerSeasonStore.
  </verify>
  <done>
    PlayerSeason CRUD service follows established patterns. Career stats engine correctly sums integer stats, averages decimal stats (weighted by gamesPlayed when available), and deduplicates awards. Store follows reload-after-mutation pattern.
  </done>
</task>

<task type="auto">
  <name>Task 2: Log Player Season modal, Player Profile page, and departure recording</name>
  <files>
    apps/desktop/src/components/LogPlayerSeasonModal.tsx
    apps/desktop/src/pages/PlayerProfilePage.tsx
    apps/desktop/src/pages/RosterPage.tsx
    apps/desktop/src/App.tsx
  </files>
  <action>
    **LogPlayerSeasonModal.tsx** — Modal for logging a player's season stats:
    - Props: `isOpen`, `onClose`, `player: Player`, `dynastyId: string`
    - Season selector: dropdown of seasons from useSeasonStore (user picks which season to log stats for). Pre-select the activeSeason.
    - Stat entry: render stat fields grouped by category (Passing, Rushing, Receiving, Defense, Special Teams, General) using the sport config's statCategories from `getSportConfig(dynasty.sport)`. Each stat renders as a labeled number input. Group headers separate the categories visually.
    - Awards field: comma-separated text input (e.g., "All-American, Heisman Finalist"). Split on comma, trim whitespace, store as string array.
    - Overall rating: optional number input (0-99)
    - Notes: optional textarea
    - On submit: call usePlayerSeasonStore.getState().addPlayerSeason({ playerId: player.id, dynastyId, seasonId, year: selectedSeason.year, stats: { ...statValues }, awards: parsedAwards, overallRating, notes })
    - Only include stat keys in the stats object where the user entered a non-zero value (don't store zeros — keep the Record sparse)
    - Same modal styling as LogGameModal

    **PlayerProfilePage.tsx** — Full player profile:
    - Read playerId from useNavigationStore pageParams.playerId
    - Load player via usePlayerStore, load playerSeasons via usePlayerSeasonStore.loadPlayerSeasons(playerId)
    - Header section: player name, position, jersey number, class year, recruiting stars (visual stars), home location, status badge (green for active, gray for departed statuses)
    - Bio section: height, weight, notes
    - Career totals section: use computeCareerStats() and computeCareerAwards() from career-stats.ts. Display career stats in a grid grouped by stat category. Only show stat categories that have non-zero values. Show career awards as badges/chips.
    - Season-by-season table: one row per PlayerSeason, columns for year, key stats (position-relevant: e.g., for QB show passing yards/TDs/INTs, for RB show rushing yards/TDs, etc.), awards, overall rating. Use sport config stat categories grouped by the player's position relevance.
    - "Log Season Stats" button opens LogPlayerSeasonModal for this player
    - "Edit Player" button opens EditPlayerModal (imported from Plan 01)
    - Departure section (if status === 'active'): "Record Departure" button that shows a small inline form or modal with:
      - Departure type: select from PlayerStatus values minus 'active' (graduated, transferred, drafted, injured, other)
      - Departure year: number input, default to current dynasty year
      - Departure reason: optional text (e.g., "3rd round, Dallas Cowboys")
      - On submit: call usePlayerStore.getState().updatePlayer(playerId, { status, departureYear, departureReason })
    - If player is departed, show departure info prominently (status, year, reason) instead of the departure button
    - "Back to Roster" navigation link using useNavigationStore.getState().goToRoster()
    - Styling consistent with DashboardPage: bg-gray-900 base, bg-gray-800 cards, white text

    **RosterPage.tsx** — Update to wire player row clicks to navigate to profile:
    - Clicking a player row should call useNavigationStore.getState().goToPlayerProfile(player.id) instead of (or in addition to) opening the edit modal
    - Add a small edit icon/button per row that opens EditPlayerModal (so edit is still accessible without navigating away)
    - Add a "Log Season" quick action button per active player row that opens LogPlayerSeasonModal

    **App.tsx** — Wire up the PlayerProfilePage:
    - Replace the placeholder for 'player-profile' case with the real PlayerProfilePage component import
  </action>
  <verify>
    Run `pnpm run build` from root. Zero TypeScript errors. Verify via dev server:
    1. From Roster page, click a player name to navigate to their profile
    2. Player profile shows bio info, career stats (initially empty), season history (initially empty)
    3. Click "Log Season Stats", fill in stats for a season, submit
    4. Career totals section updates with the logged stats
    5. Season-by-season table shows the new entry
    6. Log a second season — career totals correctly aggregate both seasons
    7. Click "Record Departure", select type and year, submit
    8. Player status changes to departed, departure info displays, departure button disappears
    9. On Roster page, player now appears under "Departed" filter
    10. From Roster page, "Log Season" quick action opens the stat modal correctly
  </verify>
  <done>
    Users can log per-season stats across all stat categories. Career totals auto-calculate from all logged seasons. Player profile page shows complete career arc. Departure recording changes player status and displays departure info. Navigation between Roster and Profile works bidirectionally.
  </done>
</task>

</tasks>

<verification>
- `pnpm run build` passes from repo root
- PlayerSeason CRUD works end-to-end
- Career stats correctly sum integer stats and average decimal stats
- Awards deduplicate across seasons
- Stat entry form groups match sport config statCategories
- Departure flow changes player status and prevents re-departure
- Profile page adapts stat display to player's position
</verification>

<success_criteria>
1. User can log season stats for any player using sport-config-driven stat categories
2. Career stat totals auto-calculate and display on the player profile
3. Season-by-season history table shows all logged seasons with key stats
4. User can record player departure with type, year, and reason
5. Departed players show departure info on profile and filter correctly on roster
6. Zero TypeScript errors on build
</success_criteria>

<output>
After completion, create `.planning/phases/03-player-tracking-and-records/03-02-SUMMARY.md`
</output>
