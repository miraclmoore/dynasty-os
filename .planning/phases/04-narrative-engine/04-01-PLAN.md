---
phase: 04-narrative-engine
plan: "01"
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/desktop/src/lib/narrative-service.ts
  - apps/desktop/src/store/narrative-store.ts
  - apps/desktop/src/store/index.ts
autonomous: true

must_haves:
  truths:
    - "Narrative service generates a 2-3 paragraph season recap from season + game + player data"
    - "Three distinct tone presets (ESPN National Desk, Hometown Beat Reporter, Dynasty Mode Legend) produce clearly different output"
    - "Every generated recap includes a 3-word season tagline parsed from the response"
    - "Generated narrative is cached in localStorage keyed by dynasty-os-narrative-{seasonId}"
    - "Cached narrative is never re-fetched unless explicitly requested"
    - "API key reuses getApiKey() from legacy-card-service.ts — no duplicate key management"
  artifacts:
    - path: "apps/desktop/src/lib/narrative-service.ts"
      provides: "Season narrative generation with 3 tone presets, tagline parsing, localStorage caching"
      exports: ["generateSeasonNarrative", "getCachedNarrative", "clearCachedNarrative", "NarrativeTone", "SeasonNarrative"]
    - path: "apps/desktop/src/store/narrative-store.ts"
      provides: "Zustand store for narrative state (loading, error, cached narrative)"
      exports: ["useNarrativeStore"]
    - path: "apps/desktop/src/store/index.ts"
      provides: "Re-export of useNarrativeStore"
  key_links:
    - from: "apps/desktop/src/lib/narrative-service.ts"
      to: "apps/desktop/src/lib/legacy-card-service.ts"
      via: "import { getApiKey } from legacy-card-service"
      pattern: "getApiKey\\(\\)"
    - from: "apps/desktop/src/lib/narrative-service.ts"
      to: "https://api.anthropic.com/v1/messages"
      via: "fetch POST with claude-sonnet-4-6 model"
      pattern: "claude-sonnet-4-6"
    - from: "apps/desktop/src/store/narrative-store.ts"
      to: "apps/desktop/src/lib/narrative-service.ts"
      via: "import and call generateSeasonNarrative"
      pattern: "generateSeasonNarrative"
---

<objective>
Build the narrative engine service layer — Claude API integration with three distinct tone system prompts, season data aggregation into prompt context, tagline parsing, and localStorage caching.

Purpose: This is the core AI logic that transforms raw season data (games, record, rankings, player stats) into a compelling 2-3 paragraph recap with a 3-word tagline. The tone system is the differentiator — each preset produces a fundamentally different voice, not just stylistic tweaks.

Output: narrative-service.ts (API calls, prompts, caching), narrative-store.ts (Zustand state management), updated store/index.ts barrel export.
</objective>

<execution_context>
@/Users/chanmoore/.claude/get-shit-done/workflows/execute-plan.md
@/Users/chanmoore/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@apps/desktop/src/lib/legacy-card-service.ts
@apps/desktop/src/lib/game-service.ts
@apps/desktop/src/lib/season-service.ts
@apps/desktop/src/lib/player-season-service.ts
@apps/desktop/src/lib/career-stats.ts
@apps/desktop/src/store/index.ts
@packages/core-types/src/season.ts
@packages/core-types/src/game.ts
@packages/core-types/src/dynasty.ts
@packages/core-types/src/player.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create narrative service with tone system, API integration, and localStorage caching</name>
  <files>apps/desktop/src/lib/narrative-service.ts</files>
  <action>
Create `narrative-service.ts` with the following:

**Types:**
- `NarrativeTone = 'espn' | 'hometown' | 'legend'` — the three tone presets
- `SeasonNarrative = { recap: string; tagline: string; tone: NarrativeTone; generatedAt: number }` — the cached object
- `NarrativeContext` — internal type for aggregated season data passed to the prompt

**Tone System Prompts (TONE_SYSTEM_PROMPTS: Record<NarrativeTone, string>):**

Each tone IS the system prompt. These must produce distinctly different output:

1. **ESPN National Desk (`espn`):** System prompt instructs Claude to write as a national sports anchor delivering a season summary for a prime-time broadcast. Authoritative, statistics-driven. References historical context. Treats every milestone as significant on the national stage. Uses phrases like "in a season that will be remembered" and cites specific numbers. Voice: confident, polished, network-quality.

2. **Hometown Beat Reporter (`hometown`):** System prompt instructs Claude to write as a local newspaper beat reporter who has covered this program for years. Warm, community-focused. Refers to the team as "our" or "the [team name]." Celebrates individual players by name like neighbors. Finds the human stories in the stats. Voice: familiar, proud, slightly sentimental.

3. **Dynasty Mode Legend (`legend`):** System prompt instructs Claude to write as an epic sports narrator documenting a legendary coaching dynasty. Mythic, dramatic. Treats the coach as a dynasty-builder whose decisions reshape the program. Uses metaphors about building empires, leaving legacies, and cementing greatness. Voice: sweeping, grandiose, video-game-narrator energy.

Each system prompt must also include the tagline instruction: "END your response with exactly this format on its own line: TAGLINE: [three-word tagline]. The tagline must be EXACTLY 3 words — no more, no less. It should capture the essence of the season."

**Context Aggregation (buildNarrativeContext function):**

This function takes dynastyId + seasonId and queries all the data the prompt needs:
- Dynasty info: teamName, coachName, sport, currentYear (from the dynasty object passed in)
- Season record: wins, losses, confWins, confLosses, finalRanking, bowlGame, bowlResult, playoffResult (from season object passed in)
- Game details: full game list from `getGamesBySeason(seasonId)` — opponent, scores, rankings, results, gameType, week. Summarize as a formatted game-by-game log string.
- Top player stats: from `getPlayerSeasonsBySeason(seasonId)` — get all player seasons for this season, join with player names. Pick the top 3-5 stat leaders (most passing yards, rushing yards, receiving yards, tackles, sacks, interceptions if non-zero). Format as "Player Name: stat value" strings.

Do NOT import getApiKey or any key management into this file directly for the context builder. The API call function imports `getApiKey` from `legacy-card-service.ts`.

**API Call (generateSeasonNarrative function):**

```typescript
export async function generateSeasonNarrative(
  dynasty: Dynasty,
  season: Season,
  tone: NarrativeTone,
  forceRefresh?: boolean
): Promise<SeasonNarrative | null>
```

- First check cache: `getCachedNarrative(season.id)`. If cached AND `forceRefresh` is not true, return cached.
- Get API key via `getApiKey()` from `legacy-card-service.ts`. If no key, return null.
- Call `buildNarrativeContext(dynasty, season)` to assemble the prompt context.
- Build the user message from the context — include all season data, game log, top players.
- POST to `https://api.anthropic.com/v1/messages` with:
  - model: `claude-sonnet-4-6` (NOT Haiku — narratives need quality)
  - max_tokens: 1000
  - system: `TONE_SYSTEM_PROMPTS[tone]`
  - messages: [{ role: 'user', content: userMessage }]
  - Headers: same pattern as legacy-card-service.ts (x-api-key, anthropic-version, content-type)
  - Add `anthropic-dangerous-direct-browser-access: true` header (required for browser-based API calls)
- Parse the response text. Extract tagline by finding "TAGLINE: " at the end, splitting it off. The recap is everything before the TAGLINE line.
- If tagline is not exactly 3 words, fall back to first 3 words of recap as tagline.
- Build `SeasonNarrative` object with recap, tagline, tone, generatedAt timestamp.
- Cache in localStorage: `localStorage.setItem('dynasty-os-narrative-' + season.id, JSON.stringify(narrative))`.
- Return the narrative.
- Wrap entire API call in try/catch. On failure, console.warn and return null. Never throw.

**Cache Functions:**

```typescript
export function getCachedNarrative(seasonId: string): SeasonNarrative | null
```
Read from `localStorage.getItem('dynasty-os-narrative-' + seasonId)`, parse JSON, return or null.

```typescript
export function clearCachedNarrative(seasonId: string): void
```
Remove from localStorage.

**Important constraints:**
- Import `getApiKey` from `./legacy-card-service` — do NOT create new API key management.
- Import `getGamesBySeason` from `./game-service`.
- Import `getPlayerSeasonsBySeason` from `./player-season-service`.
- Import Player type and use `db.players.get(playerId)` for player name lookup (import db from @dynasty-os/db).
- Use `claude-sonnet-4-6` model, not Haiku.
- The tagline is parsed from the same API response — never a separate API call.
- Cache key format: `dynasty-os-narrative-{seasonId}`.
  </action>
  <verify>
Run `npx tsc --noEmit` from apps/desktop to confirm no type errors. Verify the file exports generateSeasonNarrative, getCachedNarrative, clearCachedNarrative, NarrativeTone type, and SeasonNarrative type.
  </verify>
  <done>
narrative-service.ts exists with: 3 distinct tone system prompts, buildNarrativeContext aggregation, generateSeasonNarrative with Sonnet API call and tagline parsing, getCachedNarrative/clearCachedNarrative cache functions. getApiKey is imported from legacy-card-service.ts (no duplication). Cache key is dynasty-os-narrative-{seasonId}. TypeScript compiles cleanly.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create narrative Zustand store and add barrel export</name>
  <files>apps/desktop/src/store/narrative-store.ts, apps/desktop/src/store/index.ts</files>
  <action>
Create `narrative-store.ts` following the established Zustand store pattern (see dynasty-store, season-store, game-store for pattern reference):

```typescript
import { create } from 'zustand';
import type { SeasonNarrative, NarrativeTone } from '../lib/narrative-service';
import { generateSeasonNarrative, getCachedNarrative } from '../lib/narrative-service';
import type { Dynasty, Season } from '@dynasty-os/core-types';

interface NarrativeState {
  narrative: SeasonNarrative | null;
  loading: boolean;
  error: string | null;
}

interface NarrativeActions {
  loadCachedNarrative: (seasonId: string) => void;
  generate: (dynasty: Dynasty, season: Season, tone: NarrativeTone, forceRefresh?: boolean) => Promise<void>;
  clear: () => void;
}

type NarrativeStore = NarrativeState & NarrativeActions;
```

**Actions:**
- `loadCachedNarrative(seasonId)`: Synchronously loads from localStorage via getCachedNarrative. Sets narrative state or null. No loading state needed (it's synchronous).
- `generate(dynasty, season, tone, forceRefresh?)`: Sets loading=true, error=null. Calls generateSeasonNarrative. On success: sets narrative, loading=false. On null result (no API key or API failure): sets error message, loading=false. On exception: sets error, loading=false.
- `clear()`: Resets narrative=null, loading=false, error=null.

Update `apps/desktop/src/store/index.ts` to add:
```typescript
export { useNarrativeStore } from './narrative-store';
```
  </action>
  <verify>
Run `npx tsc --noEmit` from apps/desktop. Verify useNarrativeStore is exported from store/index.ts. Verify the store has narrative, loading, error state and loadCachedNarrative, generate, clear actions.
  </verify>
  <done>
narrative-store.ts exists as Zustand store with narrative/loading/error state and loadCachedNarrative/generate/clear actions. Store is re-exported from store/index.ts. TypeScript compiles cleanly.
  </done>
</task>

</tasks>

<verification>
1. `cd apps/desktop && npx tsc --noEmit` — zero type errors
2. narrative-service.ts imports getApiKey from legacy-card-service (grep confirms: `grep "getApiKey" apps/desktop/src/lib/narrative-service.ts`)
3. Three tone system prompts exist and are distinctly different (ESPN = authoritative/stats, Hometown = warm/community, Legend = mythic/epic)
4. Model is claude-sonnet-4-6 (grep confirms: `grep "claude-sonnet-4-6" apps/desktop/src/lib/narrative-service.ts`)
5. Cache key uses dynasty-os-narrative-{seasonId} pattern
6. Tagline parsed from same response — no separate API call
7. useNarrativeStore exported from store/index.ts
</verification>

<success_criteria>
- narrative-service.ts compiles and exports all required functions/types
- Three tone presets have distinct system prompts that would produce different output
- API call uses claude-sonnet-4-6 model and reuses getApiKey() from legacy-card-service.ts
- Tagline is parsed from the response text (TAGLINE: xxx format), not a separate call
- localStorage caching works with dynasty-os-narrative-{seasonId} key
- Zustand store wraps the service with loading/error state management
- No new API key management code — legacy-card-service.ts getApiKey() is the single source
</success_criteria>

<output>
After completion, create `.planning/phases/04-narrative-engine/04-01-SUMMARY.md`
</output>
