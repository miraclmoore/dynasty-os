---
phase: 02-core-loop
plan: "04"
type: execute
wave: 4
depends_on: ["02-03"]
files_modified:
  - apps/desktop/src/components/StatHighlights.tsx
  - apps/desktop/src/components/InlineEditCell.tsx
  - apps/desktop/src/components/GameLog.tsx
  - apps/desktop/src/pages/DashboardPage.tsx
autonomous: false

must_haves:
  truths:
    - "User sees stat highlights panel on dashboard showing points per game, point differential, scoring margin"
    - "Clicking any stat value in the stat highlights panel opens it for inline editing"
    - "Inline edit saves on Enter or blur, cancels on Escape"
    - "User can see a full game log table showing all games for the current season"
    - "Clicking a score cell in the game log opens inline edit to correct the score"
    - "After inline editing a score, the season record auto-recalculates"
  artifacts:
    - path: "apps/desktop/src/components/StatHighlights.tsx"
      provides: "Calculated stat highlights from game data"
      min_lines: 40
    - path: "apps/desktop/src/components/InlineEditCell.tsx"
      provides: "Reusable inline edit component for any stat cell"
      min_lines: 30
    - path: "apps/desktop/src/components/GameLog.tsx"
      provides: "Full season game log table with inline editing"
      min_lines: 60
  key_links:
    - from: "apps/desktop/src/components/StatHighlights.tsx"
      to: "apps/desktop/src/components/InlineEditCell.tsx"
      via: "stat cells use InlineEditCell for editing"
      pattern: "InlineEditCell"
    - from: "apps/desktop/src/components/GameLog.tsx"
      to: "apps/desktop/src/store/game-store.ts"
      via: "inline edit triggers updateGame and season recalculation"
      pattern: "useGameStore.*updateGame"
    - from: "apps/desktop/src/components/GameLog.tsx"
      to: "apps/desktop/src/components/InlineEditCell.tsx"
      via: "score cells use InlineEditCell"
      pattern: "InlineEditCell"
---

<objective>
Add stat highlights, a full game log table, and inline editing capability — completing the
dashboard's data display and enabling quick corrections without opening modal forms.

Purpose: Stat highlights give the coach calculated insights (PPG, point differential). The game
log provides a complete season view. Inline editing lets users fix mistakes without friction —
click a cell, type the correction, press Enter.

Output: StatHighlights widget, GameLog table, InlineEditCell component, and DashboardPage updated
to include all three.
</objective>

<execution_context>
@/Users/chanmoore/.claude/get-shit-done/workflows/execute-plan.md
@/Users/chanmoore/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md

# Data layer
@apps/desktop/src/store/game-store.ts
@apps/desktop/src/store/season-store.ts
@apps/desktop/src/lib/game-service.ts

# Dashboard (will have been built in 02-02 and modified in 02-03)
@apps/desktop/src/pages/DashboardPage.tsx

# Types
@packages/core-types/src/game.ts
@packages/core-types/src/season.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create InlineEditCell, StatHighlights, and GameLog components</name>
  <files>
    apps/desktop/src/components/InlineEditCell.tsx
    apps/desktop/src/components/StatHighlights.tsx
    apps/desktop/src/components/GameLog.tsx
  </files>
  <action>
    Create `apps/desktop/src/components/InlineEditCell.tsx`:

    A reusable inline edit component. Displays a value as text. On click, transforms into an input.

    Props:
    - `value: string | number` — the current display value
    - `onSave: (newValue: string) => void` — called when user confirms edit
    - `type?: 'text' | 'number'` — input type, defaults to 'text'
    - `className?: string` — additional CSS classes for the display span

    Behavior:
    - Default state: render a `<span>` showing value, with `cursor-pointer hover:bg-gray-700 px-2 py-1 rounded`
      and a subtle pencil icon or underline-on-hover to hint editability.
    - On click: replace span with `<input>` auto-focused, pre-filled with current value, same width.
    - On Enter key: call onSave(inputValue), revert to span mode.
    - On Escape key: revert to span mode WITHOUT saving (discard changes).
    - On blur: call onSave(inputValue), revert to span mode (same as Enter).
    - Input styling: bg-gray-700 text-white border border-blue-500 rounded px-2 py-1 (highlight that it's editable).

    Create `apps/desktop/src/components/StatHighlights.tsx`:

    Props: `{ games: Game[]; onStatUpdate?: (gameId: string, field: string, value: number) => void }`

    Calculate and display stats derived from the games array:
    - **Points Per Game (PPG):** average of teamScore across all games. Display to 1 decimal.
    - **Opponent PPG:** average of opponentScore. Display to 1 decimal.
    - **Scoring Margin:** PPG minus Opponent PPG, with + or - prefix. Display to 1 decimal.
    - **Highest Score:** max teamScore across games, show "vs {opponent}" subtitle.
    - **Biggest Win:** game with largest (teamScore - opponentScore) positive margin, show "vs {opponent}".
    - **Overtime Games:** count of games where overtime === true.

    Layout: 2x3 grid of stat cards inside the widget.
    Each stat: label in text-xs text-gray-400 uppercase, value in text-xl font-bold.
    PPG and Opponent PPG values use InlineEditCell — BUT these are calculated values, so inline
    editing here is NOT applicable. Instead, just display them as plain text.
    Card wrapper: bg-gray-800 rounded-lg p-5. Title: "Stat Highlights".

    If no games: show "Log games to see stat highlights" placeholder.

    Create `apps/desktop/src/components/GameLog.tsx`:

    Props:
    - `games: Game[]` — all games for the current season, sorted by week
    - `onUpdateGame: (id: string, updates: { teamScore?: number; opponentScore?: number; notes?: string }) => Promise<void>`

    Display a table of all games:
    Columns: Week | Result | Opponent | Score | Type | Notes

    - **Week:** plain text
    - **Result:** colored badge (W green, L red, T gray)
    - **Opponent:** "@" or "vs" prefix based on homeAway, then opponent name.
      If opponentRanking is set, show "#{rank}" before name.
    - **Score:** "{teamScore} - {opponentScore}" — BOTH score cells use InlineEditCell.
      When either score is edited:
      1. Parse new value as integer
      2. Call onUpdateGame(game.id, { teamScore: newTeamScore }) or { opponentScore: newOpponentScore }
      3. The onUpdateGame handler (from DashboardPage) calls gameStore.updateGame which triggers
         recalculateSeasonRecord, then reloads both stores.
      4. Result badge auto-updates because result is derived from scores.
    - **Type:** game type label (Regular, Conference, Bowl, Playoff, Exhibition)
    - **Notes:** truncated text, also uses InlineEditCell for quick edits.

    Table styling: w-full, thead with text-left text-xs text-gray-400 uppercase border-b border-gray-700,
    tbody rows with hover:bg-gray-800/50, text-sm text-gray-200.

    IMPORTANT: When score is inline-edited, the result ('W'/'L'/'T') must be recalculated
    from the new scores. The updateGame service call handles this by updating the game AND
    calling recalculateSeasonRecord. The onUpdateGame prop should also update the result field:
    ```
    const newResult = newTeamScore > opponentScore ? 'W' : newTeamScore < opponentScore ? 'L' : 'T';
    await onUpdateGame(id, { teamScore: newTeamScore, result: newResult });
    ```
  </action>
  <verify>
    Run `pnpm exec tsc --noEmit -p apps/desktop/tsconfig.json` — no type errors.
    Verify InlineEditCell handles click, Enter, Escape, and blur correctly.
    Verify StatHighlights calculates PPG, margin, etc. from games array.
    Verify GameLog renders table with InlineEditCell on score columns.
  </verify>
  <done>
    InlineEditCell is a reusable click-to-edit component with Enter/Escape/blur behavior.
    StatHighlights shows 6 calculated stats from game data.
    GameLog shows full season game table with inline-editable score and notes cells.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire StatHighlights and GameLog into DashboardPage</name>
  <files>
    apps/desktop/src/pages/DashboardPage.tsx
  </files>
  <action>
    Update DashboardPage.tsx to include StatHighlights and GameLog:

    1. Import StatHighlights and GameLog components.

    2. Add StatHighlights widget to the right column, below the WeeklySnapshot widget:
       ```tsx
       <StatHighlights games={games} />
       ```

    3. Add GameLog below the main grid (full width), showing the complete season schedule:
       ```tsx
       <div className="mt-6">
         <GameLog
           games={games}
           onUpdateGame={handleGameUpdate}
         />
       </div>
       ```

    4. Create the handleGameUpdate callback:
       ```tsx
       const handleGameUpdate = async (id: string, updates: { teamScore?: number; opponentScore?: number; notes?: string }) => {
         await gameStore.updateGame(id, updates);
         // Reload both stores to reflect recalculated record
         if (activeDynasty) {
           await seasonStore.loadSeasons(activeDynasty.id);
         }
         if (activeSeason) {
           await gameStore.loadGames(activeSeason.id);
         }
       };
       ```

    5. Ensure the layout flows well:
       - Grid: SeasonAtGlance + RecentActivity (left), WeeklySnapshot + StatHighlights (right)
       - Below grid: full-width GameLog table
       - Adequate spacing between sections (mt-6 or similar)
  </action>
  <verify>
    Run `pnpm exec tsc --noEmit -p apps/desktop/tsconfig.json` — no type errors.
    `pnpm run build` from repo root succeeds.
  </verify>
  <done>
    DashboardPage includes StatHighlights and GameLog.
    Inline editing a score in GameLog triggers record recalculation and dashboard refresh.
    StatHighlights shows calculated PPG, scoring margin, and other derived stats.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Stat highlights panel with PPG, scoring margin, and game-derived stats. Full game log table
    with inline editing on score and notes cells. Inline editing triggers auto-recalculation
    of season records.
  </what-built>
  <how-to-verify>
    1. Run `pnpm run dev` from apps/desktop
    2. Open a dynasty that has games logged (from Plan 02-03 testing)
    3. Verify stat highlights panel shows PPG, Opponent PPG, Scoring Margin, Highest Score, Biggest Win, OT Games
    4. Verify full game log table shows all logged games with correct data
    5. Click a score cell in the game log:
       - It should transform into an editable input
       - Change the score value and press Enter
       - Verify the result badge updates (e.g., changing a win to a loss if scores flip)
       - Verify the season record in SeasonAtGlance updates
    6. Click a score cell and press Escape — verify no changes are saved
    7. Verify stat highlights recalculate after score changes (PPG should change)
    8. Overall: verify the complete dashboard shows:
       - Season record + conference record (DASH-01, SEAS-02, SEAS-03)
       - Recent activity feed (DASH-01)
       - Weekly snapshot (SEAS-05)
       - Stat highlights (DASH-03)
       - Game log with inline editing (INGST-03)
       - Log Game and End Season buttons (DASH-02, SEAS-04)
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
1. `pnpm exec tsc --noEmit -p apps/desktop/tsconfig.json` — zero errors
2. `pnpm run build` from repo root succeeds
3. StatHighlights displays 6 derived stats from game data
4. GameLog renders all season games in table format
5. Clicking score or notes cell opens inline editor
6. Enter saves, Escape cancels, blur saves
7. After inline score edit, season record recalculates and dashboard refreshes
8. All 11 Phase 2 requirements (DASH-01 through INGST-03) are satisfied
</verification>

<success_criteria>
- DASH-03 fully satisfied: stat highlights visible on dashboard
- INGST-03 satisfied: clicking any stat cell opens inline edit without navigating away
- SEAS-05 fully satisfied: weekly snapshot with record, ranking, stats context
- Inline score editing triggers auto-recalculation (SEAS-02, SEAS-03 remain correct)
- Complete dashboard shows all Phase 2 required information
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-loop/02-04-SUMMARY.md`
</output>
