---
phase: 02-core-loop
plan: "05"
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/core-types/src/game.ts
  - packages/db/src/schema.ts
  - packages/db/src/dynasty-db.ts
  - apps/desktop/src/components/LogGameModal.tsx
  - apps/desktop/src/components/WeeklySnapshot.tsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "When logging a game, user can optionally record their team's current ranking via a select dropdown (1-25)"
    - "WeeklySnapshot displays the team's current ranking from the most recent game with a teamRanking value"
    - "WeeklySnapshot displays ranking movement delta when two or more games have teamRanking values (e.g., 'up 3' or 'down 2')"
    - "Existing game data is not broken by the schema change — teamRanking is optional and old records simply lack it"
  artifacts:
    - path: "packages/core-types/src/game.ts"
      provides: "teamRanking optional field on Game interface"
      contains: "teamRanking"
    - path: "packages/db/src/schema.ts"
      provides: "DB_VERSION bumped to 2"
      contains: "DB_VERSION = 2"
    - path: "packages/db/src/dynasty-db.ts"
      provides: "Dexie version 2 migration registered"
      contains: "this.version(2)"
    - path: "apps/desktop/src/components/LogGameModal.tsx"
      provides: "teamRanking select field in game logging form"
      contains: "teamRanking"
    - path: "apps/desktop/src/components/WeeklySnapshot.tsx"
      provides: "Ranking display with movement delta"
      contains: "rankingDelta"
  key_links:
    - from: "apps/desktop/src/components/LogGameModal.tsx"
      to: "useGameStore.logGame"
      via: "teamRanking passed in logGame input object"
      pattern: "teamRanking.*parseInt|teamRanking.*undefined"
    - from: "apps/desktop/src/components/WeeklySnapshot.tsx"
      to: "games prop"
      via: "derives current ranking and delta from games sorted by week"
      pattern: "teamRanking"
---

<objective>
Close the Phase 2 verification gap: "ranking movement" is not tracked or displayed. Add a per-game teamRanking field so coaches can record their team's ranking each week, then update WeeklySnapshot to derive and display ranking movement (week-over-week delta).

Purpose: Satisfies SEAS-05 requirement for "ranking movement" in the weekly season snapshot. Without this, coaches cannot see how their ranking is changing week to week during a season.
Output: Updated Game type with teamRanking, DB migration to version 2, teamRanking select in LogGameModal, ranking delta display in WeeklySnapshot.
</objective>

<execution_context>
@/Users/chanmoore/.claude/get-shit-done/workflows/execute-plan.md
@/Users/chanmoore/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-core-loop/02-VERIFICATION.md

@packages/core-types/src/game.ts
@packages/db/src/schema.ts
@packages/db/src/dynasty-db.ts
@apps/desktop/src/components/LogGameModal.tsx
@apps/desktop/src/components/WeeklySnapshot.tsx
@apps/desktop/src/store/game-store.ts
@apps/desktop/src/lib/game-service.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add teamRanking to Game type, bump DB version, add select to LogGameModal</name>
  <files>
    packages/core-types/src/game.ts
    packages/db/src/schema.ts
    packages/db/src/dynasty-db.ts
    apps/desktop/src/components/LogGameModal.tsx
  </files>
  <action>
    1. **packages/core-types/src/game.ts** — Add `teamRanking?: number` to the Game interface, placed after the `opponentRanking?: number` field. This is optional so existing Game records remain valid.

    2. **packages/db/src/schema.ts** — Change `DB_VERSION` from `1` to `2`. The SCHEMA object stays the same (teamRanking is not an indexed field — it is only read when games are loaded into memory). No new indexes needed.

    3. **packages/db/src/dynasty-db.ts** — Add a version 2 migration. Dexie requires chaining version calls. The constructor should become:
       ```
       this.version(1).stores(SCHEMA);
       this.version(DB_VERSION).stores(SCHEMA);
       ```
       Since DB_VERSION is now 2 and the SCHEMA is unchanged (no new indexes), this tells Dexie to upgrade from v1 to v2 without altering any stores. Existing records are untouched. The new optional `teamRanking` field on Game is just a property that may or may not be present — Dexie does not require schema declaration for non-indexed fields.

    4. **apps/desktop/src/components/LogGameModal.tsx** — Add a "Your Ranking (optional)" select dropdown for teamRanking:
       - Add state: `const [teamRanking, setTeamRanking] = useState('');`
       - Place the select in its own row BELOW the existing "Opp. Ranking + Overtime" row and ABOVE the "Notes" section
       - Use a full-width grid layout: the teamRanking select on the left, empty space on the right (or just a single full-width field)
       - Options: `<option value="">Unranked</option>` plus `<option>` for #1 through #25
       - DO NOT filter used values for teamRanking — unlike opponent rankings, a team's own ranking CAN repeat across weeks (e.g., ranked #5 for three consecutive weeks)
       - Label: "Your Ranking" with `<span className="text-gray-600 text-xs">(optional)</span>` — matching the existing Opp. Ranking label style
       - Use the same select styling classes as the existing opponentRanking select
       - In handleSubmit, include `teamRanking: teamRanking ? parseInt(teamRanking, 10) : undefined` in the logGame call (same pattern as opponentRanking)
       - Reset teamRanking in the form reset (it currently resets implicitly since modal unmounts on close, but include for completeness if a reset function exists)
  </action>
  <verify>
    1. Run `cd /Users/chanmoore/dev/dynasty-os && pnpm build` — should compile without errors (TypeScript validates the new field flows through correctly)
    2. Grep for `teamRanking` in game.ts — field exists on Game interface
    3. Grep for `DB_VERSION = 2` in schema.ts — version bumped
    4. Grep for `version(2)` or `version(DB_VERSION)` in dynasty-db.ts — migration registered
    5. Grep for `teamRanking` in LogGameModal.tsx — select field present and value passed to logGame
  </verify>
  <done>
    Game type has teamRanking optional field. DB migrates from v1 to v2 without breaking existing data. LogGameModal has a "Your Ranking (optional)" select dropdown (1-25, no uniqueness filtering) that passes the value through to the game store on submit.
  </done>
</task>

<task type="auto">
  <name>Task 2: Display ranking and movement delta in WeeklySnapshot</name>
  <files>
    apps/desktop/src/components/WeeklySnapshot.tsx
  </files>
  <action>
    Update the WeeklySnapshot component to derive the current ranking and ranking movement from game data instead of displaying `season.finalRanking`.

    **Ranking derivation logic (add above the return statement):**

    1. Sort games by week descending. Find the most recent game that has a `teamRanking` value set (not undefined). This is `currentRanking`.

    2. If `currentRanking` exists, find the second-most-recent game with a `teamRanking` value. If found, compute `rankingDelta = previousRanking - currentRanking` (positive means moved up, negative means moved down, zero means unchanged). This is the "movement."

    3. If no games have `teamRanking`, fall back to `season?.finalRanking` (preserving current behavior for seasons where the user only set an end-of-season ranking).

    **Display logic (replace the existing "Current ranking" block):**

    Replace the existing block:
    ```tsx
    {season?.finalRanking != null && (
      <div className="text-sm text-gray-400 mb-3">
        Current Ranking: <span className="text-amber-400 font-semibold">#{season.finalRanking}</span>
      </div>
    )}
    ```

    With a new block that shows:
    - The ranking number: `#{currentRanking}` in amber-400 (same as existing)
    - If rankingDelta is positive (moved up): show a green up arrow or text like `+3` in green-400 — e.g., `#5 (+3)` where (+3) means "up 3 spots"
    - If rankingDelta is negative (moved down): show a red indicator like `-2` in red-400 — e.g., `#7 (-2)`
    - If rankingDelta is zero: show `--` or nothing (ranking unchanged)
    - If there is no previous ranking to compare (only one game has teamRanking): show ranking without delta
    - If no ranking at all (no teamRanking on any game, no finalRanking on season): show nothing (same as current behavior — block hidden)

    Use simple text indicators, not SVG arrows. Examples:
    - `Ranking: #5 (+3)` with (+3) in green
    - `Ranking: #7 (-2)` with (-2) in red
    - `Ranking: #5` (no delta if only one data point)
    - `Ranking: #5 (-)` or just `#5` if unchanged (zero delta)

    **Label change:** Change "Current Ranking" to just "Ranking" — it is no longer only the final/end-of-season value.

    **Important:** Do NOT remove the `season` prop from the interface or stop accepting it. The component still uses `season` for wins/losses. Only change how ranking is sourced (prefer game-level teamRanking, fall back to season.finalRanking).
  </action>
  <verify>
    1. Run `cd /Users/chanmoore/dev/dynasty-os && pnpm build` — should compile without errors
    2. Grep for `teamRanking` in WeeklySnapshot.tsx — field is read from games
    3. Grep for `rankingDelta` or equivalent variable name in WeeklySnapshot.tsx — delta is computed
    4. Grep for `finalRanking` in WeeklySnapshot.tsx — fallback to season.finalRanking still exists
    5. Confirm the component still accepts `season` and `games` props (interface unchanged)
  </verify>
  <done>
    WeeklySnapshot derives current ranking from the most recent game with teamRanking, computes week-over-week movement delta from the two most recent games with teamRanking, and displays both. Falls back to season.finalRanking when no per-game rankings exist. Ranking movement is visible as a colored delta indicator next to the ranking number.
  </done>
</task>

</tasks>

<verification>
1. `pnpm build` passes with zero errors across all workspace packages
2. Game type includes `teamRanking?: number` as an optional field
3. DB_VERSION is 2 and DynastyDB registers both version 1 and version 2
4. LogGameModal has a "Your Ranking (optional)" select dropdown that does NOT filter for uniqueness
5. WeeklySnapshot computes ranking from per-game teamRanking data and shows movement delta
6. WeeklySnapshot falls back to season.finalRanking when no game-level rankings exist
7. No existing tests break (if tests exist, run them)
</verification>

<success_criteria>
- The verification gap is closed: "User can see a weekly season snapshot with ranking movement"
- A coach who logs their ranking each week will see their current ranking and how many spots they moved (up or down) in the WeeklySnapshot widget
- Existing dynasties with no teamRanking data continue to work — they see finalRanking if set, or no ranking at all
- The change is purely additive with no breaking modifications to existing data or interfaces
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-loop/02-05-SUMMARY.md`
</output>
