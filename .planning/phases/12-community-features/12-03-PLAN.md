---
phase: 12-community-features
plan: "03"
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/desktop/src/lib/future-schedule-service.ts
  - apps/desktop/src/store/future-schedule-store.ts
  - apps/desktop/src/pages/FutureSchedulePage.tsx
  - apps/desktop/src/lib/player-link-service.ts
  - apps/desktop/src/store/player-link-store.ts
  - apps/desktop/src/pages/PlayerProfilePage.tsx
  - apps/desktop/src/store/navigation-store.ts
  - apps/desktop/src/App.tsx
  - apps/desktop/src/components/CommandPalette.tsx
autonomous: true
requirements:
  - COMM-02
  - COMM-05

must_haves:
  truths:
    - "User can add future scheduled games with opponent, year, game type, and location"
    - "Future Schedule page shows multi-year game list and bowl eligibility projection"
    - "CFB users can link a player to their NFL/Madden career counterpart from PlayerProfilePage"
    - "Player link section on PlayerProfilePage is CFB-guarded (not shown for Madden dynasties)"
    - "Future schedule available to all sport types (sport-agnostic)"
  artifacts:
    - path: "apps/desktop/src/lib/future-schedule-service.ts"
      provides: "Dexie CRUD + bowl eligibility projection for futureGames table"
      exports:
        - createFutureGame
        - getFutureGamesByDynasty
        - deleteFutureGame
        - projectBowlEligibility
    - path: "apps/desktop/src/store/future-schedule-store.ts"
      provides: "Zustand store for future games"
      exports:
        - useFutureScheduleStore
    - path: "apps/desktop/src/pages/FutureSchedulePage.tsx"
      provides: "Multi-year schedule builder with bowl eligibility projection"
      min_lines: 80
    - path: "apps/desktop/src/lib/player-link-service.ts"
      provides: "Dexie CRUD for playerLinks table"
      exports:
        - createPlayerLink
        - getPlayerLinkByPlayer
        - deletePlayerLink
    - path: "apps/desktop/src/store/player-link-store.ts"
      provides: "Zustand store for player links"
      exports:
        - usePlayerLinkStore
    - path: "apps/desktop/src/pages/PlayerProfilePage.tsx"
      provides: "CFB-gated 'NFL/Madden Career Link' section at bottom of profile"
      contains: "playerLink"
    - path: "apps/desktop/src/store/navigation-store.ts"
      provides: "future-schedule page + goToFutureSchedule action"
      contains: "future-schedule"
  key_links:
    - from: "apps/desktop/src/pages/FutureSchedulePage.tsx"
      to: "apps/desktop/src/store/future-schedule-store.ts"
      via: "useFutureScheduleStore hook"
      pattern: "useFutureScheduleStore"
    - from: "apps/desktop/src/pages/PlayerProfilePage.tsx"
      to: "apps/desktop/src/store/player-link-store.ts"
      via: "usePlayerLinkStore hook in PlayerProfilePage"
      pattern: "usePlayerLinkStore"
---

<objective>
Build Future Schedule (COMM-05) with bowl eligibility projection, and Player Link (COMM-02) embedded in PlayerProfilePage as a CFB-guarded section.

Purpose: Coaches need to plan future schedules and track which of their CFB players went on to NFL/Madden careers.
Output: FutureSchedulePage.tsx (standalone), player-link section in PlayerProfilePage, and supporting service/store layers for both.
</objective>

<execution_context>
@/Users/chanmoore/.claude/get-shit-done/workflows/execute-plan.md
@/Users/chanmoore/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-community-features/12-RESEARCH.md

@apps/desktop/src/lib/rivalry-service.ts
@apps/desktop/src/store/navigation-store.ts
@apps/desktop/src/App.tsx
@apps/desktop/src/pages/PlayerProfilePage.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Future schedule service + store + player link service + store</name>
  <files>
    apps/desktop/src/lib/future-schedule-service.ts
    apps/desktop/src/store/future-schedule-store.ts
    apps/desktop/src/lib/player-link-service.ts
    apps/desktop/src/store/player-link-store.ts
  </files>
  <action>
Create `apps/desktop/src/lib/future-schedule-service.ts`:

```typescript
import { db } from '@dynasty-os/db';
import type { FutureGame } from '@dynasty-os/core-types';
import { generateId } from './uuid';

export async function createFutureGame(
  input: Omit<FutureGame, 'id' | 'createdAt' | 'updatedAt'>
): Promise<FutureGame>

export async function getFutureGamesByDynasty(dynastyId: string): Promise<FutureGame[]>
  // Use compound index: db.futureGames.where('[dynastyId+year]')...
  // Or: db.futureGames.where('dynastyId').equals(dynastyId).toArray()
  // Sort by year asc, then opponent asc

export async function updateFutureGame(
  id: string,
  updates: Partial<Pick<FutureGame, 'opponent' | 'year' | 'gameType' | 'location'>>
): Promise<void>

export async function deleteFutureGame(id: string): Promise<void>

// Bowl eligibility projection (CFB-relevant but function can be called for any)
// CFB: eligible if currentWins >= 6 from regular season games
export function projectBowlEligibility(
  futureGames: FutureGame[],
  currentWins: number
): { eligible: boolean; winsNeeded: number; regularGamesRemaining: number }
  // regularGamesRemaining = count of futureGames where gameType !== 'bowl' && gameType !== 'playoff'
  // winsNeeded = Math.max(0, 6 - currentWins)
  // eligible = currentWins >= 6
```

Note: FutureGame from @dynasty-os/core-types was scaffolded in Phase 10. Verify actual field names (likely: id, dynastyId, year, opponent, gameType, location, createdAt, updatedAt). Use whatever fields the type actually has.

Create `apps/desktop/src/store/future-schedule-store.ts`:
- State: `games: FutureGame[]`, `loading: boolean`
- Actions: `loadGames(dynastyId)`, `addGame(input, dynastyId)`, `removeGame(id, dynastyId)`
- `removeGame`: toast success + undo push before delete
- After each mutation: `loadGames(dynastyId)`

Create `apps/desktop/src/lib/player-link-service.ts`:

```typescript
import { db } from '@dynasty-os/db';
import type { PlayerLink } from '@dynasty-os/core-types';
import { generateId } from './uuid';

export async function createPlayerLink(
  input: Omit<PlayerLink, 'id' | 'createdAt' | 'updatedAt'>
): Promise<PlayerLink>

export async function getPlayerLinkByPlayer(dynastyId: string, playerId: string): Promise<PlayerLink | undefined>
  // Use compound index: db.playerLinks.where('[dynastyId+playerId]').equals([dynastyId, playerId]).first()

export async function deletePlayerLink(id: string): Promise<void>
```

Note: PlayerLink from @dynasty-os/core-types was scaffolded in Phase 10. Likely fields: id, dynastyId, playerId, linkedDynastyId (string, the Madden dynasty id), linkedPlayerName (string), linkedTeam (string), notes (string, optional), createdAt, updatedAt. Verify actual type shape before implementing.

Create `apps/desktop/src/store/player-link-store.ts`:
- State: `link: PlayerLink | null`, `loading: boolean`
- Actions: `loadLink(dynastyId, playerId)`, `setLink(input, dynastyId, playerId)`, `removeLink(dynastyId, playerId)`
- Toast notifications for set/remove
  </action>
  <verify>
    <automated>cd /Users/chanmoore/dev/dynasty-os && pnpm --filter @dynasty-os/desktop build 2>&1 | tail -5</automated>
    <manual>All 4 files exist with correct exports; TypeScript compiles clean</manual>
  </verify>
  <done>future-schedule-service.ts, future-schedule-store.ts, player-link-service.ts, player-link-store.ts all created and TypeScript-clean; build exits 0</done>
</task>

<task type="auto">
  <name>Task 2: FutureSchedulePage + PlayerProfilePage player link section + navigation registration</name>
  <files>
    apps/desktop/src/pages/FutureSchedulePage.tsx
    apps/desktop/src/pages/PlayerProfilePage.tsx
    apps/desktop/src/store/navigation-store.ts
    apps/desktop/src/App.tsx
    apps/desktop/src/components/CommandPalette.tsx
  </files>
  <action>
Create `apps/desktop/src/pages/FutureSchedulePage.tsx`:

- Sport guard: NONE — future schedule is sport-agnostic (both CFB and Madden can schedule future games)
- On mount: `loadGames(activeDynasty.id)` via useFutureScheduleStore; also load `activeSeason` from useSeasonStore to get currentWins for bowl projection
- Layout: standard page header ("Future Schedule")
  - Add Game form: opponent (text), year (number, default activeSeason.year + 1), gameType (select: regular | conference | bowl | playoff | non-conference), location (select: home | away | neutral) → submit calls `addGame`
  - Games table: grouped by year, sorted year asc — columns: Opponent, Type, Location, Delete button
  - Bowl Eligibility section (show only when `activeDynasty.sport === 'cfb'` AND games.length > 0):
    - Call `projectBowlEligibility(games, activeSeason?.wins ?? 0)`
    - Display: "Bowl Eligible" (green) or "Needs X more wins" (amber) based on result
    - Show: current wins, wins needed, regular games remaining

Update `apps/desktop/src/pages/PlayerProfilePage.tsx`:

- Read the existing file CAREFULLY first to understand its structure
- At the BOTTOM of the component (after all existing sections), add a "NFL/Madden Career Link" section
- CFB guard this section: `{activeDynasty?.sport === 'cfb' && (...)}`
- On section mount: `loadLink(activeDynasty.id, player.id)` via usePlayerLinkStore
- If no link exists: show "Link to NFL/Madden Career" form with fields: linkedPlayerName (text, name in the other dynasty), linkedTeam (text, NFL team), notes (textarea, optional) → submit calls `setLink`
- If link exists: show linked player info (name, team, notes) + "Remove Link" button
- Import usePlayerLinkStore only (do not remove any existing imports)

Update navigation-store.ts:
- Add `'future-schedule'` to Page union
- Add `goToFutureSchedule: () => void` to NavigationActions + implement

Update App.tsx:
- Import FutureSchedulePage
- Add `case 'future-schedule': return <FutureSchedulePage />;`

Update CommandPalette.tsx:
- Add entry: `{ id: 'nav-future-schedule', label: 'Future Schedule', description: 'Plan multi-year schedule', group: 'Navigation', action: () => goToFutureSchedule() }`
- No sport guard (sport-agnostic)
  </action>
  <verify>
    <automated>cd /Users/chanmoore/dev/dynasty-os && pnpm --filter @dynasty-os/desktop build 2>&1 | tail -5</automated>
    <manual>FutureSchedulePage renders with add form + game table; PlayerProfilePage shows NFL link section for CFB dynasties; build exits 0</manual>
  </verify>
  <done>FutureSchedulePage renders with schedule builder + CFB-only bowl eligibility projection; PlayerProfilePage has CFB-gated player link section; navigation-store has future-schedule; App.tsx routes correctly; CommandPalette entry present; build exits 0</done>
</task>

</tasks>

<verification>
cd /Users/chanmoore/dev/dynasty-os && pnpm --filter @dynasty-os/desktop build 2>&1 | grep -E "(error|warning|✓|built)" | tail -10
</verification>

<success_criteria>
- future-schedule-service.ts exports createFutureGame, getFutureGamesByDynasty, deleteFutureGame, projectBowlEligibility
- future-schedule-store.ts exports useFutureScheduleStore
- FutureSchedulePage.tsx renders schedule builder with bowl eligibility (CFB only)
- player-link-service.ts exports createPlayerLink, getPlayerLinkByPlayer, deletePlayerLink
- player-link-store.ts exports usePlayerLinkStore
- PlayerProfilePage.tsx has CFB-gated NFL/Madden career link section at bottom
- navigation-store.ts has 'future-schedule' and goToFutureSchedule
- App.tsx has case 'future-schedule'
- CommandPalette.tsx has Future Schedule entry
- pnpm build exits 0
</success_criteria>

<output>
After completion, create `.planning/phases/12-community-features/12-03-SUMMARY.md`
</output>
