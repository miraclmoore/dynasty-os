---
phase: 12-community-features
plan: "06"
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/desktop/src/lib/auto-export-service.ts
  - apps/desktop/src/lib/export-import.ts
  - apps/desktop/src/pages/RivalryTrackerPage.tsx
  - apps/desktop/src/lib/rivalry-service.ts
  - apps/desktop/src/store/dynasty-store.ts
  - apps/desktop/src-tauri/capabilities/default.json
autonomous: true
requirements:
  - COMM-08
  - COMM-10

must_haves:
  truths:
    - "User can toggle auto-export per dynasty; when enabled, JSON export writes silently to the Tauri app data directory on every dynasty save"
    - "Auto-export never shows an OS dialog (write to pre-determined appDataDir path, no save() call)"
    - "Auto-export is fire-and-forget — never blocks the UI thread or dynasty save operation"
    - "Tauri fs:allow-mkdir capability is present in default.json"
    - "Rivalry Dashboard shows series momentum score (-1 to +1) and a key moments log per rival"
    - "Series momentum is computed from existing game records — no new DB table"
    - "Key moments are stored in localStorage keyed by rivalry ID — no Dexie version bump"
  artifacts:
    - path: "apps/desktop/src/lib/auto-export-service.ts"
      provides: "isAutoExportEnabled, setAutoExportEnabled, autoExportIfEnabled"
      exports:
        - isAutoExportEnabled
        - setAutoExportEnabled
        - autoExportIfEnabled
    - path: "apps/desktop/src/lib/export-import.ts"
      provides: "Updated exportDynasty v2 including coachingStaff, nilEntries, futureGames, playerLinks tables"
      contains: "coachingStaff"
    - path: "apps/desktop/src/lib/rivalry-service.ts"
      provides: "calculateSeriesMomentum pure function added to existing file"
      contains: "calculateSeriesMomentum"
    - path: "apps/desktop/src/pages/RivalryTrackerPage.tsx"
      provides: "Expanded rivalry view with momentum score, momentum chart, and key moments log per rival"
      contains: "calculateSeriesMomentum"
    - path: "apps/desktop/src/store/dynasty-store.ts"
      provides: "autoExportIfEnabled called after successful dynasty mutations"
      contains: "autoExportIfEnabled"
    - path: "apps/desktop/src-tauri/capabilities/default.json"
      provides: "fs:allow-mkdir permission added"
      contains: "fs:allow-mkdir"
  key_links:
    - from: "apps/desktop/src/store/dynasty-store.ts"
      to: "apps/desktop/src/lib/auto-export-service.ts"
      via: "autoExportIfEnabled() fire-and-forget call after saves"
      pattern: "autoExportIfEnabled"
    - from: "apps/desktop/src/pages/RivalryTrackerPage.tsx"
      to: "apps/desktop/src/lib/rivalry-service.ts"
      via: "calculateSeriesMomentum imported and called with H2H game data"
      pattern: "calculateSeriesMomentum"
---

<objective>
Build auto-export background service (COMM-08) and expand the Rivalry Dashboard (COMM-10) with momentum scoring and key moments log.

Purpose: Coaches want their dynasty data automatically backed up; rivalry tracking needs richer historical context.
Output: auto-export-service.ts wired into dynasty-store, export-import.ts updated for v2 data, RivalryTrackerPage expanded with momentum + key moments, default.json updated for mkdir.
</objective>

<execution_context>
@/Users/chanmoore/.claude/get-shit-done/workflows/execute-plan.md
@/Users/chanmoore/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-community-features/12-RESEARCH.md

@apps/desktop/src/lib/export-import.ts
@apps/desktop/src/lib/rivalry-service.ts
@apps/desktop/src/pages/RivalryTrackerPage.tsx
@apps/desktop/src/store/dynasty-store.ts
@apps/desktop/src-tauri/capabilities/default.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Auto-export service + export-import v2 + Tauri capability</name>
  <files>
    apps/desktop/src/lib/auto-export-service.ts
    apps/desktop/src/lib/export-import.ts
    apps/desktop/src/store/dynasty-store.ts
    apps/desktop/src-tauri/capabilities/default.json
  </files>
  <action>
Create `apps/desktop/src/lib/auto-export-service.ts` following the RESEARCH.md pattern exactly:

```typescript
import { appDataDir } from '@tauri-apps/api/path';
import { writeTextFile, mkdir } from '@tauri-apps/plugin-fs';
import { exportDynasty } from './export-import';

const AUTO_EXPORT_KEY = (dynastyId: string) => `dynasty-os-autoexport-${dynastyId}`;

export function isAutoExportEnabled(dynastyId: string): boolean {
  return localStorage.getItem(AUTO_EXPORT_KEY(dynastyId)) === 'true';
}

export function setAutoExportEnabled(dynastyId: string, enabled: boolean): void {
  if (enabled) {
    localStorage.setItem(AUTO_EXPORT_KEY(dynastyId), 'true');
  } else {
    localStorage.removeItem(AUTO_EXPORT_KEY(dynastyId));
  }
}

export async function autoExportIfEnabled(dynastyId: string, dynastyName: string): Promise<void> {
  if (!isAutoExportEnabled(dynastyId)) return;
  // Fire-and-forget IIFE — never await this function at call site
  (async () => {
    try {
      const appDir = await appDataDir();
      const exportDir = `${appDir}/exports`;
      await mkdir(exportDir, { recursive: true });
      const json = await exportDynasty(dynastyId);
      const safeName = dynastyName.replace(/[^a-z0-9]/gi, '-').toLowerCase();
      await writeTextFile(`${exportDir}/${safeName}-latest.json`, json);
    } catch {
      // Never block UI — auto-export failure is silent
    }
  })();
}
```

Update `apps/desktop/src/lib/export-import.ts`:
- Read the existing file carefully first
- Update the export to include the 4 new Phase 12 entity tables (coachingStaff, nilEntries, futureGames, playerLinks)
- Bump export format version to 2: `"version": 2` in the exported JSON structure
- Pattern: add these 4 tables to the same Promise.all query that fetches the existing tables (dynasties, seasons, games, players, playerSeasons, etc.)
- Do NOT break the existing import logic — imports with version 1 data still work; new fields are optional on import
- If DynastyExport interface exists, extend it with `coachingStaff?: CoachingStaff[]`, `nilEntries?: NilEntry[]`, `futureGames?: FutureGame[]`, `playerLinks?: PlayerLink[]`

Update `apps/desktop/src/store/dynasty-store.ts`:
- Read the existing file carefully first
- After every successful save/update/import operation that modifies dynasty data, add a fire-and-forget call:
  ```typescript
  import { autoExportIfEnabled } from '../lib/auto-export-service';
  // In each mutation that succeeds:
  autoExportIfEnabled(dynastyId, dynastyName); // no await — fire-and-forget
  ```
- Identify the specific store actions where this belongs: `createDynasty`, `updateDynasty`, and any action that represents a significant data mutation
- Do NOT add to `deleteDynasty` or `loadDynasties` — export on deletion is not useful

Update `apps/desktop/src-tauri/capabilities/default.json`:
- Add `"fs:allow-mkdir"` to the permissions array
- Current permissions do NOT include mkdir (confirmed by codebase inspection — only write-text-file, read-text-file, read-file, exists, watch are present)

Also add an "Auto Export" toggle to `apps/desktop/src/pages/DashboardPage.tsx`:
- Read the existing DashboardPage carefully
- Add a simple toggle/checkbox in the dashboard settings area (or near the existing export button if one exists): "Auto-export dynasty on save"
- On change: call `setAutoExportEnabled(activeDynasty.id, checked)`
- On mount: initialize checked state from `isAutoExportEnabled(activeDynasty.id)`
- This is a lightweight addition — find the right location in the existing dashboard layout
  </action>
  <verify>
    <automated>cd /Users/chanmoore/dev/dynasty-os && pnpm --filter @dynasty-os/desktop build 2>&1 | tail -5</automated>
    <manual>Enable auto-export in dashboard; perform any save; verify file appears in ~/Library/Application Support/dynasty-os/exports/ (on macOS)</manual>
  </verify>
  <done>auto-export-service.ts created with 3 exports; export-import.ts version bumped to 2 with 4 new table exports; dynasty-store.ts fires autoExportIfEnabled after saves; default.json has fs:allow-mkdir; DashboardPage has toggle; build exits 0</done>
</task>

<task type="auto">
  <name>Task 2: Rivalry Dashboard expansion — momentum + key moments</name>
  <files>
    apps/desktop/src/lib/rivalry-service.ts
    apps/desktop/src/pages/RivalryTrackerPage.tsx
  </files>
  <action>
Update `apps/desktop/src/lib/rivalry-service.ts`:

- Read the existing file carefully first (it has createRival, getRivalsByDynasty, updateRival, deleteRival, calculateRivalryIntensity)
- ADD (do not remove existing functions) a new pure function `calculateSeriesMomentum`:

```typescript
// HeadToHeadRecord type should be imported or inferred from records-service.ts
// If HeadToHeadRecord is not imported here, use a local game array type
export function calculateSeriesMomentum(
  games: Array<{ result: 'W' | 'L' | 'T'; week?: number }>
): number {
  // Momentum = weighted win rate of last 5 games (most recent = highest weight)
  // Returns -1 (full disadvantage) to +1 (full advantage)
  const recent = games.slice(0, 5);
  if (recent.length === 0) return 0;
  let weighted = 0;
  let totalWeight = 0;
  recent.forEach((g, i) => {
    const weight = 5 - i;
    weighted += (g.result === 'W' ? 1 : g.result === 'L' ? -1 : 0) * weight;
    totalWeight += weight;
  });
  return totalWeight > 0 ? Math.round((weighted / totalWeight) * 100) / 100 : 0;
}
```

- Also add localStorage helpers for key moments:
```typescript
const KEY_MOMENTS_KEY = (rivalId: string) => `dynasty-os-moments-${rivalId}`;

export interface KeyMoment {
  year: number;
  description: string;
}

export function getKeyMoments(rivalId: string): KeyMoment[] {
  try {
    return JSON.parse(localStorage.getItem(KEY_MOMENTS_KEY(rivalId)) ?? '[]');
  } catch { return []; }
}

export function addKeyMoment(rivalId: string, moment: KeyMoment): void {
  const existing = getKeyMoments(rivalId);
  const updated = [...existing, moment].sort((a, b) => b.year - a.year);
  localStorage.setItem(KEY_MOMENTS_KEY(rivalId), JSON.stringify(updated));
}

export function deleteKeyMoment(rivalId: string, year: number, description: string): void {
  const existing = getKeyMoments(rivalId).filter(
    m => !(m.year === year && m.description === description)
  );
  localStorage.setItem(KEY_MOMENTS_KEY(rivalId), JSON.stringify(existing));
}
```

Update `apps/desktop/src/pages/RivalryTrackerPage.tsx`:

- Read the existing file carefully first — understand current layout and data flow
- The page uses `useRivalryStore` and `getHeadToHeadRecords()` from records-service — preserve all existing functionality
- ADD to each rivalry's expanded/detail view (or add a collapsible panel per rival):
  1. **Series Momentum**: compute `calculateSeriesMomentum(h2hRecord.games)` where h2hRecord is the H2H data for that rival. Display as a momentum bar: negative (red, opponent advantage) to positive (green, user advantage). Show the numeric value (-1 to +1) and a text label ("Momentum: You" | "Momentum: Opponent" | "Even").
  2. **Key Moments Log**: below momentum, show existing key moments from `getKeyMoments(rival.id)` as a list with year + description. Add form: year (number input) + description (text input) + "Add Moment" button → calls `addKeyMoment(rival.id, {year, description})`. Delete button per moment calls `deleteKeyMoment`.
- recharts LineChart for rivalry momentum trend (optional — only if straightforward; if complex, skip the chart and just show the score):
  - If implementing: data = recent 5 games mapped to `{game: number; score: number}`, LineChart with XAxis 1-5 and YAxis -1 to 1
  - If skipping chart: display the scalar momentum value with color bar — simpler is better here
- Do NOT remove any existing RivalryTrackerPage functionality
  </action>
  <verify>
    <automated>cd /Users/chanmoore/dev/dynasty-os && pnpm --filter @dynasty-os/desktop build 2>&1 | tail -5</automated>
    <manual>Open Rivalry Tracker with existing rivals; verify momentum score shows; add a key moment; verify it persists after page navigation</manual>
  </verify>
  <done>rivalry-service.ts has calculateSeriesMomentum + getKeyMoments + addKeyMoment + deleteKeyMoment; RivalryTrackerPage shows momentum score per rival and key moments log with add form; key moments survive navigation (localStorage); build exits 0</done>
</task>

</tasks>

<verification>
cd /Users/chanmoore/dev/dynasty-os && pnpm --filter @dynasty-os/desktop build 2>&1 | grep -E "(error|warning|✓|built)" | tail -10
</verification>

<success_criteria>
- auto-export-service.ts exports isAutoExportEnabled, setAutoExportEnabled, autoExportIfEnabled
- autoExportIfEnabled is fire-and-forget (no await at call sites in dynasty-store)
- export-import.ts includes coachingStaff, nilEntries, futureGames, playerLinks in export, version bumped to 2
- default.json has fs:allow-mkdir
- rivalry-service.ts has calculateSeriesMomentum, getKeyMoments, addKeyMoment, deleteKeyMoment
- RivalryTrackerPage shows momentum score + key moments log per rival
- DashboardPage has auto-export toggle
- pnpm build exits 0
</success_criteria>

<output>
After completion, create `.planning/phases/12-community-features/12-06-SUMMARY.md`
</output>
