---
phase: 12-community-features
plan: "04"
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/desktop/src/lib/playoff-bracket.ts
  - apps/desktop/src/pages/PlayoffSimulatorPage.tsx
  - apps/desktop/src/lib/trade-calculator.ts
  - apps/desktop/src/pages/TradeCalculatorPage.tsx
  - apps/desktop/src/store/navigation-store.ts
  - apps/desktop/src/App.tsx
  - apps/desktop/src/components/CommandPalette.tsx
autonomous: true
requirements:
  - COMM-03
  - COMM-06

must_haves:
  truths:
    - "CFB users can create a 4, 8, or 12-team playoff bracket with customizable team names and seedings"
    - "User picks winners per matchup; bracket advances round by round in component state"
    - "Bracket state is session-only (not persisted to DB)"
    - "Madden users can enter position, rating, age, and contract years and receive a trade value score with breakdown"
    - "Trade Calculator is Madden-gated (CFB users see null)"
    - "Playoff Simulator is CFB-gated (Madden users see null)"
  artifacts:
    - path: "apps/desktop/src/lib/playoff-bracket.ts"
      provides: "Pure bracket logic — buildBracket, advanceBracket, pickWinner"
      exports:
        - buildBracket
        - advanceBracket
    - path: "apps/desktop/src/pages/PlayoffSimulatorPage.tsx"
      provides: "CFB-gated bracket UI with round-by-round progression (session state only)"
      min_lines: 80
    - path: "apps/desktop/src/lib/trade-calculator.ts"
      provides: "Pure calculateTradeValue function — position/rating/age/contract inputs"
      exports:
        - calculateTradeValue
    - path: "apps/desktop/src/pages/TradeCalculatorPage.tsx"
      provides: "Madden-gated trade value calculator UI"
      min_lines: 60
    - path: "apps/desktop/src/store/navigation-store.ts"
      provides: "playoff-simulator + trade-calculator pages and go actions"
      contains: "playoff-simulator"
    - path: "apps/desktop/src/App.tsx"
      provides: "case 'playoff-simulator' and case 'trade-calculator'"
      contains: "playoff-simulator"
  key_links:
    - from: "apps/desktop/src/pages/PlayoffSimulatorPage.tsx"
      to: "apps/desktop/src/lib/playoff-bracket.ts"
      via: "imported buildBracket/advanceBracket functions"
      pattern: "buildBracket|advanceBracket"
    - from: "apps/desktop/src/pages/TradeCalculatorPage.tsx"
      to: "apps/desktop/src/lib/trade-calculator.ts"
      via: "imported calculateTradeValue function"
      pattern: "calculateTradeValue"
---

<objective>
Build two pure-computation pages: Playoff Simulator (CFB-gated, session-only bracket state) and Trade Calculator (Madden-gated, pure function UI).

Purpose: CFB coaches want to simulate playoff scenarios; Madden coaches need a trade value tool to evaluate deals.
Output: PlayoffSimulatorPage.tsx + playoff-bracket.ts (pure logic), TradeCalculatorPage.tsx + trade-calculator.ts (pure function), and navigation registration for both.
</objective>

<execution_context>
@/Users/chanmoore/.claude/get-shit-done/workflows/execute-plan.md
@/Users/chanmoore/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-community-features/12-RESEARCH.md

@apps/desktop/src/store/navigation-store.ts
@apps/desktop/src/App.tsx
@apps/desktop/src/components/CommandPalette.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Pure logic libraries — playoff-bracket.ts + trade-calculator.ts</name>
  <files>
    apps/desktop/src/lib/playoff-bracket.ts
    apps/desktop/src/lib/trade-calculator.ts
  </files>
  <action>
Create `apps/desktop/src/lib/playoff-bracket.ts` — pure functions, no DB, no side effects:

```typescript
export type BracketSize = 4 | 8 | 12;

export interface BracketTeam {
  seed: number;
  name: string;
}

export interface BracketMatchup {
  id: string;
  team1: BracketTeam | null;
  team2: BracketTeam | null;
  winner: BracketTeam | null;
  round: number;
}

export interface Bracket {
  size: BracketSize;
  rounds: BracketMatchup[][];
  champion: BracketTeam | null;
}

export function buildBracket(teams: BracketTeam[]): Bracket
  // teams.length must be 4, 8, or 12
  // Standard seeding: 1 vs lowest seed, 2 vs second-lowest, etc.
  // For 12-team: top 4 seeds get first-round byes (seeded bracket structure)
  // Round 1 matchups populated; subsequent rounds have null team slots until winner picked
  // Returns Bracket with rounds array and champion: null

export function pickWinner(bracket: Bracket, matchupId: string, winner: BracketTeam): Bracket
  // Returns new Bracket (immutable) with winner set on the matchup
  // Advances winner to correct slot in next round
  // If all matchups in final round decided, sets bracket.champion
  // If 12-team: handle bye logic (seed 1-4 enter at quarterfinal round)
```

Design notes:
- All functions are PURE — return new bracket objects, never mutate in-place
- Component state drives all UI; no Zustand needed for this feature
- Keep pickWinner simple: find matchup by id, set winner, find next round matchup index (winner of matchup N advances to slot N/2 in next round), return new bracket

Create `apps/desktop/src/lib/trade-calculator.ts` — pure function, no DB:

```typescript
// Position base values (0-100 scale)
const POSITION_BASE: Record<string, number> = {
  QB: 100, EDGE: 85, LT: 80, CB: 78, WR: 75, S: 72, DT: 70,
  RB: 65, TE: 65, OL: 60, LB: 60, K: 20, P: 20,
};

export interface TradeValueInput {
  position: string;
  overallRating: number;  // 50-99
  age: number;            // player age (from birthYear or user input)
  contractYearsLeft: number; // 0-7
}

export interface TradeValueResult {
  totalValue: number;     // 0-150 point scale
  grade: 'Elite' | 'High' | 'Average' | 'Low' | 'Untradeable';
  breakdown: {
    basePosition: number;
    ratingAdjustment: number;
    agePenalty: number;
    contractBonus: number;
  };
}

export function calculateTradeValue(input: TradeValueInput): TradeValueResult
  // basePos = POSITION_BASE[position.toUpperCase()] ?? 60
  // ratingFactor = (overallRating - 50) / 50  (0-1 scale above 50)
  // agePenalty = age > 30 ? (age - 30) * 0.08 : 0
  // contractBonus = Math.min(0.2, (contractYearsLeft - 1) * 0.05)
  // base = basePos * (1 + ratingFactor)
  // total = Math.round(base * (1 - agePenalty) * (1 + contractBonus))
  // Clamp to [0, 150]
  // grade: Elite >= 100, High >= 70, Average >= 40, Low >= 10, Untradeable < 10
```
  </action>
  <verify>
    <automated>cd /Users/chanmoore/dev/dynasty-os && pnpm --filter @dynasty-os/desktop build 2>&1 | tail -5</automated>
    <manual>playoff-bracket.ts exports buildBracket and pickWinner; trade-calculator.ts exports calculateTradeValue; both TypeScript-clean</manual>
  </verify>
  <done>playoff-bracket.ts and trade-calculator.ts exist with correct exports; TypeScript compiles clean; build exits 0</done>
</task>

<task type="auto">
  <name>Task 2: PlayoffSimulatorPage + TradeCalculatorPage + navigation registration</name>
  <files>
    apps/desktop/src/pages/PlayoffSimulatorPage.tsx
    apps/desktop/src/pages/TradeCalculatorPage.tsx
    apps/desktop/src/store/navigation-store.ts
    apps/desktop/src/App.tsx
    apps/desktop/src/components/CommandPalette.tsx
  </files>
  <action>
Create `apps/desktop/src/pages/PlayoffSimulatorPage.tsx`:

- CFB sport guard at top: `if (!activeDynasty || activeDynasty.sport !== 'cfb') return null;`
- State (useState, NOT Zustand): `bracket: Bracket | null`, `bracketSize: BracketSize (default 12)`, `teamInputs: string[]` (team name inputs)
- Setup phase (bracket === null):
  - Select bracket size: 4, 8, or 12 teams — radio buttons or tabs
  - Team name inputs: N text inputs labeled "Seed 1" through "Seed N" (fill in 4, 8, or 12 inputs)
  - "Start Bracket" button: calls `buildBracket(teamInputs.map((name, i) => ({ seed: i+1, name })))`, sets bracket state
- Active bracket display:
  - Render rounds as columns: Round 1 → Quarterfinals → Semifinals → Final → Champion
  - Each matchup shows team1 name + "vs" + team2 name; bye slots show "BYE"
  - "Pick Winner" buttons for matchups where both teams are decided (not null) and no winner yet
  - Winner highlighted in green text
  - Champion banner when bracket.champion is set
- "Reset" button: sets bracket to null to start over
- Tailwind: horizontal scrollable container for rounds if needed

Create `apps/desktop/src/pages/TradeCalculatorPage.tsx`:

- Madden sport guard at top: `if (!activeDynasty || activeDynasty.sport !== 'madden') return null;`
- State (useState): `position: string`, `overallRating: number (default 75)`, `age: number (default 27)`, `contractYearsLeft: number (default 2)`, `result: TradeValueResult | null`
- Layout: page header ("Trade Value Calculator") + calculator form
  - Position: select from list (QB, EDGE, LT, CB, WR, S, DT, RB, TE, OL, LB, K, P)
  - Overall Rating: number input (50–99)
  - Age: number input (20–40); if activeDynasty player is selected, can pre-fill from player list (optional — basic manual input is sufficient)
  - Contract Years Left: number input (0–7)
  - "Calculate" button: calls `calculateTradeValue(...)`, sets result state
- Result display (when result !== null):
  - Grade badge (color-coded: Elite=purple, High=green, Average=yellow, Low=orange, Untradeable=red)
  - Total Value score (large number, e.g., text-4xl)
  - Breakdown table: Base Position, Rating Adjustment, Age Penalty, Contract Bonus as rows
- Tailwind: dark-mode consistent, grid layout for form + results

Update navigation-store.ts:
- Add `'playoff-simulator'` and `'trade-calculator'` to Page union
- Add `goToPlayoffSimulator: () => void` and `goToTradeCalculator: () => void` to NavigationActions + implement

Update App.tsx:
- Import PlayoffSimulatorPage and TradeCalculatorPage
- Add cases: `case 'playoff-simulator': return <PlayoffSimulatorPage />;` and `case 'trade-calculator': return <TradeCalculatorPage />;`

Update CommandPalette.tsx:
- CFB-gated entry: `{ id: 'nav-playoff-simulator', label: 'Playoff Simulator', description: 'Simulate playoff bracket', group: 'Navigation', action: () => goToPlayoffSimulator() }` — CFB only
- Madden-gated entry: `{ id: 'nav-trade-calculator', label: 'Trade Calculator', description: 'Calculate trade value', group: 'Navigation', action: () => goToTradeCalculator() }` — Madden only
- Check existing CommandPalette.tsx sport-gating pattern and replicate it
  </action>
  <verify>
    <automated>cd /Users/chanmoore/dev/dynasty-os && pnpm --filter @dynasty-os/desktop build 2>&1 | tail -5</automated>
    <manual>PlayoffSimulatorPage renders for CFB — enter team names, start bracket, pick winners; TradeCalculatorPage renders for Madden — enter inputs, see grade + value</manual>
  </verify>
  <done>PlayoffSimulatorPage renders CFB-only bracket with setup phase + active bracket; TradeCalculatorPage renders Madden-only with grade and value breakdown; navigation-store has both pages; App.tsx routes both; CommandPalette sport-gated entries present; build exits 0</done>
</task>

</tasks>

<verification>
cd /Users/chanmoore/dev/dynasty-os && pnpm --filter @dynasty-os/desktop build 2>&1 | grep -E "(error|warning|✓|built)" | tail -10
</verification>

<success_criteria>
- playoff-bracket.ts exports buildBracket and pickWinner as pure functions
- trade-calculator.ts exports calculateTradeValue returning grade + breakdown
- PlayoffSimulatorPage.tsx CFB-gated, session-state bracket with round progression
- TradeCalculatorPage.tsx Madden-gated, form inputs + grade result
- navigation-store.ts has playoff-simulator, trade-calculator, and go actions
- App.tsx has case 'playoff-simulator' and case 'trade-calculator'
- CommandPalette.tsx has sport-gated entries for both
- pnpm build exits 0
</success_criteria>

<output>
After completion, create `.planning/phases/12-community-features/12-04-SUMMARY.md`
</output>
