---
phase: 12-community-features
plan: "02"
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/desktop/src/lib/nil-service.ts
  - apps/desktop/src/store/nil-store.ts
  - apps/desktop/src/pages/NilLedgerPage.tsx
  - apps/desktop/src/store/navigation-store.ts
  - apps/desktop/src/App.tsx
  - apps/desktop/src/components/CommandPalette.tsx
  - apps/desktop/package.json
autonomous: true
requirements:
  - COMM-04

must_haves:
  truths:
    - "CFB users can log NIL deals for any player with amount, brand, and duration (start/end year)"
    - "NIL Ledger page shows total spend per class year and per position as bar charts (recharts)"
    - "Madden users see nothing (CFB guard returns null at top of component)"
    - "Log NIL deal form shows player picker from active dynasty roster"
    - "Delete NIL entry is undoable"
  artifacts:
    - path: "apps/desktop/src/lib/nil-service.ts"
      provides: "Dexie CRUD + aggregation for nilEntries table"
      exports:
        - createNilEntry
        - getNilEntriesByDynasty
        - getNilEntriesByPlayer
        - computeNilSpendByPosition
        - computeNilSpendByYear
    - path: "apps/desktop/src/store/nil-store.ts"
      provides: "Zustand store for NIL entries"
      exports:
        - useNilStore
    - path: "apps/desktop/src/pages/NilLedgerPage.tsx"
      provides: "NIL deal log with recharts spend breakdown (CFB guard)"
      min_lines: 100
    - path: "apps/desktop/src/store/navigation-store.ts"
      provides: "nil-ledger page + goToNilLedger action"
      contains: "nil-ledger"
    - path: "apps/desktop/src/App.tsx"
      provides: "case 'nil-ledger'"
      contains: "nil-ledger"
  key_links:
    - from: "apps/desktop/src/pages/NilLedgerPage.tsx"
      to: "apps/desktop/src/store/nil-store.ts"
      via: "useNilStore hook"
      pattern: "useNilStore"
    - from: "apps/desktop/src/pages/NilLedgerPage.tsx"
      to: "recharts BarChart"
      via: "import from recharts"
      pattern: "from 'recharts'"
---

<objective>
Build NIL Ledger: install recharts, create nil-service + nil-store, and build NilLedgerPage with deal log and spend breakdown bar charts.

Purpose: CFB coaches need to track NIL deals per player with financial summaries by position and class year.
Output: NilLedgerPage.tsx with recharts spend charts, complete service/store layer, and navigation registration. recharts is installed in this plan (first of 3 confirmed chart uses — NIL, COMM-07, COMM-10).
</objective>

<execution_context>
@/Users/chanmoore/.claude/get-shit-done/workflows/execute-plan.md
@/Users/chanmoore/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-community-features/12-RESEARCH.md

@apps/desktop/src/lib/rivalry-service.ts
@apps/desktop/src/store/rivalry-store.ts
@apps/desktop/src/store/navigation-store.ts
@apps/desktop/src/App.tsx
@apps/desktop/src/components/CommandPalette.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install recharts + NIL service + NIL store</name>
  <files>
    apps/desktop/package.json
    apps/desktop/src/lib/nil-service.ts
    apps/desktop/src/store/nil-store.ts
  </files>
  <action>
Install recharts (STATE.md decision: add when 3+ chart uses confirmed — Phase 12 has exactly 3: NIL, recruiting comparison, rivalry momentum):

```bash
pnpm --filter @dynasty-os/desktop add recharts@^3.7.0
```

Create `apps/desktop/src/lib/nil-service.ts` following rivalry-service.ts pattern:

```typescript
import { db } from '@dynasty-os/db';
import type { NilEntry } from '@dynasty-os/core-types';
import { generateId } from './uuid';

export async function createNilEntry(
  input: Omit<NilEntry, 'id' | 'createdAt' | 'updatedAt'>
): Promise<NilEntry>

export async function getNilEntriesByDynasty(dynastyId: string): Promise<NilEntry[]>

export async function getNilEntriesByPlayer(dynastyId: string, playerId: string): Promise<NilEntry[]>
  // Use compound index: db.nilEntries.where('[dynastyId+playerId]').equals([dynastyId, playerId])

export async function updateNilEntry(
  id: string,
  updates: Partial<Pick<NilEntry, 'amount' | 'brand' | 'startYear' | 'endYear'>>
): Promise<void>

export async function deleteNilEntry(id: string): Promise<void>

// Pure aggregation functions (no DB calls):
export function computeNilSpendByPosition(
  entries: NilEntry[],
  players: Map<string, { position: string }>
): { position: string; total: number }[]
  // Returns array sorted by total desc, usable as recharts BarChart data

export function computeNilSpendByYear(entries: NilEntry[]): { year: number; total: number }[]
  // Groups by startYear, sorted by year asc
```

Note: NilEntry type from @dynasty-os/core-types was scaffolded in Phase 10 with fields: id, dynastyId, playerId, amount (number), brand (string), startYear (number), endYear (number, optional), createdAt, updatedAt. Verify the actual type shape from the package before writing service — use whatever fields exist.

Create `apps/desktop/src/store/nil-store.ts` following coaching-staff-store pattern:

- State: `entries: NilEntry[]`, `loading: boolean`
- Actions: `loadEntries(dynastyId)`, `addEntry(input, dynastyId)`, `removeEntry(id, dynastyId)`
- `removeEntry`: push undo before delete, toast on success
- After every mutation: `loadEntries(dynastyId)` to re-sync
  </action>
  <verify>
    <automated>cd /Users/chanmoore/dev/dynasty-os && pnpm --filter @dynasty-os/desktop build 2>&1 | tail -5</automated>
    <manual>recharts appears in apps/desktop/package.json; nil-service.ts and nil-store.ts exist and export expected symbols</manual>
  </verify>
  <done>recharts@^3.x in apps/desktop/package.json; nil-service.ts exports 7 functions; nil-store.ts exports useNilStore; build exits 0</done>
</task>

<task type="auto">
  <name>Task 2: NilLedgerPage + navigation registration</name>
  <files>
    apps/desktop/src/pages/NilLedgerPage.tsx
    apps/desktop/src/store/navigation-store.ts
    apps/desktop/src/App.tsx
    apps/desktop/src/components/CommandPalette.tsx
  </files>
  <action>
Create `apps/desktop/src/pages/NilLedgerPage.tsx`:

- CFB sport guard at top: `if (!activeDynasty || activeDynasty.sport !== 'cfb') return null;`
- On mount: load entries via `useNilStore.loadEntries(activeDynasty.id)` and load players via `usePlayerStore` for the player picker
- Layout: page header ("NIL Ledger") + two sections:
  1. **Log Deal form**: player picker (select from active roster using usePlayerStore), brand (text), amount (number), startYear (number), endYear (number, optional) → submit calls `addEntry`
  2. **Deal Log table**: all entries sorted by startYear desc — columns: Player Name, Brand, Amount, Start Year, End Year, Delete button
  3. **Spend Breakdown charts** (recharts, below the table):
     - BarChart "Spend by Position" using `computeNilSpendByPosition` result — `<BarChart data={...}><XAxis dataKey="position" /><YAxis /><Bar dataKey="total" fill="#d97706" /></BarChart>`
     - BarChart "Spend by Year" using `computeNilSpendByYear` result — same pattern, `dataKey="year"` on XAxis, `dataKey="total"` on Bar
     - Both charts: `<ResponsiveContainer width="100%" height={200}>` wrapping the BarChart
     - Only render charts if entries.length > 0 (empty state: "No NIL deals logged yet")
- Delete button calls `removeEntry` — undo available
- Tailwind: dark-mode consistent, amber accent color for NIL financial data (matches existing amber pattern for AI/financial features)

Update navigation-store.ts:
- Add `'nil-ledger'` to Page union
- Add `goToNilLedger: () => void` to NavigationActions and implement it

Update App.tsx:
- Import NilLedgerPage
- Add `case 'nil-ledger': return <NilLedgerPage />;`

Update CommandPalette.tsx:
- Add entry: `{ id: 'nav-nil-ledger', label: 'NIL Ledger', description: 'Track NIL deals', group: 'Navigation', action: () => goToNilLedger() }`
- CFB-gate this entry: only include when `activeDynasty?.sport === 'cfb'` (check how existing CFB entries like 'recruiting' are gated in CommandPalette.tsx)
  </action>
  <verify>
    <automated>cd /Users/chanmoore/dev/dynasty-os && pnpm --filter @dynasty-os/desktop build 2>&1 | tail -5</automated>
    <manual>For CFB dynasty: navigate to NIL Ledger, add a deal, verify bar charts render; for Madden dynasty: page returns null (not visible)</manual>
  </verify>
  <done>NilLedgerPage renders for CFB, returns null for Madden; recharts BarCharts show spend by position and year; navigation-store has nil-ledger; App.tsx switch routes correctly; CommandPalette CFB-gated entry present; build exits 0</done>
</task>

</tasks>

<verification>
cd /Users/chanmoore/dev/dynasty-os && pnpm --filter @dynasty-os/desktop build 2>&1 | grep -E "(error|warning|✓|built)" | tail -10
</verification>

<success_criteria>
- recharts@^3.x in apps/desktop/package.json
- nil-service.ts has createNilEntry, getNilEntriesByDynasty, getNilEntriesByPlayer, computeNilSpendByPosition, computeNilSpendByYear
- nil-store.ts exports useNilStore
- NilLedgerPage.tsx renders CFB-only with deal log table + recharts BarCharts
- navigation-store.ts has 'nil-ledger' and goToNilLedger
- App.tsx has case 'nil-ledger'
- CommandPalette.tsx has CFB-gated NIL Ledger entry
- pnpm build exits 0
</success_criteria>

<output>
After completion, create `.planning/phases/12-community-features/12-02-SUMMARY.md`
</output>
