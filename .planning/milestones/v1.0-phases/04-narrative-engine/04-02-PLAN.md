---
phase: 04-narrative-engine
plan: "02"
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - apps/desktop/src/pages/SeasonRecapPage.tsx
  - apps/desktop/src/store/navigation-store.ts
  - apps/desktop/src/App.tsx
  - apps/desktop/src/pages/DashboardPage.tsx
autonomous: false

must_haves:
  truths:
    - "User can navigate to the Season Recap page from the dashboard Actions panel"
    - "User can select a tone preset (ESPN National Desk, Hometown Beat Reporter, Dynasty Mode Legend) before generating"
    - "User sees a loading state while the narrative generates"
    - "Generated recap displays as 2-3 paragraphs with the 3-word tagline prominently shown"
    - "User can refresh/regenerate the narrative with a different tone or the same tone"
    - "If no API key is set, the page shows a prompt to set the API key (same pattern as Legacy Card settings)"
    - "Previously generated narrative loads from cache instantly on revisit"
  artifacts:
    - path: "apps/desktop/src/pages/SeasonRecapPage.tsx"
      provides: "Season wrap-up screen with tone selector, generate button, recap display, tagline"
      min_lines: 100
    - path: "apps/desktop/src/store/navigation-store.ts"
      provides: "Updated Page type and goToSeasonRecap navigation helper"
    - path: "apps/desktop/src/App.tsx"
      provides: "season-recap case in navigation switch"
    - path: "apps/desktop/src/pages/DashboardPage.tsx"
      provides: "Season Recap button in Actions panel"
  key_links:
    - from: "apps/desktop/src/pages/SeasonRecapPage.tsx"
      to: "apps/desktop/src/store/narrative-store.ts"
      via: "useNarrativeStore for state and actions"
      pattern: "useNarrativeStore"
    - from: "apps/desktop/src/pages/DashboardPage.tsx"
      to: "apps/desktop/src/store/navigation-store.ts"
      via: "goToSeasonRecap() in Actions panel button"
      pattern: "goToSeasonRecap"
    - from: "apps/desktop/src/App.tsx"
      to: "apps/desktop/src/pages/SeasonRecapPage.tsx"
      via: "case 'season-recap' in switch"
      pattern: "season-recap"
---

<objective>
Build the Season Recap page UI — tone selector, generate/refresh flow, cached recap display, tagline display, and wire it into the app navigation from the dashboard.

Purpose: This is the user-facing surface for the narrative engine. The coach picks a tone, hits generate, and sees their season transformed into a story. The page must feel polished — the narrative is the emotional payoff of all the data entry.

Output: SeasonRecapPage.tsx (full page component), updated navigation-store.ts (new page type), updated App.tsx (routing), updated DashboardPage.tsx (entry point button).
</objective>

<execution_context>
@/Users/chanmoore/.claude/get-shit-done/workflows/execute-plan.md
@/Users/chanmoore/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-narrative-engine/04-01-SUMMARY.md

@apps/desktop/src/store/navigation-store.ts
@apps/desktop/src/App.tsx
@apps/desktop/src/pages/DashboardPage.tsx
@apps/desktop/src/store/index.ts
@packages/core-types/src/season.ts
@packages/core-types/src/dynasty.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add season-recap page to navigation and app routing</name>
  <files>apps/desktop/src/store/navigation-store.ts, apps/desktop/src/App.tsx, apps/desktop/src/pages/DashboardPage.tsx</files>
  <action>
**navigation-store.ts:**
- Add `'season-recap'` to the `Page` type union: `type Page = 'dashboard' | 'roster' | 'player-profile' | 'legends' | 'records' | 'season-recap';`
- Add `goToSeasonRecap: (seasonId: string) => void` to NavigationActions interface
- Implement: `goToSeasonRecap: (seasonId: string) => { set({ currentPage: 'season-recap', pageParams: { seasonId } }); }`

**App.tsx:**
- Import `SeasonRecapPage` from `./pages/SeasonRecapPage`
- Add case to switch: `case 'season-recap': return <SeasonRecapPage />;`

**DashboardPage.tsx:**
- Add a "Season Recap" button to the Actions panel, placed after "End Season" and before "Manage Roster". Style it distinctly — use a gold/amber accent (`bg-amber-600 hover:bg-amber-500`) to signal it's the narrative feature, differentiating it from the blue/gray action buttons.
- onClick: `useNavigationStore.getState().goToSeasonRecap(activeSeason.id)`
- Only show this button when `activeSeason` exists (it's already inside the `activeSeason &&` conditional block, so this is automatic).
  </action>
  <verify>
Run `npx tsc --noEmit` from apps/desktop to confirm types compile. Verify "season-recap" appears in navigation-store.ts Page type. Verify SeasonRecapPage import exists in App.tsx.
  </verify>
  <done>
Navigation store has 'season-recap' page type and goToSeasonRecap helper. App.tsx routes to SeasonRecapPage. DashboardPage has amber "Season Recap" button in Actions panel. TypeScript compiles (even if SeasonRecapPage component is a placeholder — Task 2 creates the full component).
  </done>
</task>

<task type="auto">
  <name>Task 2: Build SeasonRecapPage with tone selector, generate flow, and cached display</name>
  <files>apps/desktop/src/pages/SeasonRecapPage.tsx</files>
  <action>
Create `SeasonRecapPage.tsx` as a full page component:

**Layout (dark theme, consistent with other pages like RecordsPage, PlayerProfilePage):**
- Header with back button (goToDashboard), title "Season Recap", and the season year + team name
- If no API key set (check via `getApiKey()` from legacy-card-service.ts): show API key setup prompt with input field and save button (same pattern as Legacy Card settings in LegendsPage or PlayerProfilePage). Use `setApiKey()` to save.

**Tone Selector Section:**
- Three tone option cards displayed horizontally (or stacked on small screens):
  1. **ESPN National Desk** — icon/emoji-free label, short description: "Authoritative national broadcast perspective"
  2. **Hometown Beat Reporter** — description: "Warm community-focused local coverage"
  3. **Dynasty Mode Legend** — description: "Epic dynasty-builder narrative"
- Selected tone highlighted with a ring/border (e.g., `ring-2 ring-amber-500`)
- Default selection: 'espn'

**Generate Button:**
- "Generate Season Recap" button (amber/gold, `bg-amber-600 hover:bg-amber-500`)
- When loading: show spinner and "Generating your season story..." text, disable button
- When narrative exists: button text changes to "Regenerate" and shows the current tone label

**Recap Display (shown when narrative exists):**
- **Tagline** displayed prominently at the top in large text (text-2xl or text-3xl, font-bold, text-amber-400 or amber-300). Format: three words, capitalized.
- **Recap paragraphs** below the tagline. Use `whitespace-pre-line` or split by `\n\n` to render paragraphs with proper spacing. Style: text-gray-200, leading-relaxed, max-w-3xl for comfortable reading width.
- **Tone badge** showing which tone was used (small pill: "ESPN National Desk" / "Hometown Beat" / "Legend")
- **Generated timestamp** in small gray text: "Generated on [date]"

**Refresh Flow:**
- User can change tone selection even after generating
- Clicking "Regenerate" calls `useNarrativeStore.getState().generate(dynasty, season, selectedTone, true)` with forceRefresh=true
- This overwrites the cached narrative with the new tone

**On Mount:**
- Read seasonId from `useNavigationStore.getState().pageParams.seasonId`
- Call `useNarrativeStore.getState().loadCachedNarrative(seasonId)` to check for existing cached narrative
- If cached narrative exists, display it immediately (no API call). Set the tone selector to match the cached tone.
- Get dynasty from `useDynastyStore` and season from `useSeasonStore` (or load season by ID if needed)

**Error State:**
- If error from store: show error message in red text with a "Try Again" button
- If narrative is null after generate (API failure): show graceful message "Could not generate recap. Check your API key and try again."

**Season Summary Context (shown above or beside the recap):**
- Small summary card showing: Year, Record (W-L), Conference Record, Final Ranking, Bowl/Playoff result
- This gives the user context for what the AI is working with

**Imports:**
- `useNarrativeStore` from store
- `useDynastyStore` from store
- `useSeasonStore` from store
- `useNavigationStore` from store
- `getApiKey, setApiKey` from legacy-card-service
- `NarrativeTone` type from narrative-service

**Constraints:**
- Follow the dark theme pattern (bg-gray-900 text-white, bg-gray-800 cards)
- Back navigation uses goToDashboard()
- No new stores or services — only consume what Plan 04-01 created
  </action>
  <verify>
Run `npx tsc --noEmit` from apps/desktop. Verify SeasonRecapPage.tsx renders with tone selector, generate button, and recap display area. Verify it imports useNarrativeStore.
  </verify>
  <done>
SeasonRecapPage.tsx exists as a full page with: tone selector (3 options), generate/regenerate button with loading state, tagline display, recap paragraphs display, API key setup prompt when no key, cached narrative loads on mount, season summary context card. Page is wired into navigation and accessible from dashboard.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete Season Recap flow: tone selection, AI generation via Claude Sonnet, tagline parsing, cached display, regeneration with different tones. Accessible from Dashboard Actions panel via amber "Season Recap" button.
  </what-built>
  <how-to-verify>
1. Run `pnpm tauri dev` and navigate to a dynasty with at least one season with games logged
2. Click "Season Recap" in the dashboard Actions panel — should navigate to the Season Recap page
3. If no API key is set, verify the API key input prompt appears. Enter your Anthropic API key and save.
4. Select "ESPN National Desk" tone (should be default) and click "Generate Season Recap"
5. Verify: loading state appears while generating
6. Verify: a 2-3 paragraph recap appears with a 3-word tagline displayed prominently
7. Verify: the recap reads like a national sports broadcast (authoritative, stats-driven)
8. Switch to "Hometown Beat Reporter" tone and click "Regenerate"
9. Verify: new recap has a distinctly different voice (warm, community-focused, personal)
10. Switch to "Dynasty Mode Legend" tone and click "Regenerate"
11. Verify: new recap is epic/mythic in tone (dynasty-builder narrative, dramatic)
12. Navigate away (Back to Dashboard) and then return to Season Recap page
13. Verify: the last generated recap loads instantly from cache (no API call, no loading state)
14. Verify: the cached tone matches the tone that was last generated
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
1. `cd apps/desktop && npx tsc --noEmit` — zero type errors
2. Navigation: 'season-recap' in Page type, goToSeasonRecap in navigation-store, case in App.tsx switch
3. Dashboard: amber "Season Recap" button visible in Actions panel
4. SeasonRecapPage: tone selector with 3 options, generate button, recap display, tagline display
5. Cache: revisiting the page loads cached narrative immediately
6. API key: graceful prompt when missing, reuses getApiKey()/setApiKey() from legacy-card-service
7. Error: graceful error display on API failure
</verification>

<success_criteria>
- Season Recap page is accessible from Dashboard and renders correctly
- Three tone presets are selectable and produce visually distinct UI state
- Generate button triggers API call with loading state
- Tagline displays in large prominent text
- Recap paragraphs render with comfortable reading layout
- Cached narrative loads instantly on page revisit
- API key prompt appears when key is not set
- Regenerate overwrites cache with new tone/content
</success_criteria>

<output>
After completion, create `.planning/phases/04-narrative-engine/04-02-SUMMARY.md`
</output>
