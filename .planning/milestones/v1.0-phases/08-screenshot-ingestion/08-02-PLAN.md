---
phase: 08-screenshot-ingestion
plan: 02
type: execute
wave: 2
depends_on: [08-01]
files_modified:
  - apps/desktop/src/pages/ScreenshotIngestionPage.tsx
  - apps/desktop/src/store/navigation-store.ts
  - apps/desktop/src/pages/DashboardPage.tsx
  - apps/desktop/src/App.tsx
autonomous: false
requirements: [INGST-04, INGST-05, INGST-06]

must_haves:
  truths:
    - "User clicks 'Parse Screenshot' amber button on Dashboard and lands on ScreenshotIngestionPage"
    - "User selects a screen type from a dropdown (Schedule, Player Stats, Recruiting, Depth Chart) BEFORE picking a file"
    - "After screen type selection, user clicks a file picker button that opens the OS file dialog via Tauri dialog:allow-open — image preview appears immediately after selection"
    - "User clicks Parse to send the image to Claude Vision API; a spinner shows 'Parsing screenshot...' during the 3-8s call"
    - "Pre-populated confirmation form appears with AI-parsed fields highlighted in amber (bg-amber-900/20 border-amber-600/50); blank fields are amber-tinted but empty — no '?' indicators"
    - "User can edit any field inline before saving; Discard returns to Dashboard without saving"
    - "API failure shows error message and Retry button; API key missing shows the same getApiKey() prompt pattern used by Legacy Cards and Season Recap"
    - "Parse Screenshot button is CFB-only (inside activeDynasty.sport === 'cfb' guard in Dashboard CFB Program section)"
  artifacts:
    - path: "apps/desktop/src/pages/ScreenshotIngestionPage.tsx"
      provides: "Full page: screen type picker, file open, image preview, Vision API call with spinner, confirmation form with amber-tinted fields, Discard button"
      min_lines: 200
    - path: "apps/desktop/src/store/navigation-store.ts"
      provides: "'screenshot-ingestion' added to Page type union; goToScreenshotIngestion() action added"
      contains: "screenshot-ingestion"
    - path: "apps/desktop/src/pages/DashboardPage.tsx"
      provides: "Amber 'Parse Screenshot' button in CFB Program section"
      contains: "Parse Screenshot"
    - path: "apps/desktop/src/App.tsx"
      provides: "Routing case for 'screenshot-ingestion' returning <ScreenshotIngestionPage />"
      contains: "ScreenshotIngestionPage"
  key_links:
    - from: "apps/desktop/src/pages/ScreenshotIngestionPage.tsx"
      to: "apps/desktop/src/lib/screenshot-service.ts"
      via: "parseScreenshot(screenType, imageBase64, {teamName, season}) import"
      pattern: "parseScreenshot"
    - from: "apps/desktop/src/pages/ScreenshotIngestionPage.tsx"
      to: "@tauri-apps/plugin-dialog open()"
      via: "open({ filters: [{name: 'Images', extensions: ['png','jpg','jpeg']}] })"
      pattern: "open\\("
    - from: "apps/desktop/src/pages/DashboardPage.tsx"
      to: "apps/desktop/src/store/navigation-store.ts"
      via: "useNavigationStore.getState().goToScreenshotIngestion()"
      pattern: "goToScreenshotIngestion"
---

<objective>
Build the ScreenshotIngestionPage UI and wire it into the Dashboard, navigation store, and App.tsx — completing the full user flow: screen type selection -> file pick -> image preview -> Vision API parse with spinner -> amber-highlighted confirmation form -> save or discard.

Purpose: This plan delivers the visible, user-facing requirement. The service from 08-01 is the engine; this is the cockpit.
Output: ScreenshotIngestionPage.tsx, navigation wiring, Dashboard entry point, App.tsx routing.
</objective>

<execution_context>
@/Users/chanmoore/.claude/get-shit-done/workflows/execute-plan.md
@/Users/chanmoore/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-screenshot-ingestion/08-CONTEXT.md
@.planning/phases/08-screenshot-ingestion/08-01-SUMMARY.md
@apps/desktop/src/pages/TrophyRoomPage.tsx
@apps/desktop/src/pages/SeasonRecapPage.tsx
@apps/desktop/src/store/navigation-store.ts
@apps/desktop/src/App.tsx
@apps/desktop/src/pages/DashboardPage.tsx
@apps/desktop/src/lib/screenshot-service.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Navigation wiring — add screenshot-ingestion to store and App.tsx routing</name>
  <files>
    apps/desktop/src/store/navigation-store.ts
    apps/desktop/src/App.tsx
  </files>
  <action>
**navigation-store.ts:**
1. Add 'screenshot-ingestion' to the Page type union (after 'coaching-resume')
2. Add goToScreenshotIngestion() to NavigationActions interface
3. Add implementation in the create() body:
   ```typescript
   goToScreenshotIngestion: () => {
     set({ currentPage: 'screenshot-ingestion', pageParams: {} });
   },
   ```

**App.tsx:**
1. Add import: `import { ScreenshotIngestionPage } from './pages/ScreenshotIngestionPage';`
2. Add case before `default:`:
   ```typescript
   case 'screenshot-ingestion':
     return <ScreenshotIngestionPage />;
   ```

Create a minimal stub for ScreenshotIngestionPage.tsx (just enough to compile — full implementation in Task 2):
- `export function ScreenshotIngestionPage() { return <div>Loading...</div>; }`
- Save at apps/desktop/src/pages/ScreenshotIngestionPage.tsx
  </action>
  <verify>
    <automated>cd /Users/chanmoore/dev/dynasty-os && pnpm --filter @dynasty-os/desktop exec tsc --noEmit 2>&1 | tail -5</automated>
  </verify>
  <done>
    - navigation-store.ts Page union includes 'screenshot-ingestion'
    - goToScreenshotIngestion() action exists in store
    - App.tsx has case 'screenshot-ingestion' routing to ScreenshotIngestionPage
    - TypeScript compiles with zero errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Full ScreenshotIngestionPage implementation and Dashboard button</name>
  <files>
    apps/desktop/src/pages/ScreenshotIngestionPage.tsx
    apps/desktop/src/pages/DashboardPage.tsx
  </files>
  <action>
**ScreenshotIngestionPage.tsx — Full Implementation**

The page uses `useState` for: screenType (ScreenType | ''), imagePath (string | null), imageBase64 (string | null), parsedData (ParsedScreenData | null), loading (boolean), error (string | null), apiKeyMissing (boolean).

Layout follows the established page pattern (same as TrophyRoomPage, SeasonRecapPage):
```
min-h-screen bg-gray-900 text-white
  header: border-b border-gray-800 px-6 py-4
    max-w-4xl mx-auto flex items-center gap-4
      [back arrow button] → goToDashboard()
      h1: "Parse Screenshot"
  main: max-w-4xl mx-auto px-6 py-8 space-y-6
    [content sections]
```

**Section 1: Screen Type + File Selection (shown when parsedData is null and loading is false)**

```
Step 1 label: "1. Select Screen Type"
  <select> dropdown with options:
    <option value="">-- Select a screen type --</option>
    <option value="schedule">Schedule / Game Results</option>
    <option value="player-stats">Player Stats</option>
    <option value="recruiting">Recruiting Class</option>
    <option value="depth-chart">Depth Chart</option>
  className: bg-gray-800 border border-gray-700 text-white rounded-lg px-3 py-2 w-full

Step 2 label: "2. Select Screenshot" (only enabled when screenType is selected — button disabled + opacity-50 when no screenType)
  <button> "Choose Image File"
    onClick: call handleFileOpen()
    className: bg-gray-700 hover:bg-gray-600 px-4 py-2.5 rounded-lg text-sm font-semibold (disabled: opacity-50 cursor-not-allowed)
```

`handleFileOpen()` implementation:
```typescript
import { open } from '@tauri-apps/plugin-dialog';
import { readFile } from '@tauri-apps/plugin-fs';

async function handleFileOpen() {
  const selected = await open({
    filters: [{ name: 'Images', extensions: ['png', 'jpg', 'jpeg', 'webp'] }],
    multiple: false,
  });
  if (!selected || typeof selected !== 'string') return;
  setImagePath(selected);
  // Read file as bytes and convert to base64
  const bytes = await readFile(selected);
  const binary = Array.from(bytes).map(b => String.fromCharCode(b)).join('');
  const base64 = btoa(binary);
  setImageBase64(base64);
}
```

**Image Preview (shown when imagePath is set and parsedData is null)**
```
Step 3 label: "3. Preview & Parse"
  <img src={imagePath} alt="Screenshot preview" className="w-full max-h-96 object-contain rounded-lg border border-gray-700" />
  Two buttons side by side:
    "Discard" → goToDashboard() — className: bg-gray-700 hover:bg-gray-600 px-4 py-2.5 rounded-lg
    "Parse Screenshot" → handleParse() — className: bg-amber-600 hover:bg-amber-500 px-4 py-2.5 rounded-lg font-semibold
```

`handleParse()`:
```typescript
async function handleParse() {
  if (!imageBase64 || !screenType) return;
  const apiKey = getApiKey();
  if (!apiKey) { setApiKeyMissing(true); return; }
  setLoading(true);
  setError(null);
  try {
    const result = await parseScreenshot(
      screenType as ScreenType,
      imageBase64,
      { teamName: activeDynasty.name, season: String(activeSeason?.year ?? '') }
    );
    if (!result) throw new Error('Vision API returned no data');
    setParsedData(result);
  } catch (e) {
    setError(e instanceof Error ? e.message : 'Failed to parse screenshot');
  } finally {
    setLoading(false);
  }
}
```

**Loading State (shown when loading is true)**
```
Centered spinner + text:
  <div className="flex flex-col items-center gap-4 py-16">
    <div className="w-8 h-8 border-2 border-amber-500 border-t-transparent rounded-full animate-spin" />
    <p className="text-gray-400">Parsing screenshot...</p>
  </div>
```

**API Key Missing State (shown when apiKeyMissing is true)**
```
<div className="bg-gray-800 rounded-lg p-6">
  <p className="text-gray-300 mb-4">Anthropic API key required for screenshot parsing.</p>
  <input type="password" placeholder="Enter API key (sk-ant-...)" onChange handling />
  <button onClick={() => { setApiKey(enteredKey); setApiKeyMissing(false); }}>Save Key</button>
  <button onClick={() => goToDashboard()}>Cancel</button>
</div>
```
Use local state for the key input. Call setApiKey() from legacy-card-service on save.

**Error State (shown when error is non-null)**
```
<div className="bg-red-900/20 border border-red-600/50 rounded-lg p-4 flex items-center justify-between">
  <p className="text-red-400 text-sm">{error}</p>
  <button onClick={handleParse} className="bg-gray-700 hover:bg-gray-600 px-3 py-1.5 text-sm rounded">Retry</button>
</div>
```

**Confirmation Form (shown when parsedData is not null)**

The amber highlight class for AI-parsed fields: `bg-amber-900/20 border-amber-600/50`
The neutral field class: `bg-gray-700 border-gray-600`

Base input class: `w-full rounded-lg px-3 py-2 text-white text-sm border focus:outline-none focus:ring-1 focus:ring-amber-500`

Render different form layouts per screenType. Use local state (editedData) initialized from parsedData for editable fields.

**Schedule form** — show a table of game rows; each row has:
- Week (number input, amber)
- Opponent (text input, amber)
- Home/Away (select: Home/Away/Neutral, amber)
- Team Score (number input, amber)
- Opp Score (number input, amber)
- Result badge (derived from scores or parsed, display-only if both scores present)
- Game Type (text input, amber)
- Delete row button (red)

Add Row button below the table.

Save button: "Log Games" — for each game row with valid opponent + team score + opp score, call createGame() from game-service with the mapped data. After all saves, goToDashboard().

Note: createGame() signature: `createGame(dynastyId, seasonId, {opponent, homeAway, teamScore, opponentScore, result, gameType, week})`. Use activeDynasty.id and activeSeason.id. Map homeAway 'Home'→'home', 'Away'→'away', 'Neutral'→'neutral'.

**Player Stats form** — show player rows each with:
- Name (text, amber)
- Position (text, amber)
- Dynamic stat fields: render each key in stats as a labeled input (amber)
- Delete row button

Save: for each player row with a name, open PlayerProfilePage or log a note — actually for Phase 8, player stat save navigates to PlayerProfilePage with the player name pre-filled in a note. SIMPLER APPROACH: after user reviews, clicking "Go to Player Stats" navigates to RosterPage so user can find the player and log stats manually. Player stats parsing is purely for display/review in Phase 8 — the data model requires finding the player by name first. Show a note: "Review parsed data and log stats for each player from the Roster." Include a "Return to Dashboard" button. Do NOT attempt to auto-create player season stats — the player must exist in the roster first.

**Recruiting Class form** — show recruits table with:
- Name (text, amber)
- Position (text, amber)
- Stars (number 1-5, amber)
- State (text, amber)
- National Rank (number, amber)
- Delete row button

Plus class-level fields: Class Rank (number, amber), Total Commits (number, amber).

Save: call createRecruitingClass() and createRecruitEntry() from recruiting-service — check what the actual function signatures are. If current season is needed, use activeSeason. After save, goToDashboard().

**Depth Chart form** — show entries table with:
- Position (text, amber)
- Player Name (text, amber)
- Depth (number, amber)
- Delete row button

Save: depth chart is display-only in V1 (no depth chart table in DB schema). Show a note: "Review parsed depth chart below. Use this to reference your roster assignments." Include "Return to Dashboard" button only — no save to DB for depth chart.

**All forms share:**
- "Discard" button (top-right or bottom): returns to Dashboard, no save
- Screenshot thumbnail shown above the form (small, max-h-32, collapsed view)
- Section heading showing the screen type name

**DashboardPage.tsx:**

Add "Parse Screenshot" amber button inside the `activeDynasty.sport === 'cfb'` CFB Program section (after the existing "Program Timeline" button):
```tsx
<button
  onClick={() => useNavigationStore.getState().goToScreenshotIngestion()}
  className="w-full px-4 py-2.5 bg-amber-600 hover:bg-amber-500 text-white text-sm font-semibold rounded-lg transition-colors"
>
  Parse Screenshot
</button>
```

**Imports needed in ScreenshotIngestionPage.tsx:**
```typescript
import React, { useState } from 'react';
import { open } from '@tauri-apps/plugin-dialog';
import { readFile } from '@tauri-apps/plugin-fs';
import { useDynastyStore, useSeasonStore } from '../store';
import { useNavigationStore } from '../store/navigation-store';
import { parseScreenshot, ScreenType, ParsedScreenData, SCREEN_TYPE_LABELS } from '../lib/screenshot-service';
import { getApiKey, setApiKey } from '../lib/legacy-card-service';
// conditional imports per screen type forms:
import { createGame } from '../lib/game-service';         // schedule save
// recruiting-service for recruiting save
```
  </action>
  <verify>
    <automated>cd /Users/chanmoore/dev/dynasty-os && pnpm --filter @dynasty-os/desktop exec tsc --noEmit 2>&1 | tail -10</automated>
    <manual>Visually inspect ScreenshotIngestionPage.tsx: confirm back button, screen type dropdown, file picker button, image preview area, loading spinner markup, amber field classes, Discard button are all present in the JSX.</manual>
  </verify>
  <done>
    - ScreenshotIngestionPage.tsx is fully implemented (not a stub)
    - Screen type dropdown renders all 4 options; file picker is disabled until type is selected
    - Amber field highlight classes (bg-amber-900/20 border-amber-600/50) applied to all parsed inputs
    - Loading spinner with "Parsing screenshot..." shown during API call
    - Error state shows error message + Retry button
    - API key missing state shows key entry form using getApiKey()/setApiKey() pattern
    - Schedule screen type: game rows saveable via createGame()
    - Recruiting screen type: class saveable via recruiting-service
    - Player stats + depth chart: display-only with explanation and Dashboard return
    - DashboardPage has "Parse Screenshot" amber button in CFB Program section
    - TypeScript compiles with zero errors
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify screenshot ingestion flow end-to-end</name>
  <action>Human visual verification of the complete screenshot ingestion UX — no automated action required.</action>
  <what-built>
    Full screenshot ingestion flow: amber "Parse Screenshot" button on Dashboard (CFB only) → ScreenshotIngestionPage with screen type picker, OS file dialog, image preview, Vision API call with spinner, confirmation form with amber-highlighted pre-populated fields, save/discard paths.
  </what-built>
  <how-to-verify>
    1. Launch the app with a CFB dynasty active
    2. Confirm "Parse Screenshot" amber button appears in the CFB Program section of the Dashboard Actions panel
    3. Click "Parse Screenshot" — confirm ScreenshotIngestionPage loads with back arrow, page title, and screen type dropdown
    4. Select "Schedule / Game Results" from the dropdown
    5. Click "Choose Image File" — confirm OS file dialog opens filtered to image types (png/jpg/jpeg/webp)
    6. Select any PNG/JPG image (can be any test image)
    7. Confirm image preview renders below the file picker
    8. If you have an Anthropic API key configured: click "Parse Screenshot" and confirm spinner with "Parsing screenshot..." appears
    9. After parse (or with any JSON result): confirm form renders with amber-tinted input fields
    10. Confirm "Discard" button returns to Dashboard without saving
    11. Without an API key: confirm API key missing state shows key entry form
    12. Verify the back arrow also returns to Dashboard
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe any issues to fix</resume-signal>
</task>

</tasks>

<verification>
- `pnpm --filter @dynasty-os/desktop exec tsc --noEmit` passes with zero errors
- ScreenshotIngestionPage.tsx exists and is fully implemented (not a stub)
- navigation-store.ts has 'screenshot-ingestion' in Page union and goToScreenshotIngestion() action
- App.tsx routes 'screenshot-ingestion' to ScreenshotIngestionPage
- DashboardPage.tsx has "Parse Screenshot" button inside the CFB sport guard
- Checkpoint approved by user
</verification>

<success_criteria>
1. CFB coach can click "Parse Screenshot" from Dashboard and complete the full upload → parse → review → save flow
2. Amber field highlighting makes AI-parsed values visually distinct from blank fields
3. Discard escape hatch works from both pre-parse and post-parse states
4. API key missing state gracefully prompts for key using existing pattern
5. Schedule and recruiting screen types save data to DB; player stats and depth chart display parsed data with clear instructions
6. All requirements INGST-04, INGST-05, INGST-06 satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/08-screenshot-ingestion/08-02-SUMMARY.md`
</output>
