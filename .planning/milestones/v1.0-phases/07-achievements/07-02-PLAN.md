---
phase: 07-achievements
plan: "02"
type: execute
wave: 2
depends_on:
  - "07-01"
files_modified:
  - apps/desktop/src/lib/game-service.ts
  - apps/desktop/src/lib/season-service.ts
  - apps/desktop/src/pages/TrophyRoomPage.tsx
  - apps/desktop/src/pages/CoachingResumePage.tsx
  - apps/desktop/src/store/navigation-store.ts
  - apps/desktop/src/pages/DashboardPage.tsx
  - apps/desktop/src/App.tsx
autonomous: true
requirements:
  - ACHV-01
  - ACHV-02
  - ACHV-03

must_haves:
  truths:
    - "After logging a game win, evaluateAchievements fires automatically and win-count achievements unlock"
    - "After recording season-end data (bowl result, playoff result), bowl/championship achievements evaluate"
    - "User can navigate to Trophy Room from the Dashboard and see earned achievements grouped by category"
    - "Trophy Room shows unearned achievements as locked (grayed out) with a lock indicator"
    - "Coaching Resume shows overall career W-L record, win percentage, bowl record (W-L), total championships, and total seasons coached"
    - "Both Trophy Room and Coaching Resume are sport-agnostic (visible for CFB and Madden dynasties)"
  artifacts:
    - path: "apps/desktop/src/pages/TrophyRoomPage.tsx"
      provides: "Trophy room UI with earned/locked achievement cards grouped by category"
      min_lines: 80
    - path: "apps/desktop/src/pages/CoachingResumePage.tsx"
      provides: "Career stats aggregation view with overall record, win%, bowl record, championships"
      min_lines: 60
    - path: "apps/desktop/src/lib/game-service.ts"
      provides: "evaluateAchievements hook after createGame()"
      contains: "evaluateAchievements"
    - path: "apps/desktop/src/lib/season-service.ts"
      provides: "evaluateAchievements hook after updateSeason()"
      contains: "evaluateAchievements"
  key_links:
    - from: "apps/desktop/src/lib/game-service.ts"
      to: "apps/desktop/src/lib/achievement-service.ts"
      via: "evaluateAchievements(input.dynastyId) called after recalculateSeasonRecord"
      pattern: "evaluateAchievements\\("
    - from: "apps/desktop/src/lib/season-service.ts"
      to: "apps/desktop/src/lib/achievement-service.ts"
      via: "evaluateAchievements(dynastyId) called at end of updateSeason after DB write"
      pattern: "evaluateAchievements\\("
    - from: "apps/desktop/src/pages/TrophyRoomPage.tsx"
      to: "apps/desktop/src/store/achievement-store.ts"
      via: "useAchievementStore loadAchievements on mount"
      pattern: "loadAchievements"
    - from: "apps/desktop/src/pages/CoachingResumePage.tsx"
      to: "packages/db/src/dynasty-db.ts"
      via: "direct db queries for seasons and games aggregation"
      pattern: "db\\.(seasons|games)\\.where"
---

<objective>
Hook evaluateAchievements() into the two save-event paths (game logging and season-end update), then build TrophyRoomPage and CoachingResumePage with Dashboard navigation wiring.

Purpose: This closes the loop — achievements unlock automatically as users log games and seasons, the Trophy Room surfaces earned milestones, and the Coaching Resume gives a career-level stats overview. All three requirements (ACHV-01, ACHV-02, ACHV-03) land here.

Output: Save hooks in service layer, TrophyRoomPage, CoachingResumePage, navigation wiring, Dashboard buttons.
</objective>

<execution_context>
@/Users/chanmoore/.claude/get-shit-done/workflows/execute-plan.md
@/Users/chanmoore/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-achievements/07-01-SUMMARY.md

@apps/desktop/src/lib/game-service.ts
@apps/desktop/src/lib/season-service.ts
@apps/desktop/src/lib/achievement-service.ts
@apps/desktop/src/store/achievement-store.ts
@packages/core-types/src/achievement.ts
@packages/core-types/src/season.ts
@apps/desktop/src/store/navigation-store.ts
@apps/desktop/src/pages/DashboardPage.tsx
@apps/desktop/src/App.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Hook evaluateAchievements into game-service and season-service</name>
  <files>
    apps/desktop/src/lib/game-service.ts
    apps/desktop/src/lib/season-service.ts
  </files>
  <action>
**1. Update `apps/desktop/src/lib/game-service.ts`:**

Add import at top: `import { evaluateAchievements } from './achievement-service';`

In `createGame()`, after `await recalculateSeasonRecord(input.seasonId);`, add:
```ts
// Fire achievement evaluation as a background task — never blocks game creation
evaluateAchievements(input.dynastyId).catch(() => {});
```

Do NOT add evaluateAchievements to updateGame() or deleteGame() — wins cannot be retroactively added by editing, so these paths don't trigger new unlocks. Only createGame() changes the win total upward.

**2. Update `apps/desktop/src/lib/season-service.ts`:**

Add import at top: `import { evaluateAchievements } from './achievement-service';`

In `updateSeason()`, the function currently has signature:
`async function updateSeason(id: string, updates: Partial<Omit<Season, 'id' | 'dynastyId' | 'createdAt'>>): Promise<void>`

After `await db.seasons.update(id, { ...updates, updatedAt: Date.now() });`, add:
```ts
// Evaluate achievements after season data changes (bowl results, playoff results)
// Need dynastyId — fetch from the stored season record
const updated = await db.seasons.get(id);
if (updated) {
  evaluateAchievements(updated.dynastyId).catch(() => {});
}
```

This covers both bowl wins and championship milestones since SeasonEndModal calls updateSeason() with bowlResult and playoffResult.

IMPORTANT: The `.catch(() => {})` pattern is intentional — achievement evaluation is a background enrichment. A failure must not cause the user's game log or season update to error. This is the same fire-and-forget approach used for narrative caching (Claude Haiku Legacy Card blurbs fire as background promises per STATE.md decisions).
  </action>
  <verify>
    <automated>cd /Users/chanmoore/dev/dynasty-os && pnpm run build 2>&1 | tail -15</automated>
    <manual>Confirm build passes. Check game-service.ts and season-service.ts both import evaluateAchievements and call it in the correct locations.</manual>
    <sampling_rate>run after this task commits, before next task begins</sampling_rate>
  </verify>
  <done>Build passes. game-service.createGame() calls evaluateAchievements(dynastyId).catch(()=>{}) after recalculateSeasonRecord. season-service.updateSeason() calls evaluateAchievements(dynastyId).catch(()=>{}) after the DB write. No TypeScript errors.</done>
</task>

<task type="auto">
  <name>Task 2: TrophyRoomPage — earned achievement display</name>
  <files>
    apps/desktop/src/pages/TrophyRoomPage.tsx
    apps/desktop/src/store/navigation-store.ts
    apps/desktop/src/pages/DashboardPage.tsx
    apps/desktop/src/App.tsx
  </files>
  <action>
**1. Create `apps/desktop/src/pages/TrophyRoomPage.tsx`:**

Follow the same page structure as RivalryTrackerPage.tsx (header with back button, bg-gray-900, max-w-4xl container).

Page behavior:
- On mount, load activeDynasty from useDynastyStore, call `useAchievementStore.getState().loadAchievements(dynastyId)` to populate earned achievements
- Display all MILESTONE_DEFINITIONS grouped into three sections: "Win Milestones", "Bowl Wins", "Championships"
- For each milestone definition, check if an earned achievement exists (matching achievementId):
  - **Earned**: amber-600 border, trophy icon (SVG or emoji-free text), white label, green "Unlocked" badge + formatted unlock date (e.g. "Unlocked 2/22/2026")
  - **Locked**: gray-700 border, dimmed text, lock icon, gray "Locked" badge
- Category section headers: same `text-sm uppercase tracking-wider text-gray-400` pattern from dashboard
- Show achievement count summary at top: "X / Y achievements earned"
- Back button in header calls `useNavigationStore.getState().goToDashboard()`

Use `bg-amber-600` for earned achievement cards and `bg-gray-800` for locked ones, consistent with the amber=legacy/achievement visual language established in STATE.md decisions.

Trophy icon: use a simple inline SVG or unicode character (not emoji). A suitable SVG is a star shape or award ribbon. Use `★` (★) as a unicode character for earned, `○` for locked — avoids external icon library dependency.

**2. Update `apps/desktop/src/store/navigation-store.ts`:**
- Add `'trophy-room'` and `'coaching-resume'` to the Page union type
- Add `goToTrophyRoom: () => void` and `goToCoachingResume: () => void` to NavigationActions interface
- Implement both actions: `set({ currentPage: 'trophy-room', pageParams: {} })` and `set({ currentPage: 'coaching-resume', pageParams: {} })`

**3. Update `apps/desktop/src/pages/DashboardPage.tsx`:**
In the "Actions" section (the `bg-gray-800 rounded-lg p-5` div with action buttons), add two new buttons ABOVE the "Manage Roster" button (these are legacy/career features, place them prominently):

```tsx
<button
  onClick={() => useNavigationStore.getState().goToTrophyRoom()}
  className="w-full px-4 py-2.5 bg-amber-600 hover:bg-amber-500 text-white text-sm font-semibold rounded-lg transition-colors"
>
  Trophy Room
</button>
<button
  onClick={() => useNavigationStore.getState().goToCoachingResume()}
  className="w-full px-4 py-2.5 bg-amber-600 hover:bg-amber-500 text-white text-sm font-semibold rounded-lg transition-colors"
>
  Coaching Resume
</button>
```

**4. Update `apps/desktop/src/App.tsx`:**
- Add imports: `import { TrophyRoomPage } from './pages/TrophyRoomPage';` and `import { CoachingResumePage } from './pages/CoachingResumePage';`
- Add cases to the switch:
  ```ts
  case 'trophy-room':
    return <TrophyRoomPage />;
  case 'coaching-resume':
    return <CoachingResumePage />;
  ```
  Add these before the `default` case.
  </action>
  <verify>
    <automated>cd /Users/chanmoore/dev/dynasty-os && pnpm run build 2>&1 | tail -15</automated>
    <manual>Confirm build passes. TrophyRoomPage renders with earned/locked sections for all three categories.</manual>
    <sampling_rate>run after this task commits, before next task begins</sampling_rate>
  </verify>
  <done>Build passes. TrophyRoomPage renders all MILESTONE_DEFINITIONS grouped by category, earned achievements shown with amber styling and unlock date, locked shown dimmed. Dashboard has Trophy Room and Coaching Resume amber buttons. App.tsx routes both pages.</done>
</task>

<task type="auto">
  <name>Task 3: CoachingResumePage — career stats aggregation</name>
  <files>
    apps/desktop/src/pages/CoachingResumePage.tsx
  </files>
  <action>
**Create `apps/desktop/src/pages/CoachingResumePage.tsx`:**

This page computes career statistics directly from the DB (no new service needed — pattern matches records-service.ts which also does no-cache fresh queries). Import `db` from `@dynasty-os/db` for direct queries.

Page behavior:
- On mount, load activeDynasty from useDynastyStore. Load all seasons and games for the dynasty directly from db.
- Compute career statistics:
  - **Overall record**: sum of wins/losses across all seasons (use season.wins / season.losses, which are already calculated by recalculateSeasonRecord)
  - **Win percentage**: (totalWins / (totalWins + totalLosses) * 100).toFixed(1) + '%' — show '0.0%' if no games played
  - **Bowl record**: count seasons where bowlGame is set; wins = bowlResult === 'W', losses = bowlResult === 'L'
  - **Championships**: count seasons where playoffResult exists and playoffResult.toLowerCase().includes('champion') — free-text field detection
  - **Seasons coached**: total count of Season records for this dynasty
  - **Total games**: total game count from db.games (for reference)

Layout: two-column stat grid on lg, single column on mobile. Use the same `bg-gray-800 rounded-lg p-5` card pattern.

Stat cards: each shows label (gray-400, uppercase, tracking-wider) and value (text-3xl font-bold text-white or text-amber-400 for highlight stats).

Highlight stats in amber (text-amber-400): Win %, Championships.
Standard stats in white: Overall Record, Bowl Record, Seasons, Total Games.

Header pattern:
```tsx
<header className="border-b border-gray-800 px-6 py-4">
  <div className="max-w-4xl mx-auto flex items-center gap-4">
    <button onClick={() => useNavigationStore.getState().goToDashboard()} ...>Back</button>
    <h1 className="text-xl font-bold tracking-tight">Coaching Resume</h1>
  </div>
</header>
```

Show coach name and team from activeDynasty as a subtitle: `{activeDynasty.coachName} — {activeDynasty.teamName}` in gray-400.

Include the earned achievement count from useAchievementStore as a summary line: "X achievements earned" with a link-styled button to go to Trophy Room.

Loading state: show "Loading career stats..." spinner (same empty-state text pattern as other pages).

No separate service file needed — direct db queries in a useEffect, same pattern as CoachingResumePage computing its own derived stats (not shared with other pages, no N+1 risk at dynasty scale).
  </action>
  <verify>
    <automated>cd /Users/chanmoore/dev/dynasty-os && pnpm run build 2>&1 | tail -15</automated>
    <manual>Confirm build passes. CoachingResumePage shows 6 stat cards: overall record, win %, bowl record, championships, seasons coached, total games. Back button returns to dashboard.</manual>
    <sampling_rate>run after this task commits, before next task begins</sampling_rate>
  </verify>
  <done>Build passes. CoachingResumePage displays all career stat cards. Win % and Championships use amber-400 highlight. Overall record shows W-L format. Bowl record shows bowl-W / bowl-L. Championships count uses case-insensitive 'champion' substring match on playoffResult. Coaching Resume page links to Trophy Room.</done>
</task>

</tasks>

<verification>
Full verification after all three tasks:
- `pnpm run build` passes with no TypeScript errors (5/5 packages)
- `apps/desktop/src/lib/game-service.ts` imports evaluateAchievements and calls it in createGame() after recalculateSeasonRecord
- `apps/desktop/src/lib/season-service.ts` imports evaluateAchievements and calls it in updateSeason() after DB write
- `apps/desktop/src/store/navigation-store.ts` Page union includes 'trophy-room' and 'coaching-resume'
- `apps/desktop/src/pages/TrophyRoomPage.tsx` exists and renders earned/locked achievement groups
- `apps/desktop/src/pages/CoachingResumePage.tsx` exists and renders career stat cards
- `apps/desktop/src/pages/DashboardPage.tsx` has Trophy Room and Coaching Resume amber buttons in Actions section
- `apps/desktop/src/App.tsx` routes 'trophy-room' to TrophyRoomPage and 'coaching-resume' to CoachingResumePage
</verification>

<success_criteria>
1. Achievement engine (ACHV-01): evaluateAchievements() fires automatically after game logging (createGame) and season-end updates (updateSeason). Milestones for win totals, bowl wins, and championships all evaluate. Engine is idempotent.
2. Trophy Room (ACHV-02): User navigates from Dashboard to Trophy Room and sees all 14 milestone definitions with earned/locked status, grouped by category.
3. Coaching Resume (ACHV-03): User navigates from Dashboard to Coaching Resume and sees overall record (W-L), win percentage, bowl record, championship count, seasons coached, and total games — all computed fresh from dynasty data.
</success_criteria>

<output>
After completion, create `.planning/phases/07-achievements/07-02-SUMMARY.md`
</output>
