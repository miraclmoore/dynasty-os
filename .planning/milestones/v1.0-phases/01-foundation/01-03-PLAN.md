---
phase: 01-foundation
plan: 03
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - packages/core-types/src/index.ts
  - packages/core-types/src/dynasty.ts
  - packages/core-types/src/season.ts
  - packages/core-types/src/game.ts
  - packages/core-types/src/player.ts
  - packages/core-types/src/sport-config.ts
  - packages/db/src/index.ts
  - packages/db/src/schema.ts
  - packages/db/src/dynasty-db.ts
  - packages/db/package.json
  - packages/sport-configs/src/index.ts
  - packages/sport-configs/src/types.ts
  - packages/sport-configs/src/cfb.ts
  - packages/sport-configs/src/madden.ts
  - packages/sport-configs/package.json
autonomous: true

must_haves:
  truths:
    - "Dexie database initializes without errors and creates all required tables"
    - "A Dynasty record can be created, read, updated, and deleted via the db package"
    - "Sport config for CFB returns correct teams, conferences, positions, and stat categories"
    - "Sport config for Madden returns correct teams, conferences, positions, and stat categories"
    - "Sport config resolves dynamically by sport key string ('cfb' or 'madden')"
    - "All core types are importable from @dynasty-os/core-types"
  artifacts:
    - path: "packages/core-types/src/dynasty.ts"
      provides: "Dynasty, Season, Game, Player type definitions"
      exports: ["Dynasty", "Season", "Game", "Player", "SportType", "GameResult"]
    - path: "packages/db/src/schema.ts"
      provides: "Dexie table schema with indexes"
      contains: "dynasties"
    - path: "packages/db/src/dynasty-db.ts"
      provides: "DynastyDB class extending Dexie"
      exports: ["DynastyDB", "db"]
    - path: "packages/sport-configs/src/cfb.ts"
      provides: "College Football configuration"
      exports: ["cfbConfig"]
    - path: "packages/sport-configs/src/madden.ts"
      provides: "Madden NFL configuration"
      exports: ["maddenConfig"]
  key_links:
    - from: "packages/db/src/schema.ts"
      to: "packages/core-types/src/dynasty.ts"
      via: "imports Dynasty type for table typing"
      pattern: "import.*Dynasty.*from.*@dynasty-os/core-types"
    - from: "packages/sport-configs/src/index.ts"
      to: "cfb.ts and madden.ts"
      via: "getSportConfig() resolver function"
      pattern: "getSportConfig"
---

<objective>
Define all core TypeScript types, implement the Dexie ORM database schema with CRUD operations for
dynasties, and create the sport configuration pattern with complete CFB and Madden configs. This is
the data foundation that every feature in every future phase depends on.

Purpose: Without types, database, and sport configs, nothing can be stored, queried, or displayed.
This plan creates the data layer that Phase 1 Plan 04 (Dynasty Management UI) and every future
phase will consume.

Output: Working @dynasty-os/core-types, @dynasty-os/db, and @dynasty-os/sport-configs packages with
full type definitions, Dexie schema, and sport configs for CFB and Madden.
</objective>

<execution_context>
@/Users/chanmoore/.claude/get-shit-done/workflows/execute-plan.md
@/Users/chanmoore/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-01-SUMMARY.md

Prior plan 01-01 created the package scaffolds. This plan fills them with real content.

Key design decisions:
- Sport Config pattern: config objects isolate sport differences; shared code queries config by sport key
- Dexie ORM over raw IndexedDB: query-capable, typed, auto-versioning
- Local-first: no server, no auth, data lives in IndexedDB
- Multi-dynasty: each dynasty is a top-level record; seasons/games/players belong to a dynasty via dynastyId

Data model overview (from PRD):
- Dynasty: root entity (sport, team, coach, start year, game version)
- Season: belongs to dynasty (year, record, ranking, bowl result)
- Game: belongs to season (opponent, score, home/away, week, game type)
- Player: belongs to dynasty (name, position, stars, home state, seasons played)
- PlayerSeason: player stats for a single season (stats vary by sport via sport config)
- RecruitingClass: CFB only (year, rank, signees)
- DraftPick: belongs to season (player, round, pick, team)

Sport configs provide:
- Teams and conferences (for dropdowns)
- Positions (for player creation)
- Stat categories (for per-season stat logging)
- Game types (regular season, bowl, playoff, etc.)
- Rankings systems (AP, CFP for CFB; none for Madden)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Define core TypeScript types for all entities</name>
  <files>
    packages/core-types/src/index.ts
    packages/core-types/src/dynasty.ts
    packages/core-types/src/season.ts
    packages/core-types/src/game.ts
    packages/core-types/src/player.ts
    packages/core-types/src/sport-config.ts
  </files>
  <action>
    Create the following type definitions in separate files, re-exported from index.ts:

    **dynasty.ts:**
    ```ts
    export type SportType = 'cfb' | 'madden';

    export interface Dynasty {
      id: string;              // UUID
      name: string;            // e.g., "Texas Longhorns Dynasty"
      sport: SportType;
      teamName: string;        // e.g., "Texas Longhorns"
      coachName: string;
      startYear: number;       // e.g., 2024
      currentYear: number;     // tracks progression
      gameVersion: string;     // e.g., "EA Sports CFB 26", "Madden NFL 26"
      createdAt: number;       // timestamp
      updatedAt: number;       // timestamp
    }
    ```

    **season.ts:**
    ```ts
    export interface Season {
      id: string;              // UUID
      dynastyId: string;       // FK to Dynasty
      year: number;            // e.g., 2024
      wins: number;
      losses: number;
      confWins: number;
      confLosses: number;
      finalRanking?: number;   // end-of-season ranking
      bowlGame?: string;       // e.g., "Sugar Bowl"
      bowlResult?: 'W' | 'L';
      playoffResult?: string;  // e.g., "National Champion", "Semifinal Loss"
      tagline?: string;        // AI-generated 3-word tagline (Phase 4)
      notes?: string;          // user notes
      createdAt: number;
      updatedAt: number;
    }
    ```

    **game.ts:**
    ```ts
    export type GameType = 'regular' | 'conference' | 'bowl' | 'playoff' | 'exhibition';
    export type GameResult = 'W' | 'L' | 'T';
    export type HomeAway = 'home' | 'away' | 'neutral';

    export interface Game {
      id: string;              // UUID
      seasonId: string;        // FK to Season
      dynastyId: string;       // FK to Dynasty (denormalized for queries)
      week: number;            // 1-15+
      opponent: string;        // team name
      opponentRanking?: number;
      teamScore: number;
      opponentScore: number;
      result: GameResult;      // derived from scores
      homeAway: HomeAway;
      gameType: GameType;
      overtime: boolean;
      notes?: string;
      createdAt: number;
      updatedAt: number;
    }
    ```

    **player.ts:**
    ```ts
    export type PlayerStatus = 'active' | 'graduated' | 'transferred' | 'drafted' | 'injured' | 'other';

    export interface Player {
      id: string;              // UUID
      dynastyId: string;       // FK to Dynasty
      firstName: string;
      lastName: string;
      position: string;        // from sport config positions
      recruitingStars?: number; // 1-5
      homeState?: string;
      homeCity?: string;
      height?: string;         // e.g., "6-2"
      weight?: number;
      jerseyNumber?: number;
      classYear?: string;      // FR, SO, JR, SR, RS-FR, etc.
      status: PlayerStatus;
      departureYear?: number;
      departureReason?: string;
      notes?: string;
      createdAt: number;
      updatedAt: number;
    }

    // Stats are stored as key-value pairs where keys come from sport config stat categories
    export interface PlayerSeason {
      id: string;              // UUID
      playerId: string;        // FK to Player
      dynastyId: string;       // FK to Dynasty
      seasonId: string;        // FK to Season
      year: number;
      stats: Record<string, number>; // e.g., { "passingYards": 3200, "passingTDs": 28 }
      awards?: string[];       // e.g., ["Heisman Trophy", "All-American"]
      overallRating?: number;  // for Madden
      notes?: string;
      createdAt: number;
      updatedAt: number;
    }
    ```

    **sport-config.ts** (the interface that sport configs must implement):
    ```ts
    export interface TeamInfo {
      name: string;            // e.g., "Texas Longhorns"
      abbreviation: string;    // e.g., "TEX"
      conference: string;      // e.g., "SEC"
      mascot?: string;
    }

    export interface Conference {
      name: string;            // e.g., "SEC"
      teams: string[];         // team names
    }

    export interface StatCategory {
      key: string;             // e.g., "passingYards"
      label: string;           // e.g., "Passing Yards"
      group: string;           // e.g., "Passing", "Rushing", "Defense"
      type: 'integer' | 'decimal';
    }

    export interface SportConfig {
      sport: SportType;
      label: string;           // "College Football" or "Madden NFL"
      teams: TeamInfo[];
      conferences: Conference[];
      positions: string[];     // ["QB", "RB", "WR", ...]
      statCategories: StatCategory[];
      gameTypes: GameType[];
      rankingSystems?: string[]; // ["AP", "CFP"] for CFB
      classYears?: string[];   // ["FR", "SO", "JR", "SR", "RS-FR", ...] for CFB
      gameVersions: string[];  // ["EA Sports CFB 25", "EA Sports CFB 26"]
    }
    ```

    **index.ts** re-exports everything:
    ```ts
    export * from './dynasty';
    export * from './season';
    export * from './game';
    export * from './player';
    export * from './sport-config';
    ```

    Run `pnpm build --filter @dynasty-os/core-types` to verify types compile.
  </action>
  <verify>
    `pnpm build --filter @dynasty-os/core-types` succeeds.
    dist/ contains .d.ts files for all exported types.
    No TypeScript errors.
  </verify>
  <done>All core entity types (Dynasty, Season, Game, Player, PlayerSeason) and the SportConfig interface are defined and compile. Every type is importable from @dynasty-os/core-types.</done>
</task>

<task type="auto">
  <name>Task 2: Implement Dexie database schema and sport configs for CFB and Madden</name>
  <files>
    packages/db/src/index.ts
    packages/db/src/schema.ts
    packages/db/src/dynasty-db.ts
    packages/db/package.json
    packages/sport-configs/src/index.ts
    packages/sport-configs/src/types.ts
    packages/sport-configs/src/cfb.ts
    packages/sport-configs/src/madden.ts
    packages/sport-configs/package.json
  </files>
  <action>
    **Part A: Dexie Database**

    1. Ensure @dynasty-os/core-types is a workspace dependency of @dynasty-os/db:
       `pnpm add @dynasty-os/core-types@workspace:* --filter @dynasty-os/db`

    2. Create packages/db/src/schema.ts defining the Dexie schema:
       ```ts
       // Dexie schema strings define indexed properties (not all properties)
       // Format: "primaryKey, index1, index2, [multiEntry]"
       export const SCHEMA = {
         dynasties: 'id, sport, createdAt, updatedAt',
         seasons: 'id, dynastyId, year, [dynastyId+year]',
         games: 'id, seasonId, dynastyId, week, [dynastyId+seasonId]',
         players: 'id, dynastyId, position, status, [dynastyId+status]',
         playerSeasons: 'id, playerId, dynastyId, seasonId, year, [playerId+year]',
       } as const;

       export const DB_NAME = 'dynasty-os-db';
       export const DB_VERSION = 1;
       ```

    3. Create packages/db/src/dynasty-db.ts:
       ```ts
       import Dexie, { type EntityTable } from 'dexie';
       import type { Dynasty, Season, Game, Player, PlayerSeason } from '@dynasty-os/core-types';
       import { SCHEMA, DB_NAME, DB_VERSION } from './schema';

       export class DynastyDB extends Dexie {
         dynasties!: EntityTable<Dynasty, 'id'>;
         seasons!: EntityTable<Season, 'id'>;
         games!: EntityTable<Game, 'id'>;
         players!: EntityTable<Player, 'id'>;
         playerSeasons!: EntityTable<PlayerSeason, 'id'>;

         constructor() {
           super(DB_NAME);
           this.version(DB_VERSION).stores(SCHEMA);
         }
       }

       export const db = new DynastyDB();
       ```
       Note: Check Dexie v4 docs for the correct EntityTable import. If Dexie v4 uses a different
       typing pattern (like `Table<T, TKey>`), adjust accordingly. The critical thing is that tables
       are typed to the core-types interfaces.

    4. Update packages/db/src/index.ts to re-export:
       ```ts
       export { DynastyDB, db } from './dynasty-db';
       export { SCHEMA, DB_NAME, DB_VERSION } from './schema';
       ```

    5. Run `pnpm build --filter @dynasty-os/db` to verify compilation.

    **Part B: Sport Configs**

    6. Ensure @dynasty-os/core-types is a workspace dependency of @dynasty-os/sport-configs:
       `pnpm add @dynasty-os/core-types@workspace:* --filter @dynasty-os/sport-configs`

    7. Create packages/sport-configs/src/cfb.ts with the CFB config implementing SportConfig:
       - sport: 'cfb'
       - label: 'College Football'
       - teams: Include at least the Power 4 conferences (SEC, Big Ten, Big 12, ACC) with their
         real teams. Include 10-15 teams per conference (use real 2024-2025 conference alignments).
         This list will be used for opponent dropdowns. Include ALL FBS teams if reasonable (130+),
         or at minimum all Power 4 teams (~70 teams). Use real team names.
       - conferences: SEC, Big Ten, Big 12, ACC, AAC, Sun Belt, C-USA, MAC, Mountain West, Independent
       - positions: QB, RB, WR, TE, OL, DL, LB, CB, S, K, P, ATH
       - statCategories: Passing (yards, TDs, INTs, completions, attempts, rating),
         Rushing (yards, TDs, attempts, avgPerCarry),
         Receiving (yards, TDs, receptions, avgPerCatch),
         Defense (tackles, sacks, INTs, forcedFumbles, passDeflections),
         Special Teams (FGMade, FGAttempted, punts, puntAvg),
         General (gamesPlayed)
       - gameTypes: ['regular', 'conference', 'bowl', 'playoff']
       - rankingSystems: ['AP', 'CFP']
       - classYears: ['FR', 'SO', 'JR', 'SR', 'RS-FR', 'RS-SO', 'RS-JR', 'RS-SR']
       - gameVersions: ['EA Sports CFB 25', 'EA Sports CFB 26']

    8. Create packages/sport-configs/src/madden.ts with the Madden config implementing SportConfig:
       - sport: 'madden'
       - label: 'Madden NFL'
       - teams: All 32 NFL teams with their real names, abbreviations, and conferences (AFC/NFC
         with divisions). Use real 2024-2025 team names.
       - conferences: AFC East, AFC North, AFC South, AFC West, NFC East, NFC North, NFC South, NFC West
       - positions: QB, HB, FB, WR, TE, LT, LG, C, RG, RT, LE, DT, RE, LOLB, MLB, ROLB, CB, FS, SS, K, P
       - statCategories: Same core categories as CFB plus:
         Passing (yards, TDs, INTs, completions, attempts, rating, sacks taken),
         Rushing (yards, TDs, attempts, fumbles),
         Receiving (yards, TDs, receptions, targets),
         Defense (tackles, sacks, INTs, forcedFumbles, passDeflections, fumbleRecoveries),
         Special Teams (FGMade, FGAttempted, punts, puntAvg, kickReturnYards, puntReturnYards),
         General (gamesPlayed, gamesStarted)
       - gameTypes: ['regular', 'playoff', 'exhibition']
       - gameVersions: ['Madden NFL 25', 'Madden NFL 26']
       - No classYears or rankingSystems (NFL does not have these)

    9. Create packages/sport-configs/src/index.ts with the config resolver:
       ```ts
       import type { SportConfig, SportType } from '@dynasty-os/core-types';
       import { cfbConfig } from './cfb';
       import { maddenConfig } from './madden';

       const configs: Record<SportType, SportConfig> = {
         cfb: cfbConfig,
         madden: maddenConfig,
       };

       export function getSportConfig(sport: SportType): SportConfig {
         const config = configs[sport];
         if (!config) {
           throw new Error(`Unknown sport: ${sport}`);
         }
         return config;
       }

       export { cfbConfig } from './cfb';
       export { maddenConfig } from './madden';
       export { getSportConfig as default };
       ```

    10. Run `pnpm build --filter @dynasty-os/sport-configs` to verify compilation.
    11. Run `pnpm build` from root to verify everything still builds together.
  </action>
  <verify>
    `pnpm build` from root succeeds (all packages compile).
    `pnpm build --filter @dynasty-os/db` produces typed Dexie database class.
    `pnpm build --filter @dynasty-os/sport-configs` produces CFB and Madden configs.
    TypeScript reports no errors across all packages.
    CFB config has teams, conferences, positions, stat categories.
    Madden config has all 32 NFL teams, positions, stat categories.
    getSportConfig('cfb') and getSportConfig('madden') both resolve correctly (verifiable in a quick test script or by import check).
  </verify>
  <done>Dexie database schema is defined with tables for dynasties, seasons, games, players, and playerSeasons. Sport configs for CFB (Power 4 + Group of 5 teams, positions, stats) and Madden (all 32 NFL teams, positions, stats) implement the SportConfig interface. getSportConfig() resolves configs by sport key. All packages compile cleanly.</done>
</task>

</tasks>

<verification>
1. `pnpm build` from root -- all packages compile with no errors
2. Core types are importable: Dynasty, Season, Game, Player, PlayerSeason, SportConfig
3. DynastyDB class extends Dexie with typed tables matching core types
4. cfbConfig has correct teams, conferences, positions, stat categories
5. maddenConfig has all 32 NFL teams, positions, stat categories
6. getSportConfig('cfb') returns cfbConfig, getSportConfig('madden') returns maddenConfig
</verification>

<success_criteria>
- All entity types defined and exportable from @dynasty-os/core-types
- Dexie ORM schema matches the data model (dynasties, seasons, games, players, playerSeasons)
- CFB sport config has real teams, conferences, positions, and stat categories
- Madden sport config has all 32 NFL teams, divisions, positions, and stat categories
- getSportConfig() resolves by sport key
- All packages build cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-03-SUMMARY.md`
</output>
