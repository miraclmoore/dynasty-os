---
phase: 01-foundation
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - apps/desktop/src-tauri/Cargo.toml
  - apps/desktop/src-tauri/src/main.rs
  - apps/desktop/src-tauri/src/lib.rs
  - apps/desktop/src-tauri/tauri.conf.json
  - apps/desktop/src-tauri/capabilities/default.json
  - apps/desktop/src-tauri/icons/
  - apps/desktop/package.json
  - apps/desktop/vite.config.ts
  - apps/desktop/src/main.tsx
  - apps/desktop/src/App.tsx
autonomous: true

must_haves:
  truths:
    - "pnpm tauri dev launches a native desktop window showing the React frontend"
    - "The app window renders the same React content as the Vite dev server"
    - "The Tauri Rust backend compiles without errors"
    - "The app boots in under 3 seconds from cold start"
  artifacts:
    - path: "apps/desktop/src-tauri/Cargo.toml"
      provides: "Rust project manifest for Tauri backend"
      contains: "tauri"
    - path: "apps/desktop/src-tauri/tauri.conf.json"
      provides: "Tauri configuration (window, app identity, build settings)"
      contains: "dynasty-os"
    - path: "apps/desktop/src-tauri/src/lib.rs"
      provides: "Tauri application setup and plugin registration"
      contains: "tauri::Builder"
    - path: "apps/desktop/src-tauri/src/main.rs"
      provides: "Binary entry point"
      contains: "main"
  key_links:
    - from: "apps/desktop/src-tauri/tauri.conf.json"
      to: "apps/desktop (Vite)"
      via: "devUrl pointing to Vite dev server"
      pattern: "\"devUrl\": \"http://localhost:1420\""
    - from: "apps/desktop/src-tauri/src/lib.rs"
      to: "Tauri WebView"
      via: "tauri::Builder::default().run()"
      pattern: "Builder::default"
---

<objective>
Initialize Tauri 2.x in the desktop app workspace, wiring the Rust backend to the existing React +
Vite frontend. The result is a native desktop window that renders the React app via WebView, with
the Tauri CLI integrated into the monorepo workflow.

Purpose: The Tauri shell is the delivery vehicle for Dynasty OS. Without it, there is no desktop app
-- just a web page. This plan turns the React app into a real Windows application.

Output: `pnpm tauri dev` launches a native window showing the React frontend. Tauri CLI is
integrated into the monorepo dev/build scripts.
</objective>

<execution_context>
@/Users/chanmoore/.claude/get-shit-done/workflows/execute-plan.md
@/Users/chanmoore/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-01-SUMMARY.md

Prior plan 01-01 created the monorepo with:
- apps/desktop/ -- React + Vite on port 1420
- packages/{core-types, db, sport-configs, ui-components}
- pnpm workspaces + Turborepo

This plan adds Tauri 2.x to apps/desktop/.

Key constraints:
- Tauri 2.x (NOT v1) -- uses @tauri-apps/cli@next and @tauri-apps/api@next
- Target: Windows only at V1
- Performance: <80MB idle RAM, <3s cold start
- Vite dev server already on port 1420 (Tauri convention)
- App identifier: com.dynasty-os.app
</context>

<tasks>

<task type="auto">
  <name>Task 1: Initialize Tauri 2.x in the desktop workspace</name>
  <files>
    apps/desktop/src-tauri/Cargo.toml
    apps/desktop/src-tauri/src/main.rs
    apps/desktop/src-tauri/src/lib.rs
    apps/desktop/src-tauri/tauri.conf.json
    apps/desktop/src-tauri/capabilities/default.json
    apps/desktop/src-tauri/icons/
    apps/desktop/package.json
    apps/desktop/vite.config.ts
  </files>
  <action>
    1. Install Tauri CLI and API as dependencies in the desktop workspace:
       ```
       pnpm add -D @tauri-apps/cli --filter @dynasty-os/desktop
       pnpm add @tauri-apps/api --filter @dynasty-os/desktop
       ```

    2. Run `pnpm tauri init` from apps/desktop/ to scaffold the src-tauri/ directory.
       When prompted (or configure after):
       - App name: "Dynasty OS"
       - Window title: "Dynasty OS"
       - Dev server URL: http://localhost:1420
       - Frontend dist path: ../dist
       - Frontend dev command: pnpm dev
       - Frontend build command: pnpm build

       If `pnpm tauri init` does not work cleanly with Tauri v2, manually create the src-tauri/ directory with the files below.

    3. Ensure tauri.conf.json has these settings:
       ```json
       {
         "$schema": "https://raw.githubusercontent.com/nicbarker/tauri/dev/crates/tauri-cli/schema.json",
         "productName": "Dynasty OS",
         "version": "0.1.0",
         "identifier": "com.dynasty-os.app",
         "build": {
           "frontendDist": "../dist",
           "devUrl": "http://localhost:1420",
           "beforeDevCommand": "pnpm dev",
           "beforeBuildCommand": "pnpm build"
         },
         "app": {
           "windows": [
             {
               "title": "Dynasty OS",
               "width": 1280,
               "height": 800,
               "resizable": true,
               "fullscreen": false
             }
           ],
           "security": {
             "csp": null
           }
         },
         "bundle": {
           "active": true,
           "targets": "all",
           "icon": [
             "icons/32x32.png",
             "icons/128x128.png",
             "icons/128x128@2x.png",
             "icons/icon.icns",
             "icons/icon.ico"
           ]
         }
       }
       ```

    4. Ensure Cargo.toml references tauri v2 crate (NOT v1):
       ```toml
       [package]
       name = "dynasty-os"
       version = "0.1.0"
       edition = "2021"

       [dependencies]
       tauri = { version = "2", features = [] }
       tauri-build = { version = "2", features = [] }
       serde = { version = "1", features = ["derive"] }
       serde_json = "1"

       [build-dependencies]
       tauri-build = { version = "2", features = [] }
       ```

    5. Ensure src/lib.rs has minimal Tauri v2 setup:
       ```rust
       #[cfg_attr(mobile, tauri::mobile_entry_point)]
       pub fn run() {
           tauri::Builder::default()
               .run(tauri::generate_context!())
               .expect("error while running tauri application");
       }
       ```

    6. Ensure src/main.rs:
       ```rust
       #![cfg_attr(not(debug_assertions), windows_subsystem = "windows")]

       fn main() {
           dynasty_os_lib::run();
       }
       ```
       Note: The lib name derives from Cargo.toml package name with hyphens replaced by underscores.
       If Cargo.toml has `name = "dynasty-os"`, the lib is `dynasty_os`. Adjust the main.rs call accordingly
       (it may be `dynasty_os::run()` or match whatever the lib crate name is).

    7. Create build.rs in src-tauri/:
       ```rust
       fn main() {
           tauri_build::build();
       }
       ```

    8. Generate default icons using `pnpm tauri icon` if available, or create placeholder icon files.
       At minimum, create the icons/ directory with placeholder files so the build does not fail.

    9. Update apps/desktop/package.json scripts:
       ```json
       {
         "scripts": {
           "dev": "vite",
           "build": "tsc && vite build",
           "preview": "vite preview",
           "tauri": "tauri"
         }
       }
       ```

    10. Update vite.config.ts to work well with Tauri:
        - Add `envPrefix: ['VITE_', 'TAURI_']` for Tauri env vars
        - Keep server port 1420 and strictPort true
        - Ensure build target is appropriate for WebView2 (esnext is fine)

    11. Ensure Rust toolchain is available. If `rustc --version` fails, instruct the user but do NOT
        attempt to install Rust -- this would be a blocker to note in the summary. Rust should already
        be installed on the dev machine.

    12. Run `pnpm tauri dev` from apps/desktop/ (or from root with appropriate filter).
        This should:
        - Start the Vite dev server on 1420
        - Compile the Rust backend
        - Open a native window showing the React app

        The first Rust compilation will take 1-3 minutes. Subsequent runs are fast.
  </action>
  <verify>
    `pnpm tauri dev` from apps/desktop/ (or `cd apps/desktop && pnpm tauri dev`) launches a native window.
    The window shows the React "Dynasty OS" heading with Tailwind styling.
    Rust backend compiles without errors.
    No console errors in the WebView.
  </verify>
  <done>Tauri 2.x is initialized in apps/desktop/src-tauri/. pnpm tauri dev launches a native desktop window rendering the React frontend via WebView. Rust backend compiles cleanly.</done>
</task>

<task type="auto">
  <name>Task 2: Performance baseline and monorepo integration</name>
  <files>
    apps/desktop/src/App.tsx
    turbo.json (root -- add tauri scripts if needed)
  </files>
  <action>
    1. Measure cold start time:
       - Kill any running Tauri dev process
       - Time `pnpm tauri dev` from invocation to window visible (Rust already compiled from Task 1)
       - Record the time. Target: <3 seconds for the window to appear after Rust is compiled.
       - If using dev mode, the Vite server start time is separate. Measure window appearance after
         Vite is ready.

    2. Measure idle RAM:
       - Launch the app via `pnpm tauri dev`
       - Wait 5 seconds for it to settle
       - Check memory usage of the Tauri process (on macOS: Activity Monitor or `ps aux | grep dynasty`;
         the actual Windows measurement will happen on Windows, but get a baseline now)
       - Record the value. Target: <80MB idle.
       - Note: Dev mode will use more RAM than production build. Record both if possible.

    3. Record performance baselines in the summary (not in code). The executor should note:
       - Dev mode cold start time
       - Dev mode idle RAM
       - Whether targets are met (they should be easily met with an empty app)

    4. Update App.tsx to show a more useful placeholder that confirms the full stack:
       ```tsx
       import { useState } from 'react';
       // Import from workspace packages to prove they resolve
       import { Dynasty } from '@dynasty-os/core-types';
       import { DB_VERSION } from '@dynasty-os/db';
       import { SPORT_CONFIGS_VERSION } from '@dynasty-os/sport-configs';

       function App() {
         const [count, setCount] = useState(0);

         return (
           <div className="min-h-screen bg-gray-900 text-white flex flex-col items-center justify-center">
             <h1 className="text-4xl font-bold mb-4">Dynasty OS</h1>
             <p className="text-gray-400 mb-2">Desktop Companion for Dynasty Mode</p>
             <p className="text-sm text-gray-500 mb-6">
               DB v{DB_VERSION} | Sport Configs v{SPORT_CONFIGS_VERSION}
             </p>
             <button
               className="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded text-white transition-colors"
               onClick={() => setCount(c => c + 1)}
             >
               Clicked {count} times
             </button>
           </div>
         );
       }

       export default App;
       ```
       This validates: React rendering, Tailwind classes, workspace imports, state management.
       Note: Add a `SPORT_CONFIGS_VERSION` export to @dynasty-os/sport-configs if it does not exist.

    5. Verify `pnpm tauri dev` shows the updated UI with all workspace imports resolving.

    6. Run `pnpm build` from root to confirm Turborepo still builds everything including the desktop app.
  </action>
  <verify>
    `pnpm tauri dev` launches and shows updated placeholder with DB version and sport config version displayed.
    Button click increments counter (proves React state works in WebView).
    `pnpm build` from root succeeds.
    Performance baselines recorded (cold start, idle RAM) -- note in summary.
  </verify>
  <done>Tauri dev and build are integrated into the monorepo workflow. Performance baselines measured and recorded. App renders React with Tailwind in a native window, with workspace imports proven.</done>
</task>

</tasks>

<verification>
1. `pnpm tauri dev` from apps/desktop/ opens a native window with React content
2. Window shows "Dynasty OS" heading, DB version, sport config version, and interactive button
3. Rust compiles without warnings or errors
4. `pnpm build` from root succeeds (all packages + desktop)
5. Cold start time and idle RAM baselines recorded
</verification>

<success_criteria>
- Tauri 2.x initialized in apps/desktop/src-tauri/
- Native desktop window renders React frontend via WebView
- Workspace imports from core-types, db, and sport-configs resolve in the app
- Performance baselines documented (expect well under 80MB and 3s with empty app)
- Full monorepo build pipeline works end to end
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-02-SUMMARY.md`
</output>
