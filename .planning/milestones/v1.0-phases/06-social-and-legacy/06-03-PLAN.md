---
phase: 06-social-and-legacy
plan: 03
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - packages/core-types/src/scouting-note.ts
  - packages/core-types/src/index.ts
  - packages/db/src/dynasty-db.ts
  - apps/desktop/src/lib/scouting-service.ts
  - apps/desktop/src/store/scouting-store.ts
  - apps/desktop/src/store/index.ts
  - apps/desktop/src/store/navigation-store.ts
  - apps/desktop/src/pages/ScoutingCardPage.tsx
  - apps/desktop/src/pages/DashboardPage.tsx
  - apps/desktop/src/App.tsx
autonomous: true

must_haves:
  truths:
    - "User can view a pre-game scouting card for any opponent they have game history against"
    - "Scouting card shows the historical head-to-head record vs that opponent and current streak"
    - "User can add and save tendency notes for any opponent (freeform text)"
    - "Scouting cards are accessible from a dedicated page with opponent search/selection"
  artifacts:
    - path: "packages/core-types/src/scouting-note.ts"
      provides: "ScoutingNote type definition"
      contains: "export interface ScoutingNote"
    - path: "apps/desktop/src/lib/scouting-service.ts"
      provides: "ScoutingNote CRUD"
      exports: ["createScoutingNote", "getScoutingNotesByDynasty", "upsertScoutingNote", "deleteScoutingNote"]
    - path: "apps/desktop/src/store/scouting-store.ts"
      provides: "Zustand store for scouting notes"
      exports: ["useScoutingStore"]
    - path: "apps/desktop/src/pages/ScoutingCardPage.tsx"
      provides: "Scouting card UI with H2H record, season context, and tendency notes"
  key_links:
    - from: "apps/desktop/src/pages/ScoutingCardPage.tsx"
      to: "apps/desktop/src/lib/records-service.ts"
      via: "getHeadToHeadRecords(dynastyId) call — scouting reuses existing H2H computation"
      pattern: "getHeadToHeadRecords"
    - from: "apps/desktop/src/lib/scouting-service.ts"
      to: "@dynasty-os/db"
      via: "db.scoutingNotes"
      pattern: "db\\.scoutingNotes"
    - from: "apps/desktop/src/pages/ScoutingCardPage.tsx"
      to: "scouting-store.ts"
      via: "useScoutingStore hook for notes load/save"
      pattern: "useScoutingStore"
    - from: "packages/db/src/dynasty-db.ts"
      to: "packages/core-types/src/scouting-note.ts"
      via: "Table<ScoutingNote, string> declaration — replaces Record<string, unknown> placeholder from 06-01"
      pattern: "Table<ScoutingNote"
---

<objective>
Build opponent scouting cards — ScoutingNote core type (replacing the placeholder from 06-01), service layer with CRUD (one note per opponent per dynasty, upsert pattern), Zustand store, and a Scouting Card page that lets users pick any opponent from their game history, shows the H2H record and recent game results, and lets them write and save tendency notes for that opponent.

Purpose: Scouting cards let coaches do pre-game preparation within their dynasty context — seeing history against upcoming opponents and capturing tactical notes they can reference before each matchup.

Output: ScoutingNote type (updates dynasty-db.ts placeholder), scouting-service.ts, scouting-store.ts, ScoutingCardPage.tsx wired into navigation and Dashboard.
</objective>

<execution_context>
@/Users/chanmoore/.claude/get-shit-done/workflows/execute-plan.md
@/Users/chanmoore/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-social-and-legacy/06-01-SUMMARY.md

@packages/db/src/schema.ts
@packages/db/src/dynasty-db.ts
@packages/core-types/src/rival.ts
@packages/core-types/src/index.ts
@apps/desktop/src/lib/records-service.ts
@apps/desktop/src/lib/rivalry-service.ts
@apps/desktop/src/store/navigation-store.ts
@apps/desktop/src/store/rivalry-store.ts
@apps/desktop/src/store/index.ts
@apps/desktop/src/pages/DashboardPage.tsx
@apps/desktop/src/App.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: ScoutingNote type, updated DB declaration, scouting service and store</name>
  <files>
    packages/core-types/src/scouting-note.ts
    packages/core-types/src/index.ts
    packages/db/src/dynasty-db.ts
    apps/desktop/src/lib/scouting-service.ts
    apps/desktop/src/store/scouting-store.ts
    apps/desktop/src/store/index.ts
  </files>
  <action>
  1. Create `packages/core-types/src/scouting-note.ts`:
     ```ts
     export interface ScoutingNote {
       id: string;
       dynastyId: string;
       opponent: string;      // Opponent name — unique per dynastyId (one note per opponent)
       tendencies: string;    // Freeform text: offensive tendencies, defensive schemes, coaching notes
       createdAt: number;
       updatedAt: number;
     }
     ```

  2. Update `packages/core-types/src/index.ts` — add:
     ```ts
     export * from './scouting-note';
     ```

  3. Update `packages/db/src/dynasty-db.ts`:
     - Import `ScoutingNote` from @dynasty-os/core-types alongside existing imports.
     - Replace the placeholder `scoutingNotes!: Table<Record<string, unknown>, string>` with:
       ```ts
       scoutingNotes!: Table<ScoutingNote, string>;
       ```
     - No version bump needed — schema.ts already has the scoutingNotes table from 06-01 (DB_VERSION = 4). This is only a TypeScript type update to the DynastyDB class property declaration.

  4. Create `apps/desktop/src/lib/scouting-service.ts`:
     - Import db from @dynasty-os/db, ScoutingNote from @dynasty-os/core-types, generateId from ./uuid.
     - Functions:
       - `getScoutingNotesByDynasty(dynastyId: string): Promise<ScoutingNote[]>` — `db.scoutingNotes.where('dynastyId').equals(dynastyId).toArray()`, sorted by opponent ascending.
       - `getScoutingNoteForOpponent(dynastyId: string, opponent: string): Promise<ScoutingNote | null>` — `db.scoutingNotes.where('[dynastyId+opponent]').equals([dynastyId, opponent]).first() ?? null`.
       - `upsertScoutingNote(dynastyId: string, opponent: string, tendencies: string): Promise<ScoutingNote>` — check if note exists for [dynastyId, opponent]. If yes: update (db.scoutingNotes.update(existing.id, { tendencies, updatedAt: Date.now() }), return updated). If no: create new (generateId, timestamps, db.scoutingNotes.add(), return new note).
       - `deleteScoutingNote(id: string): Promise<void>` — `db.scoutingNotes.delete(id)`.

  5. Create `apps/desktop/src/store/scouting-store.ts`:
     - Zustand store, state: `notes: ScoutingNote[]`, `loading: boolean`
     - Actions:
       - `loadNotes(dynastyId: string)` — calls getScoutingNotesByDynasty, sets notes
       - `saveNote(dynastyId: string, opponent: string, tendencies: string)` — calls upsertScoutingNote, then loadNotes(dynastyId)
       - `removeNote(id: string, dynastyId: string)` — calls deleteScoutingNote, then loadNotes(dynastyId)

  6. Update `apps/desktop/src/store/index.ts` — add:
     ```ts
     export { useScoutingStore } from './scouting-store';
     ```
  </action>
  <verify>Run `cd /Users/chanmoore/dev/dynasty-os && pnpm turbo build --filter=@dynasty-os/db --filter=@dynasty-os/core-types` — both packages compile with no type errors. Confirm dynasty-db.ts has `scoutingNotes!: Table<ScoutingNote, string>` (not Record<string, unknown>). Confirm ScoutingNote exported from core-types/src/index.ts.</verify>
  <done>ScoutingNote type exported from core-types. dynasty-db.ts scoutingNotes table properly typed. scouting-service.ts has CRUD with upsert pattern (one note per opponent). useScoutingStore exported from store barrel. Build passes.</done>
</task>

<task type="auto">
  <name>Task 2: Scouting Card page, navigation wiring, Dashboard button</name>
  <files>
    apps/desktop/src/store/navigation-store.ts
    apps/desktop/src/pages/ScoutingCardPage.tsx
    apps/desktop/src/pages/DashboardPage.tsx
    apps/desktop/src/App.tsx
  </files>
  <action>
  1. Update `apps/desktop/src/store/navigation-store.ts`:
     - Add `'scouting-card'` to the Page type union.
     - Add `goToScoutingCard: () => void` to NavigationActions interface.
     - Add action:
       ```ts
       goToScoutingCard: () => { set({ currentPage: 'scouting-card', pageParams: {} }); },
       ```

  2. Create `apps/desktop/src/pages/ScoutingCardPage.tsx`:
     - Imports: useScoutingStore from ../store; getHeadToHeadRecords, HeadToHeadRecord from ../lib/records-service; useDynastyStore, useNavigationStore from ../store; React useState, useEffect.
     - No CFB-only guard — scouting cards are sport-agnostic.
     - Layout: dark theme (bg-gray-900 text-white), header "Opponent Scouting Cards", back button (goToDashboard).

     - **State**:
       - `h2hRecords: HeadToHeadRecord[]` — loaded on mount via getHeadToHeadRecords(activeDynasty.id)
       - `selectedOpponent: string | null` — which opponent's card is displayed
       - `editingTendencies: string` — textarea content for editing
       - `saving: boolean`

     - **On mount**: load H2H records AND load scouting notes: `useScoutingStore.getState().loadNotes(activeDynasty.id)`.

     - **Opponent selector** (top panel):
       - Heading: "Select Opponent" (text-sm text-gray-400 uppercase)
       - Text input with placeholder "Search opponents..." that filters h2hRecords by opponent name (case-insensitive substring match).
       - Filtered list below the input: each opponent shown as a clickable row (bg-gray-800 hover:bg-gray-700 px-3 py-2 rounded cursor-pointer). On click: set selectedOpponent.
       - Each row shows: opponent name (font-medium) + W-L record from h2hRecords in gray text on the right.
       - If no H2H records at all: show "No game history yet. Log games to unlock scouting cards."

     - **Scouting card** (shown when selectedOpponent is set):
       - Card header: opponent name in large text (text-xl font-bold text-white) with a small "X" close button to deselect.
       - **Head-to-Head section**:
         - Record: "{wins}-{losses}{ties > 0 ? `-${ties}` : ''}" (text-3xl font-bold, green if winPct >= 0.5, red if < 0.5).
         - Current streak: "W{N}" green or "L{N}" red.
         - Win percentage: "{winPct}%"
       - **Recent games section** (last 5 games from record.games sorted by year/week desc):
         - Table with columns: Season, Week, Result, Score.
         - Each row: year, week (e.g., "W14"), result chip (W=green bg, L=red bg), score (e.g., "35-21").
       - **Tendency Notes section**:
         - Section heading: "Scouting Notes" with small "Edit" button.
         - Display mode: show existing note tendencies text (text-gray-300) or "No scouting notes yet — add notes below." in gray italic.
         - Edit mode (toggled by Edit button): textarea (bg-gray-700 text-white w-full p-3 rounded min-h-[120px]) pre-filled with existing note text. "Save Notes" button (amber) + "Cancel" button (gray).
         - On Save: call `useScoutingStore.getState().saveNote(activeDynasty.id, selectedOpponent, editingTendencies)`, exit edit mode.

  3. Update `apps/desktop/src/pages/DashboardPage.tsx`:
     - Add a "Scouting Cards" button accessible to ALL sports (not inside the CFB guard). Place it in the general navigation section (alongside "Roster", "Legends", "Records" buttons) since it is sport-agnostic.
     - Button:
       ```tsx
       <button
         onClick={() => useNavigationStore.getState().goToScoutingCard()}
         className="w-full px-4 py-2.5 bg-amber-600 hover:bg-amber-500 text-white text-sm font-semibold rounded-lg transition-colors"
       >
         Scouting Cards
       </button>
       ```

  4. Update `apps/desktop/src/App.tsx`:
     - Import ScoutingCardPage.
     - Add `case 'scouting-card': return <ScoutingCardPage />;` to the switch.
  </action>
  <verify>Run `cd /Users/chanmoore/dev/dynasty-os && pnpm turbo build` — full build passes. Verify navigation-store.ts has 'scouting-card' in Page type and goToScoutingCard helper. Verify App.tsx has 'scouting-card' case. Verify DashboardPage.tsx has "Scouting Cards" button outside the CFB guard. Verify ScoutingCardPage.tsx calls getHeadToHeadRecords and useScoutingStore.</verify>
  <done>ScoutingCardPage shows opponent search/list (all opponents from game log), scouting card with H2H record + recent games + tendency notes (save/edit/cancel). Scouting Cards accessible from Dashboard for all sport types. App.tsx routes 'scouting-card'. Build passes.</done>
</task>

</tasks>

<verification>
1. `pnpm turbo build` passes with no errors
2. ScoutingNote type exported from packages/core-types/src/index.ts
3. dynasty-db.ts `scoutingNotes` property typed as `Table<ScoutingNote, string>` (not Record placeholder)
4. upsertScoutingNote implements one-note-per-opponent pattern (check-then-create-or-update)
5. ScoutingCardPage calls getHeadToHeadRecords — no re-implementation of H2H logic
6. Opponent list populated from actual game log (h2hRecords), not a freeform text field
7. Tendency notes save via upsertScoutingNote and reload from store after save
8. "Scouting Cards" Dashboard button is outside the CFB sport guard (all sports can use it)
9. navigation-store.ts has 'scouting-card' page type and goToScoutingCard helper
</verification>

<success_criteria>
- User can select any opponent they've played and view a scouting card with H2H record and recent results
- User can write and save tendency notes per opponent (upsert — one note per opponent)
- Scouting Cards accessible from Dashboard for CFB and Madden dynasties
- dynasty-db.ts scoutingNotes table uses ScoutingNote type (not placeholder)
- Full build compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/06-social-and-legacy/06-03-SUMMARY.md`
</output>
