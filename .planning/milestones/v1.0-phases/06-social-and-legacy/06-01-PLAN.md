---
phase: 06-social-and-legacy
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/core-types/src/rival.ts
  - packages/core-types/src/index.ts
  - packages/db/src/schema.ts
  - packages/db/src/dynasty-db.ts
  - apps/desktop/src/lib/rivalry-service.ts
  - apps/desktop/src/store/rivalry-store.ts
  - apps/desktop/src/store/index.ts
  - apps/desktop/src/store/navigation-store.ts
  - apps/desktop/src/pages/RivalryTrackerPage.tsx
  - apps/desktop/src/pages/DashboardPage.tsx
  - apps/desktop/src/App.tsx
autonomous: true

must_haves:
  truths:
    - "User can designate any opponent as a rival with a custom rivalry label"
    - "Head-to-head record vs rivals auto-calculates from game log (wins, losses, ties, streak)"
    - "Rivalry intensity score displays alongside the current streak indicator"
    - "Rivalry Tracker is accessible from the Dashboard CFB Program section"
  artifacts:
    - path: "packages/core-types/src/rival.ts"
      provides: "Rival type definition"
      contains: "export interface Rival"
    - path: "apps/desktop/src/lib/rivalry-service.ts"
      provides: "Rival CRUD and intensity calculation"
      exports: ["createRival", "getRivalsByDynasty", "updateRival", "deleteRival", "calculateRivalryIntensity"]
    - path: "apps/desktop/src/store/rivalry-store.ts"
      provides: "Zustand store for rivals state"
      exports: ["useRivalryStore"]
    - path: "apps/desktop/src/pages/RivalryTrackerPage.tsx"
      provides: "Rival designation UI with H2H record, streak, and intensity score"
  key_links:
    - from: "apps/desktop/src/pages/RivalryTrackerPage.tsx"
      to: "apps/desktop/src/lib/records-service.ts"
      via: "getHeadToHeadRecords(dynastyId) call — rivals reuse existing H2H computation"
      pattern: "getHeadToHeadRecords"
    - from: "apps/desktop/src/lib/rivalry-service.ts"
      to: "@dynasty-os/db"
      via: "db.rivals"
      pattern: "db\\.rivals"
    - from: "apps/desktop/src/pages/RivalryTrackerPage.tsx"
      to: "rivalry-store.ts"
      via: "useRivalryStore hook"
      pattern: "useRivalryStore"
---

<objective>
Build the rivalry tracker — DB schema v4 migration (rivals and scoutingNotes tables), Rival core type, service layer with CRUD and intensity calculation, Zustand store, and a Rivalry Tracker page that lets users designate opponents as rivals with custom labels, then displays the auto-calculated H2H record and intensity score by pulling from the existing getHeadToHeadRecords function.

Purpose: Rivalries give the dynasty a narrative layer — not just opponents, but storied matchups with streaks, history, and emotional stakes. The intensity score makes the rivalry feel earned over time.

Output: DB v4 migration, Rival type, rivalry-service.ts, rivalry-store.ts, RivalryTrackerPage.tsx wired into navigation and Dashboard.
</objective>

<execution_context>
@/Users/chanmoore/.claude/get-shit-done/workflows/execute-plan.md
@/Users/chanmoore/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-cfb-features/05-01-SUMMARY.md

@packages/db/src/schema.ts
@packages/db/src/dynasty-db.ts
@packages/core-types/src/prestige.ts
@packages/core-types/src/index.ts
@apps/desktop/src/lib/records-service.ts
@apps/desktop/src/lib/prestige-service.ts
@apps/desktop/src/store/navigation-store.ts
@apps/desktop/src/store/prestige-store.ts
@apps/desktop/src/store/index.ts
@apps/desktop/src/pages/DashboardPage.tsx
@apps/desktop/src/App.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: DB schema v4 migration, Rival type, rivalry service and store</name>
  <files>
    packages/core-types/src/rival.ts
    packages/core-types/src/index.ts
    packages/db/src/schema.ts
    packages/db/src/dynasty-db.ts
    apps/desktop/src/lib/rivalry-service.ts
    apps/desktop/src/store/rivalry-store.ts
    apps/desktop/src/store/index.ts
  </files>
  <action>
  1. Create `packages/core-types/src/rival.ts`:
     ```ts
     export interface Rival {
       id: string;
       dynastyId: string;
       opponent: string;       // Exact opponent name as it appears in game log
       label: string;          // Custom rivalry label (e.g., "The Iron Bowl", "The Border War")
       createdAt: number;
       updatedAt: number;
     }
     ```

  2. Update `packages/core-types/src/index.ts` — add:
     ```ts
     export * from './rival';
     ```

  3. Update `packages/db/src/schema.ts`:
     - Add two tables to the SCHEMA object:
       ```ts
       rivals: 'id, dynastyId, opponent, [dynastyId+opponent]',
       scoutingNotes: 'id, dynastyId, opponent, [dynastyId+opponent]',
       ```
     - Bump DB_VERSION from 3 to 4.

  4. Update `packages/db/src/dynasty-db.ts`:
     - Import `Rival` and `ScoutingNote` from @dynasty-os/core-types (ScoutingNote type will be created in 06-03; for now import only Rival and declare rivals table. Leave scoutingNotes table declaration as `Table<Record<string, unknown>, string>` with a TODO comment so the DB migration still runs — 06-03 will update this to the proper type).
     - Actually, simpler: declare both tables now but use a placeholder type for scoutingNotes:
       ```ts
       rivals!: Table<Rival, string>;
       scoutingNotes!: Table<Record<string, unknown>, string>; // typed in 06-03
       ```
     - Add `this.version(4).stores(SCHEMA);` to the constructor after the existing `this.version(DB_VERSION).stores(SCHEMA)` line. Wait — DB_VERSION is now 4. So the constructor should be:
       ```ts
       this.version(1).stores(SCHEMA);
       this.version(4).stores(SCHEMA);
       ```
     - Import Rival from @dynasty-os/core-types alongside existing imports.

  5. Create `apps/desktop/src/lib/rivalry-service.ts`:
     - Import db from @dynasty-os/db, Rival from @dynasty-os/core-types, generateId from ./uuid.
     - Import getHeadToHeadRecords from ./records-service.
     - CRUD functions:
       - `createRival(input: Omit<Rival, 'id' | 'createdAt' | 'updatedAt'>): Promise<Rival>` — generateId, timestamps, db.rivals.add(), return rival
       - `getRivalsByDynasty(dynastyId: string): Promise<Rival[]>` — db.rivals.where('dynastyId').equals(dynastyId).toArray(), sort by opponent ascending
       - `updateRival(id: string, updates: Partial<Pick<Rival, 'label' | 'opponent'>>): Promise<void>` — db.rivals.update(id, { ...updates, updatedAt: Date.now() })
       - `deleteRival(id: string): Promise<void>` — db.rivals.delete(id)
     - Intensity calculation (pure function, exported):
       ```ts
       export function calculateRivalryIntensity(totalGames: number): number {
         // 1-10 scale: 1-2 games = 1, each additional 2 games = +1, cap at 10
         if (totalGames <= 0) return 0;
         return Math.min(10, Math.ceil(totalGames / 2));
       }
       ```

  6. Create `apps/desktop/src/store/rivalry-store.ts`:
     - Zustand store, state: `rivals: Rival[]`, `loading: boolean`
     - Actions:
       - `loadRivals(dynastyId: string)` — calls getRivalsByDynasty, sets rivals
       - `addRival(input: Omit<Rival, 'id' | 'createdAt' | 'updatedAt'>, dynastyId: string)` — calls createRival, then loadRivals(dynastyId)
       - `editRival(id: string, updates: Partial<Pick<Rival, 'label' | 'opponent'>>, dynastyId: string)` — calls updateRival, then loadRivals(dynastyId)
       - `removeRival(id: string, dynastyId: string)` — calls deleteRival, then loadRivals(dynastyId)

  7. Update `apps/desktop/src/store/index.ts` — add:
     ```ts
     export { useRivalryStore } from './rivalry-store';
     ```
  </action>
  <verify>Run `cd /Users/chanmoore/dev/dynasty-os && pnpm turbo build --filter=@dynasty-os/db --filter=@dynasty-os/core-types` — both packages must compile with no type errors. Check schema.ts has rivals and scoutingNotes tables and DB_VERSION = 4.</verify>
  <done>DB_VERSION is 4 with rivals and scoutingNotes tables in schema. Rival type exported from core-types. rivalry-service.ts has CRUD + calculateRivalryIntensity pure function. useRivalryStore exported from store barrel. Full build passes.</done>
</task>

<task type="auto">
  <name>Task 2: Rivalry Tracker page, navigation wiring, Dashboard button</name>
  <files>
    apps/desktop/src/store/navigation-store.ts
    apps/desktop/src/pages/RivalryTrackerPage.tsx
    apps/desktop/src/pages/DashboardPage.tsx
    apps/desktop/src/App.tsx
  </files>
  <action>
  1. Update `apps/desktop/src/store/navigation-store.ts`:
     - Add `'rivalry-tracker'` to the Page type union.
     - Add `goToRivalryTracker: () => void` to NavigationActions interface.
     - Add action implementation:
       ```ts
       goToRivalryTracker: () => { set({ currentPage: 'rivalry-tracker', pageParams: {} }); },
       ```

  2. Create `apps/desktop/src/pages/RivalryTrackerPage.tsx`:
     - Imports: useRivalryStore, useDynastyStore, useNavigationStore from ../store; getHeadToHeadRecords, HeadToHeadRecord from ../lib/records-service; calculateRivalryIntensity from ../lib/rivalry-service; React useState, useEffect.
     - Layout: dark theme (bg-gray-900 text-white), header with "Rivalry Tracker" title, back button (goToDashboard). No CFB-only guard — rivalries are sport-agnostic.
     - On mount: call `useRivalryStore.getState().loadRivals(activeDynasty.id)` and load all H2H records: `setH2hRecords(await getHeadToHeadRecords(activeDynasty.id))`.
     - State: `h2hRecords: HeadToHeadRecord[]` (loaded async on mount), `rivalForm: { opponent: string; label: string }` (controlled inputs), `editingId: string | null`.

     - **"Add Rival" form** (top of page):
       - Opponent field: text input (user types exact opponent name). Helper text: "Must match the opponent name in your game log exactly."
       - Label field: text input for custom rivalry name (e.g., "The Iron Bowl"). Optional.
       - Submit button "Add Rival". On submit: call `addRival({ dynastyId: activeDynasty.id, opponent: rivalForm.opponent.trim(), label: rivalForm.label.trim() || rivalForm.opponent.trim() }, activeDynasty.id)`. Clear form after submit. If an existing rival already has this opponent name, show inline error "Already tracking this rival."

     - **Rivals list** (main section):
       - If no rivals: show empty state "No rivals yet. Designate opponents above to start tracking rivalries."
       - For each rival, find the matching HeadToHeadRecord from h2hRecords where `record.opponent === rival.opponent` (case-sensitive match).
       - Rival card layout (dark card bg-gray-800 rounded-lg p-4):
         - Header row: rival.label (text-lg font-bold text-white) + rival.opponent in parentheses (text-gray-400 text-sm) + delete button (X icon, text-red-400).
         - If H2H record found:
           - Record row: "{wins}-{losses}{ties > 0 ? `-${ties}` : ''}" (text-2xl font-bold, green if winPct >= 0.5, red if < 0.5)
           - Streak indicator: "W{count}" (text-green-400) or "L{count}" (text-red-400) based on currentStreak.type and count. Label: "Current streak"
           - Intensity badge: "Intensity: {intensity}/10" where intensity = calculateRivalryIntensity(record.totalGames). Style: amber badge (bg-amber-600/20 text-amber-400 px-2 py-0.5 rounded text-sm). Show filled pips for visual: render intensity number of amber circles + (10 - intensity) gray circles.
           - Recent games: last 3 games from record.games (sorted by year/week descending), shown as compact rows: "YEAR W14 — W 35-21" or "YEAR W7 — L 14-28".
         - If no H2H record (opponent never played): show "No games logged vs {rival.opponent} yet."
         - Edit label: show "Edit Label" button that opens inline edit (replace label text with input + save button).

  3. Update `apps/desktop/src/pages/DashboardPage.tsx`:
     - Add a new amber button in the existing CFB Program section (inside the `activeDynasty.sport === 'cfb'` guard):
       ```tsx
       <button
         onClick={() => useNavigationStore.getState().goToRivalryTracker()}
         className="w-full px-4 py-2.5 bg-amber-600 hover:bg-amber-500 text-white text-sm font-semibold rounded-lg transition-colors"
       >
         Rivalry Tracker
       </button>
       ```
     - Place after the "Prestige Tracker" button (as the 5th CFB Program button).

  4. Update `apps/desktop/src/App.tsx`:
     - Import RivalryTrackerPage.
     - Add `case 'rivalry-tracker': return <RivalryTrackerPage />;` to the switch.
  </action>
  <verify>Run `cd /Users/chanmoore/dev/dynasty-os && pnpm turbo build` — full build passes with no type errors. Verify navigation-store.ts has 'rivalry-tracker' in Page type and goToRivalryTracker helper. Verify App.tsx has 'rivalry-tracker' case. Verify DashboardPage.tsx has "Rivalry Tracker" button.</verify>
  <done>RivalryTrackerPage shows add-rival form, rival cards with H2H record (wins-losses from game log), current streak indicator, intensity score (1-10 pips), and recent games. Navigation wired: Dashboard CFB Program section has Rivalry Tracker button. App.tsx routes 'rivalry-tracker'. Build passes.</done>
</task>

</tasks>

<verification>
1. `pnpm turbo build` passes with no errors
2. DB_VERSION = 4 with rivals and scoutingNotes tables in schema.ts
3. dynasty-db.ts declares `rivals: Table<Rival, string>` and `scoutingNotes: Table<Record<string, unknown>, string>`
4. Rival type exported from packages/core-types/src/index.ts
5. calculateRivalryIntensity pure function: Math.min(10, Math.ceil(totalGames / 2))
6. RivalryTrackerPage calls getHeadToHeadRecords — no re-implementation of H2H logic
7. Intensity displayed as pip indicators (amber filled + gray empty)
8. Dashboard has "Rivalry Tracker" button in CFB Program section
9. navigation-store.ts has 'rivalry-tracker' page type and goToRivalryTracker helper
</verification>

<success_criteria>
- User can add a rival by opponent name and custom label
- H2H record (wins-losses-ties) and current streak auto-calculate from game log via existing getHeadToHeadRecords
- Intensity score (1-10) displays as pip indicators beside streak
- Rival cards show last 3 games for quick context
- DB v4 migration is live with rivals and scoutingNotes tables ready for 06-03
- Full build compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/06-social-and-legacy/06-01-SUMMARY.md`
</output>
