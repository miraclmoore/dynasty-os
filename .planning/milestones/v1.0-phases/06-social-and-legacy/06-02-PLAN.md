---
phase: 06-social-and-legacy
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/desktop/src/lib/timeline-service.ts
  - apps/desktop/src/store/navigation-store.ts
  - apps/desktop/src/pages/ProgramTimelinePage.tsx
  - apps/desktop/src/pages/DashboardPage.tsx
  - apps/desktop/src/App.tsx
autonomous: true

must_haves:
  truths:
    - "User can see the full dynasty history as a scrollable timeline with one node per season"
    - "Each season node shows record, final ranking, bowl result, tagline, and key events"
    - "User can export the Program Timeline as a PDF file saved to their computer"
    - "Program Timeline is accessible from the Dashboard CFB Program section"
  artifacts:
    - path: "apps/desktop/src/lib/timeline-service.ts"
      provides: "Season data aggregation for timeline nodes including tagline from localStorage"
      exports: ["getTimelineNodes", "TimelineNode"]
    - path: "apps/desktop/src/pages/ProgramTimelinePage.tsx"
      provides: "Scrollable timeline UI with PDF export"
      contains: "window.print"
  key_links:
    - from: "apps/desktop/src/lib/timeline-service.ts"
      to: "@dynasty-os/db"
      via: "db.seasons + db.games queries"
      pattern: "db\\.seasons"
    - from: "apps/desktop/src/pages/ProgramTimelinePage.tsx"
      to: "timeline-service.ts"
      via: "getTimelineNodes(dynastyId) call"
      pattern: "getTimelineNodes"
    - from: "apps/desktop/src/pages/ProgramTimelinePage.tsx"
      to: "localStorage"
      via: "tagline lookup per seasonId: dynasty-os-narrative-{seasonId}"
      pattern: "dynasty-os-narrative"
---

<objective>
Build the Program Timeline — a service that aggregates per-season data into timeline nodes (pulling taglines from localStorage narrative cache), a scrollable timeline UI showing one node per season from dynasty start to present, and PDF export using window.print() with CSS @media print styling so no extra dependencies are needed.

Purpose: The Program Timeline is the dynasty's living history — a single scroll through every season that compounds into a story. Combined with taglines from the narrative engine, it transforms raw win-loss data into a chronicle.

Output: timeline-service.ts with data aggregation, ProgramTimelinePage with scrollable nodes and CSS print export, Dashboard and App.tsx wired.
</objective>

<execution_context>
@/Users/chanmoore/.claude/get-shit-done/workflows/execute-plan.md
@/Users/chanmoore/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@packages/db/src/dynasty-db.ts
@packages/core-types/src/season.ts
@apps/desktop/src/lib/season-service.ts
@apps/desktop/src/store/navigation-store.ts
@apps/desktop/src/pages/DashboardPage.tsx
@apps/desktop/src/pages/PrestigeTrackerPage.tsx
@apps/desktop/src/App.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Timeline service — season node aggregation with tagline extraction</name>
  <files>
    apps/desktop/src/lib/timeline-service.ts
  </files>
  <action>
  Create `apps/desktop/src/lib/timeline-service.ts`:

  1. Define and export the `TimelineNode` interface:
     ```ts
     export interface TimelineNode {
       seasonId: string;
       year: number;
       wins: number;
       losses: number;
       confWins: number;
       confLosses: number;
       finalRanking: number | null;
       bowlGame: string | null;
       bowlResult: 'W' | 'L' | null;
       bowlOpponent: string | null;
       tagline: string | null;         // from localStorage narrative cache
       keyEvents: string[];            // from season.keyEvents
     }
     ```

  2. Export `getTimelineNodes(dynastyId: string): Promise<TimelineNode[]>`:
     - Import db from @dynasty-os/db.
     - Query: `const seasons = await db.seasons.where('dynastyId').equals(dynastyId).toArray()`
     - Sort seasons by year ascending (oldest first — timeline reads chronologically from top).
     - For each season, construct a TimelineNode:
       - tagline: read from localStorage using key `dynasty-os-narrative-${season.id}`. Parse JSON and extract `.tagline`. If key missing or parse fails, tagline = null. Do NOT throw — wrap in try/catch, return null on error.
       - keyEvents: season.keyEvents ?? []
       - All other fields map directly from Season.
     - Return the array of TimelineNode sorted by year ascending.

  Note: The timeline service is pure read — no writes, no Zustand store needed. ProgramTimelinePage calls getTimelineNodes directly.
  </action>
  <verify>Run `cd /Users/chanmoore/dev/dynasty-os && pnpm turbo build --filter=desktop` — must compile with no type errors. Confirm timeline-service.ts exports TimelineNode interface and getTimelineNodes function.</verify>
  <done>timeline-service.ts exports TimelineNode interface and getTimelineNodes(dynastyId) that returns seasons sorted oldest-first with taglines pulled from localStorage narrative cache (null if not cached).</done>
</task>

<task type="auto">
  <name>Task 2: Program Timeline page with CSS print export, navigation, and Dashboard button</name>
  <files>
    apps/desktop/src/store/navigation-store.ts
    apps/desktop/src/pages/ProgramTimelinePage.tsx
    apps/desktop/src/pages/DashboardPage.tsx
    apps/desktop/src/App.tsx
  </files>
  <action>
  1. Update `apps/desktop/src/store/navigation-store.ts`:
     - Add `'program-timeline'` to the Page type union.
     - Add `goToProgramTimeline: () => void` to NavigationActions interface.
     - Add action:
       ```ts
       goToProgramTimeline: () => { set({ currentPage: 'program-timeline', pageParams: {} }); },
       ```

  2. Create `apps/desktop/src/pages/ProgramTimelinePage.tsx`:
     - Imports: getTimelineNodes, TimelineNode from ../lib/timeline-service; useDynastyStore, useNavigationStore from ../store; React useState, useEffect.
     - On mount: call `getTimelineNodes(activeDynasty.id)` and set nodes into local state.
     - No CFB-only guard — timeline is sport-agnostic.
     - Layout: dark theme (bg-gray-900 text-white), header with "Program Timeline" title and back button (goToDashboard). Export button (outlined amber button, "Export PDF") in the header row alongside the title.

     - **PDF Export** (no external library — use window.print()):
       - Export button onClick: call `window.print()`.
       - Add a `<style>` tag (injected via a `<style jsx global>` or via a simple `<style>` element in the JSX) with @media print rules:
         ```css
         @media print {
           body { background: white !important; color: black !important; }
           .no-print { display: none !important; }
           .timeline-node { page-break-inside: avoid; border: 1px solid #ccc; }
         }
         ```
       - Add className `no-print` to the back button and export button so they disappear in PDF.
       - The timeline nodes themselves render in black-and-white print-friendly layout.

     - **Timeline nodes** (scrollable vertical list):
       - Render nodes oldest-first (year ascending from service).
       - Each node: a card with a vertical left accent line (connecting cards visually like a timeline).
       - Node layout (bg-gray-800 rounded-lg p-4 mb-4 relative border-l-4):
         - Year badge: large year number (text-xl font-bold text-amber-400).
         - Record: "{wins}-{losses}" in large text (text-2xl font-bold). If confWins + confLosses > 0, show "({confWins}-{confLosses} conf)" in smaller text below.
         - Final ranking: if not null, "Final Ranking: #{finalRanking}" with a small trophy icon (or just "#N" in amber).
         - Bowl result: if bowlGame not null, show "{bowlResult === 'W' ? 'Won' : 'Lost'} {bowlGame} vs {bowlOpponent}" with green/red coloring.
         - Tagline: if not null, show in italic text (text-gray-300 italic text-sm) with a quote mark prefix. If null, don't render the tagline section.
         - Key events: if keyEvents.length > 0, show a bullet list (text-gray-400 text-sm) under the tagline.
       - If no nodes (no seasons logged): show empty state "No seasons logged yet. Start logging seasons to build your program timeline."

  3. Update `apps/desktop/src/pages/DashboardPage.tsx`:
     - Add amber button in the CFB Program section (inside `activeDynasty.sport === 'cfb'` guard):
       ```tsx
       <button
         onClick={() => useNavigationStore.getState().goToProgramTimeline()}
         className="w-full px-4 py-2.5 bg-amber-600 hover:bg-amber-500 text-white text-sm font-semibold rounded-lg transition-colors"
       >
         Program Timeline
       </button>
       ```
     - Place after the "Rivalry Tracker" button (6th CFB Program button).

  4. Update `apps/desktop/src/App.tsx`:
     - Import ProgramTimelinePage.
     - Add `case 'program-timeline': return <ProgramTimelinePage />;` to the switch.
  </action>
  <verify>Run `cd /Users/chanmoore/dev/dynasty-os && pnpm turbo build` — full build passes. Verify ProgramTimelinePage.tsx contains `window.print()`. Verify navigation-store.ts has 'program-timeline' in Page type and goToProgramTimeline helper. Verify App.tsx has 'program-timeline' case. Verify DashboardPage.tsx has "Program Timeline" button.</verify>
  <done>ProgramTimelinePage renders scrollable season nodes (year, record, ranking, bowl, tagline, key events) with window.print() PDF export and no-print CSS for UI buttons. Navigation wired from Dashboard CFB Program section. App.tsx routes 'program-timeline'. Build passes.</done>
</task>

</tasks>

<verification>
1. `pnpm turbo build` passes with no errors
2. getTimelineNodes returns seasons sorted year ascending with taglines from localStorage
3. Tagline lookup: `JSON.parse(localStorage.getItem('dynasty-os-narrative-${seasonId}'))?.tagline` wrapped in try/catch
4. ProgramTimelinePage uses window.print() for PDF export — no @react-pdf/renderer or jsPDF imports
5. @media print CSS hides no-print elements (back button, export button)
6. Each season node shows: year, record, conf record, final ranking, bowl result, tagline, key events
7. navigation-store.ts has 'program-timeline' type and goToProgramTimeline helper
8. Dashboard has "Program Timeline" button in CFB Program section
9. No Zustand store created — ProgramTimelinePage calls getTimelineNodes directly (read-only service)
</verification>

<success_criteria>
- Program Timeline shows one node per season from dynasty start to present (oldest first)
- Each node displays record, ranking, bowl result, tagline (if cached), and key events
- Export PDF button calls window.print() — no extra library dependencies
- Print CSS hides navigation buttons and shows clean black-on-white layout
- Full build compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/06-social-and-legacy/06-02-SUMMARY.md`
</output>
