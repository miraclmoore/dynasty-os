---
phase: 05-cfb-features
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/core-types/src/recruiting.ts
  - packages/core-types/src/transfer-portal.ts
  - packages/core-types/src/draft.ts
  - packages/core-types/src/prestige.ts
  - packages/core-types/src/index.ts
  - packages/db/src/schema.ts
  - packages/db/src/dynasty-db.ts
  - apps/desktop/src/lib/recruiting-service.ts
  - apps/desktop/src/store/recruiting-store.ts
  - apps/desktop/src/store/index.ts
  - apps/desktop/src/store/navigation-store.ts
  - apps/desktop/src/pages/RecruitingPage.tsx
  - apps/desktop/src/pages/DashboardPage.tsx
  - apps/desktop/src/App.tsx
autonomous: true

must_haves:
  truths:
    - "User can create a recruiting class for a dynasty season with class rank and star breakdown"
    - "User can add individual recruits to a class with name, position, stars, state, national rank"
    - "User can generate an AI recruiting grade and analysis for a class via Claude Haiku"
    - "User can browse recruiting class history across all dynasty seasons"
    - "CFB-only features are hidden for Madden dynasties"
    - "DB schema includes all 5 new tables (recruitingClasses, recruits, transferPortalEntries, draftPicks, prestigeRatings) in one version bump"
  artifacts:
    - path: "packages/core-types/src/recruiting.ts"
      provides: "RecruitingClass and Recruit type definitions"
      exports: ["RecruitingClass", "Recruit"]
    - path: "packages/db/src/schema.ts"
      provides: "Updated SCHEMA with 5 new tables, bumped DB_VERSION"
      contains: "recruitingClasses"
    - path: "packages/db/src/dynasty-db.ts"
      provides: "Table declarations for all 5 new tables"
      contains: "recruitingClasses"
    - path: "apps/desktop/src/lib/recruiting-service.ts"
      provides: "CRUD for recruiting classes and recruits, AI grade generation"
      exports: ["createRecruitingClass", "getRecruitingClassesByDynasty", "addRecruit", "generateClassGrade"]
    - path: "apps/desktop/src/store/recruiting-store.ts"
      provides: "Zustand store for recruiting state"
      exports: ["useRecruitingStore"]
    - path: "apps/desktop/src/pages/RecruitingPage.tsx"
      provides: "Recruiting class entry, recruit log, AI grade display, class history browser"
  key_links:
    - from: "apps/desktop/src/lib/recruiting-service.ts"
      to: "@dynasty-os/db"
      via: "db.recruitingClasses and db.recruits"
      pattern: "db\\.recruitingClasses"
    - from: "apps/desktop/src/lib/recruiting-service.ts"
      to: "legacy-card-service.ts"
      via: "getApiKey() import for Claude API key"
      pattern: "getApiKey"
    - from: "apps/desktop/src/store/recruiting-store.ts"
      to: "recruiting-service.ts"
      via: "service function calls in store actions"
      pattern: "import.*recruiting-service"
    - from: "apps/desktop/src/pages/RecruitingPage.tsx"
      to: "recruiting-store.ts"
      via: "useRecruitingStore hook"
      pattern: "useRecruitingStore"
    - from: "apps/desktop/src/pages/DashboardPage.tsx"
      to: "navigation-store.ts"
      via: "navigate('recruiting') button in Actions panel"
      pattern: "goToRecruiting"
---

<objective>
Add all 5 new DB tables for Phase 5 (recruiting classes, recruits, transfer portal entries, draft picks, prestige ratings) in a single Dexie version bump, then build the complete recruiting module — types, service layer with Claude Haiku AI grading, Zustand store, recruiting page UI, and navigation wiring.

Purpose: This is the foundation plan for Phase 5. The DB migration must happen here so all subsequent plans (05-02, 05-03, 05-04) can use their tables without migration conflicts. The recruiting module is the most complex CFB feature with AI integration.

Output: DB schema v3 with 5 new tables, RecruitingClass/Recruit types, full recruiting CRUD service with AI grade generation, recruiting Zustand store, RecruitingPage with class entry + recruit log + AI grade + history browser, dashboard and navigation wired up.
</objective>

<execution_context>
@/Users/chanmoore/.claude/get-shit-done/workflows/execute-plan.md
@/Users/chanmoore/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@packages/core-types/src/index.ts
@packages/core-types/src/dynasty.ts
@packages/core-types/src/player.ts
@packages/db/src/schema.ts
@packages/db/src/dynasty-db.ts
@apps/desktop/src/lib/player-service.ts
@apps/desktop/src/lib/legacy-card-service.ts
@apps/desktop/src/lib/narrative-service.ts
@apps/desktop/src/store/navigation-store.ts
@apps/desktop/src/store/index.ts
@apps/desktop/src/App.tsx
@apps/desktop/src/pages/DashboardPage.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: DB schema migration and core types for all Phase 5 entities</name>
  <files>
    packages/core-types/src/recruiting.ts
    packages/core-types/src/transfer-portal.ts
    packages/core-types/src/draft.ts
    packages/core-types/src/prestige.ts
    packages/core-types/src/index.ts
    packages/db/src/schema.ts
    packages/db/src/dynasty-db.ts
  </files>
  <action>
  1. Create `packages/core-types/src/recruiting.ts`:
     ```ts
     export interface RecruitingClass {
       id: string;
       dynastyId: string;
       seasonId: string;
       year: number;
       classRank: number;
       totalCommits: number;
       fiveStars: number;
       fourStars: number;
       threeStars: number;
       aiGrade?: string;       // e.g. "A-", nullable until generated
       aiAnalysis?: string;    // 2-3 sentence analysis, nullable
       aiGeneratedAt?: number; // timestamp
       createdAt: number;
       updatedAt: number;
     }

     export interface Recruit {
       id: string;
       dynastyId: string;
       classId: string;         // FK to RecruitingClass
       name: string;
       position: string;
       stars: number;           // 1-5
       state?: string;
       nationalRank?: number;
       createdAt: number;
       updatedAt: number;
     }
     ```

  2. Create `packages/core-types/src/transfer-portal.ts`:
     ```ts
     export interface TransferPortalEntry {
       id: string;
       dynastyId: string;
       seasonId: string;
       year: number;
       type: 'arrival' | 'departure';
       playerName: string;
       position: string;
       stars?: number;              // arrival only
       originSchool?: string;       // arrival only
       destinationSchool?: string;  // departure only
       createdAt: number;
       updatedAt: number;
     }
     ```

  3. Create `packages/core-types/src/draft.ts`:
     ```ts
     export interface DraftPick {
       id: string;
       dynastyId: string;
       seasonId: string;          // season player was drafted FROM
       year: number;
       playerId?: string;         // nullable FK to Player
       playerName: string;
       position: string;
       round: number;             // 1-7
       pickNumber?: number;
       nflTeam: string;
       createdAt: number;
       updatedAt: number;
     }
     ```

  4. Create `packages/core-types/src/prestige.ts`:
     ```ts
     export interface PrestigeRating {
       id: string;
       dynastyId: string;
       year: number;
       rating: number;            // 1-100
       recruitingRank?: number;   // for overlay on chart
       createdAt: number;
       updatedAt: number;
     }
     ```

  5. Update `packages/core-types/src/index.ts` — add 4 new exports:
     ```ts
     export * from './recruiting';
     export * from './transfer-portal';
     export * from './draft';
     export * from './prestige';
     ```

  6. Update `packages/db/src/schema.ts`:
     - Add 5 new tables to SCHEMA:
       ```ts
       recruitingClasses: 'id, dynastyId, seasonId, year, [dynastyId+year]',
       recruits: 'id, dynastyId, classId, [classId]',
       transferPortalEntries: 'id, dynastyId, seasonId, year, [dynastyId+seasonId]',
       draftPicks: 'id, dynastyId, seasonId, year, playerId, [dynastyId+year]',
       prestigeRatings: 'id, dynastyId, year, [dynastyId+year]',
       ```
     - Bump DB_VERSION from 2 to 3.

  7. Update `packages/db/src/dynasty-db.ts`:
     - Import the 5 new types from @dynasty-os/core-types: RecruitingClass, Recruit, TransferPortalEntry, DraftPick, PrestigeRating.
     - Add 5 new Table declarations:
       ```ts
       recruitingClasses!: Table<RecruitingClass, string>;
       recruits!: Table<Recruit, string>;
       transferPortalEntries!: Table<TransferPortalEntry, string>;
       draftPicks!: Table<DraftPick, string>;
       prestigeRatings!: Table<PrestigeRating, string>;
       ```
     - Keep existing version(1).stores(SCHEMA) and version(DB_VERSION).stores(SCHEMA) pattern.
  </action>
  <verify>Run `cd /Users/chanmoore/dev/dynasty-os && pnpm turbo build --filter=@dynasty-os/core-types --filter=@dynasty-os/db` — must compile with no type errors.</verify>
  <done>DB schema is at version 3 with all 5 new tables indexed. All 4 new type files export their interfaces. DynastyDB class has Table declarations for all new entities.</done>
</task>

<task type="auto">
  <name>Task 2: Recruiting service, store, page UI, and navigation wiring</name>
  <files>
    apps/desktop/src/lib/recruiting-service.ts
    apps/desktop/src/store/recruiting-store.ts
    apps/desktop/src/store/index.ts
    apps/desktop/src/store/navigation-store.ts
    apps/desktop/src/pages/RecruitingPage.tsx
    apps/desktop/src/pages/DashboardPage.tsx
    apps/desktop/src/App.tsx
  </files>
  <action>
  1. Create `apps/desktop/src/lib/recruiting-service.ts`:
     - Import db from @dynasty-os/db, types from @dynasty-os/core-types, generateId from ./uuid, getApiKey from ./legacy-card-service.
     - CRUD functions following player-service.ts pattern:
       - `createRecruitingClass(input: Omit<RecruitingClass, 'id' | 'createdAt' | 'updatedAt'>)` — add timestamps, generateId, db.recruitingClasses.add()
       - `getRecruitingClassesByDynasty(dynastyId: string)` — db.recruitingClasses.where('dynastyId').equals(dynastyId).toArray(), sort by year descending
       - `getRecruitingClass(id: string)` — db.recruitingClasses.get(id)
       - `updateRecruitingClass(id: string, updates: Partial<...>)` — db.recruitingClasses.update(id, { ...updates, updatedAt: Date.now() })
       - `deleteRecruitingClass(id: string)` — cascade-delete recruits first (db.recruits.where('classId').equals(id).delete()), then db.recruitingClasses.delete(id)
       - `addRecruit(input: Omit<Recruit, 'id' | 'createdAt' | 'updatedAt'>)` — add timestamps, generateId, db.recruits.add()
       - `getRecruitsByClass(classId: string)` — db.recruits.where('classId').equals(classId).toArray()
       - `deleteRecruit(id: string)` — db.recruits.delete(id)
     - AI grade generation:
       - `generateClassGrade(classId: string)` — async function:
         1. Get class from db
         2. Get recruits for class
         3. Get apiKey via getApiKey() — return null if missing
         4. Build user message with: class rank, star breakdown (5-star/4-star/3-star counts), total commits, position groups recruited (list unique positions from recruits), top recruits (up to 5, sorted by stars desc then nationalRank asc, format: "Name - Position - Stars - #NationalRank")
         5. Call Claude API (fetch to https://api.anthropic.com/v1/messages) with:
            - model: 'claude-haiku-4-5-20251001' (same model ID as legacy-card-service.ts)
            - max_tokens: 300
            - headers: same as legacy-card-service.ts (x-api-key, anthropic-version: '2023-06-01', content-type, NO anthropic-dangerous-direct-browser-access header since Haiku — actually DO include it, same as narrative-service.ts pattern to be safe)
            - system: "You are a college football recruiting analyst. Evaluate this recruiting class and provide a letter grade and brief analysis. Respond with exactly this format:\nGRADE: [A+/A/A-/B+/B/B-/C+/C/C-/D+/D/D-/F]\nANALYSIS: [2-3 sentences analyzing the class strengths, weaknesses, and position needs addressed]"
            - user message: formatted class data
         6. Parse response: extract GRADE line (regex /^GRADE:\s*(.+)$/m) and ANALYSIS line (regex /^ANALYSIS:\s*(.+)$/ms — multiline to capture all remaining text after ANALYSIS:)
         7. Update the RecruitingClass record: db.recruitingClasses.update(classId, { aiGrade, aiAnalysis, aiGeneratedAt: Date.now(), updatedAt: Date.now() })
         8. Return { aiGrade, aiAnalysis }
         9. Wrap entire function in try/catch — never throw, return null on failure, console.warn errors

  2. Create `apps/desktop/src/store/recruiting-store.ts`:
     - Zustand store following existing patterns (usePlayerStore etc.)
     - State: classes: RecruitingClass[], recruitsForClass: Recruit[], activeClass: RecruitingClass | null, loading: boolean
     - Actions:
       - `loadClasses(dynastyId: string)` — calls getRecruitingClassesByDynasty, sets classes
       - `loadRecruitsForClass(classId: string)` — calls getRecruitsByClass, sets recruitsForClass, sets activeClass
       - `createClass(input)` — calls createRecruitingClass, then loadClasses
       - `deleteClass(id, dynastyId)` — calls deleteRecruitingClass, then loadClasses
       - `addRecruit(input)` — calls addRecruit service, then loadRecruitsForClass(input.classId)
       - `removeRecruit(id, classId)` — calls deleteRecruit, then loadRecruitsForClass(classId)
       - `generateGrade(classId)` — calls generateClassGrade, then loadClasses, then loadRecruitsForClass(classId)

  3. Update `apps/desktop/src/store/index.ts` — add:
     ```ts
     export { useRecruitingStore } from './recruiting-store';
     ```

  4. Update `apps/desktop/src/store/navigation-store.ts`:
     - Add 4 new page types to the Page union: 'recruiting' | 'transfer-portal' | 'draft-tracker' | 'prestige-tracker'
     - Add navigation helpers:
       - `goToRecruiting: () => void` — set({ currentPage: 'recruiting', pageParams: {} })
       - `goToTransferPortal: () => void` — set({ currentPage: 'transfer-portal', pageParams: {} })
       - `goToDraftTracker: () => void` — set({ currentPage: 'draft-tracker', pageParams: {} })
       - `goToPrestigeTracker: () => void` — set({ currentPage: 'prestige-tracker', pageParams: {} })

  5. Create `apps/desktop/src/pages/RecruitingPage.tsx`:
     - Import useRecruitingStore, useDynastyStore, useSeasonStore, useNavigationStore
     - CFB-only guard: if activeDynasty.sport !== 'cfb', show message "Recruiting is only available for College Football dynasties." with a back-to-dashboard button.
     - Layout: dark theme (bg-gray-900 text-white) matching existing pages.
     - Header: "Recruiting" title, back button (goToDashboard), dynasty name.
     - Two views toggled by local state: 'entry' (current class entry) and 'history' (browse all classes).
     - **Entry view:**
       - Form to create/select a recruiting class for the active season: class rank (number input), star distribution (three number inputs for 5-star, 4-star, 3-star count), total commits (number input). Auto-calculate totalCommits = sum of star counts. Submit creates class.
       - If a class already exists for the active season, show it instead of creation form.
       - Active class panel: show class rank, star breakdown, total commits.
       - Recruits table below: columns Name, Position, Stars (1-5 select), State, National Rank. Add Recruit form at top (inline or small form).
       - Delete recruit button (X icon) per row.
       - AI Grade section: if class has aiGrade, display grade badge (large text, colored — A range green, B range blue, C range yellow, D/F range red) and analysis text. If no grade yet, show "Generate Signing Day Grade" button (amber bg, matches dashboard amber AI buttons). Button calls generateGrade. Show loading spinner during API call.
     - **History view:**
       - List of all recruiting classes for dynasty, sorted newest first (year desc).
       - Each class shown as a card: year, class rank, star breakdown, total commits, aiGrade badge (if present), first sentence of aiAnalysis (if present).
       - Click a card to navigate to entry view with that class selected (set activeClass).
     - Load classes on mount (loadClasses with activeDynasty.id).

  6. Update `apps/desktop/src/App.tsx`:
     - Import RecruitingPage.
     - Add case 'recruiting': return <RecruitingPage /> to the switch.
     - (Do NOT add cases for transfer-portal, draft-tracker, prestige-tracker yet — those plans will add their own cases)

  7. Update `apps/desktop/src/pages/DashboardPage.tsx`:
     - In the Actions panel (the div with "Actions" h3), add a new section AFTER existing buttons but BEFORE the modals div.
     - Guard: only show CFB buttons if activeDynasty.sport === 'cfb'.
     - Add 4 new buttons (all amber background to match AI/narrative features):
       ```tsx
       {activeDynasty.sport === 'cfb' && (
         <>
           <div className="border-t border-gray-700 mt-2 pt-2">
             <h4 className="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">CFB Program</h4>
           </div>
           <button onClick={() => useNavigationStore.getState().goToRecruiting()}
             className="w-full px-4 py-2.5 bg-amber-600 hover:bg-amber-500 text-white text-sm font-semibold rounded-lg transition-colors">
             Recruiting
           </button>
           <button onClick={() => useNavigationStore.getState().goToTransferPortal()}
             className="w-full px-4 py-2.5 bg-amber-600 hover:bg-amber-500 text-white text-sm font-semibold rounded-lg transition-colors">
             Transfer Portal
           </button>
           <button onClick={() => useNavigationStore.getState().goToDraftTracker()}
             className="w-full px-4 py-2.5 bg-amber-600 hover:bg-amber-500 text-white text-sm font-semibold rounded-lg transition-colors">
             NFL Draft Tracker
           </button>
           <button onClick={() => useNavigationStore.getState().goToPrestigeTracker()}
             className="w-full px-4 py-2.5 bg-amber-600 hover:bg-amber-500 text-white text-sm font-semibold rounded-lg transition-colors">
             Program Prestige
           </button>
         </>
       )}
       ```
  </action>
  <verify>Run `cd /Users/chanmoore/dev/dynasty-os && pnpm turbo build` — full build must pass with no type errors. Verify RecruitingPage renders by checking App.tsx switch covers 'recruiting' case.</verify>
  <done>Recruiting service has full CRUD + AI grade generation via Claude Haiku. Recruiting store manages classes/recruits state. RecruitingPage shows class entry form, recruit table, AI grade display, and class history browser. Navigation store has 4 new page types. Dashboard shows CFB Program section with 4 amber buttons (guarded by sport === 'cfb'). App.tsx routes to RecruitingPage.</done>
</task>

</tasks>

<verification>
1. `pnpm turbo build` passes with no errors
2. DB schema has version 3 with all 5 new table definitions in SCHEMA constant
3. DynastyDB class declares Table properties for all 5 new entities
4. RecruitingPage has CFB-only guard (sport !== 'cfb' shows message)
5. AI grade generation uses claude-haiku-4-5-20251001 model via getApiKey() from legacy-card-service.ts
6. Dashboard Actions panel shows 4 new CFB buttons only when activeDynasty.sport === 'cfb'
7. Navigation store Page type union includes 'recruiting', 'transfer-portal', 'draft-tracker', 'prestige-tracker'
</verification>

<success_criteria>
- DB version bumped to 3 with recruitingClasses, recruits, transferPortalEntries, draftPicks, prestigeRatings tables
- Core types exported for all 5 new entities
- User can create a recruiting class, add recruits, generate AI grade, and browse class history
- CFB-only guard prevents non-CFB dynasties from accessing recruiting
- Dashboard has 4 amber CFB Program buttons (only visible for CFB dynasties)
- Full build compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/05-cfb-features/05-01-SUMMARY.md`
</output>
