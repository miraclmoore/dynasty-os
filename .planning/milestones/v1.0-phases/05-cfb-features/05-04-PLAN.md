---
phase: 05-cfb-features
plan: 04
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - apps/desktop/src/lib/prestige-service.ts
  - apps/desktop/src/store/prestige-store.ts
  - apps/desktop/src/store/index.ts
  - apps/desktop/src/pages/PrestigeTrackerPage.tsx
  - apps/desktop/src/App.tsx
autonomous: true

must_haves:
  truths:
    - "User can log an annual prestige rating (1-100) with optional recruiting rank"
    - "Prestige trend auto-calculates as up/down/stable vs prior 3 years"
    - "User can see a year-over-year SVG line chart of prestige ratings with recruiting rank overlay"
    - "Prestige tracker features are hidden for Madden dynasties"
  artifacts:
    - path: "apps/desktop/src/lib/prestige-service.ts"
      provides: "CRUD for prestige ratings and trend calculation"
      exports: ["createPrestigeRating", "getPrestigeRatingsByDynasty", "deletePrestigeRating", "calculatePrestigeTrend"]
    - path: "apps/desktop/src/store/prestige-store.ts"
      provides: "Zustand store for prestige state"
      exports: ["usePrestigeStore"]
    - path: "apps/desktop/src/pages/PrestigeTrackerPage.tsx"
      provides: "Prestige rating entry, trend display, SVG chart with recruiting rank overlay"
  key_links:
    - from: "apps/desktop/src/lib/prestige-service.ts"
      to: "@dynasty-os/db"
      via: "db.prestigeRatings"
      pattern: "db\\.prestigeRatings"
    - from: "apps/desktop/src/store/prestige-store.ts"
      to: "prestige-service.ts"
      via: "service function calls"
      pattern: "import.*prestige-service"
    - from: "apps/desktop/src/pages/PrestigeTrackerPage.tsx"
      to: "prestige-store.ts"
      via: "usePrestigeStore hook"
      pattern: "usePrestigeStore"
---

<objective>
Build the program prestige tracker — service layer for logging annual prestige ratings, trend calculation, Zustand store, and a Prestige Tracker page with rating entry, trend indicator, and a simple SVG line chart showing year-over-year prestige with recruiting rank overlay.

Purpose: Prestige ratings track program trajectory over time. Seeing whether the program is rising, stable, or declining gives coaches a macro view of their dynasty's arc beyond just win-loss records.

Output: Prestige service with CRUD + trend calculation, Zustand store, PrestigeTrackerPage with entry form, trend badge, and SVG chart (no external chart library).
</objective>

<execution_context>
@/Users/chanmoore/.claude/get-shit-done/workflows/execute-plan.md
@/Users/chanmoore/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-cfb-features/05-01-SUMMARY.md

@packages/core-types/src/prestige.ts
@packages/db/src/dynasty-db.ts
@apps/desktop/src/lib/player-service.ts
@apps/desktop/src/store/navigation-store.ts
@apps/desktop/src/App.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Prestige service and store</name>
  <files>
    apps/desktop/src/lib/prestige-service.ts
    apps/desktop/src/store/prestige-store.ts
    apps/desktop/src/store/index.ts
  </files>
  <action>
  1. Create `apps/desktop/src/lib/prestige-service.ts`:
     - Import db from @dynasty-os/db, PrestigeRating from @dynasty-os/core-types, generateId from ./uuid.
     - CRUD functions:
       - `createPrestigeRating(input: Omit<PrestigeRating, 'id' | 'createdAt' | 'updatedAt'>)` — add timestamps, generateId, db.prestigeRatings.add(), return the rating
       - `getPrestigeRatingsByDynasty(dynastyId: string)` — db.prestigeRatings.where('dynastyId').equals(dynastyId).toArray(), sort by year ascending
       - `updatePrestigeRating(id: string, updates: Partial<Omit<PrestigeRating, 'id' | 'dynastyId' | 'createdAt'>>)` — db.prestigeRatings.update(id, { ...updates, updatedAt: Date.now() })
       - `deletePrestigeRating(id: string)` — db.prestigeRatings.delete(id)
     - Trend calculation helper (pure function, exported):
       - `calculatePrestigeTrend(ratings: PrestigeRating[]): { trend: 'up' | 'down' | 'stable', currentRating: number | null, priorAvg: number | null }`
       - Sort ratings by year ascending.
       - If fewer than 2 ratings, return { trend: 'stable', currentRating: ratings[ratings.length-1]?.rating ?? null, priorAvg: null }.
       - currentRating = last rating's value.
       - priorRatings = up to 3 ratings before the last one (slice from end-4 to end-1, or all available if fewer than 3 prior).
       - priorAvg = average of prior ratings' rating values.
       - delta = currentRating - priorAvg.
       - If delta > 5: trend = 'up'. If delta < -5: trend = 'down'. Else: trend = 'stable'.

  2. Create `apps/desktop/src/store/prestige-store.ts`:
     - Zustand store with state: ratings: PrestigeRating[], loading: boolean
     - Actions:
       - `loadRatings(dynastyId: string)` — calls getPrestigeRatingsByDynasty, sets ratings
       - `addRating(input, dynastyId)` — calls createPrestigeRating, then loadRatings(dynastyId)
       - `editRating(id, updates, dynastyId)` — calls updatePrestigeRating, then loadRatings(dynastyId)
       - `removeRating(id, dynastyId)` — calls deletePrestigeRating, then loadRatings(dynastyId)

  3. Update `apps/desktop/src/store/index.ts` — add:
     ```ts
     export { usePrestigeStore } from './prestige-store';
     ```
  </action>
  <verify>Run `cd /Users/chanmoore/dev/dynasty-os && pnpm turbo build --filter=desktop` — must compile with no type errors.</verify>
  <done>Prestige service has CRUD + trend calculation (up/down/stable based on 5-point threshold vs prior 3 years average). Store manages ratings state with load/add/edit/remove. Store exported from barrel.</done>
</task>

<task type="auto">
  <name>Task 2: Prestige Tracker page with SVG chart and App.tsx routing</name>
  <files>
    apps/desktop/src/pages/PrestigeTrackerPage.tsx
    apps/desktop/src/App.tsx
  </files>
  <action>
  1. Create `apps/desktop/src/pages/PrestigeTrackerPage.tsx`:
     - Import usePrestigeStore, useDynastyStore, useNavigationStore, calculatePrestigeTrend from prestige-service.
     - CFB-only guard: if activeDynasty.sport !== 'cfb', show "Program Prestige is only available for College Football dynasties." with back button.
     - Layout: dark theme (bg-gray-900 text-white), header with "Program Prestige" title, back button (goToDashboard).
     - Load ratings on mount: usePrestigeStore loadRatings(activeDynasty.id).
     - **Trend banner** (top):
       - Use calculatePrestigeTrend(ratings) to get trend, currentRating, priorAvg.
       - Display current rating as large text (text-4xl font-bold).
       - Trend indicator: up arrow (text-green-400) with "Rising", down arrow (text-red-400) with "Declining", horizontal arrow (text-gray-400) with "Stable".
       - If priorAvg is not null, show "vs {priorAvg.toFixed(1)} avg (prior 3 seasons)" as subtitle.
     - **Add/Edit rating form:**
       - Year (number input, default to dynasty currentYear), Rating (number input, 1-100, required), Recruiting Rank (optional number input).
       - Submit button "Log Rating".
       - If a rating already exists for that year, show it pre-filled with an "Update" button instead.
       - On submit: if existing rating for that year, call editRating. Otherwise call addRating.
     - **Ratings table:**
       - Columns: Year, Rating, Recruiting Rank, Trend Delta. Sort by year descending.
       - Trend Delta: difference from previous year's rating (show as +N green or -N red, or "—" for first year).
       - Delete button (X icon) per row.
     - **SVG chart** (below table):
       - Pure SVG, no external chart library.
       - Chart dimensions: width 100% (max 700px), height 300px. Use viewBox for responsive scaling.
       - X-axis: years. Y-axis: rating (0-100 scale).
       - Primary line: prestige rating (blue line, stroke-blue-400, strokeWidth 2).
       - Data points: circles (r=4, fill-blue-400) at each data point. On hover (title element), show "Year: {year}, Rating: {rating}".
       - Secondary line (if any ratings have recruitingRank): recruiting rank (amber line, stroke-amber-400, strokeWidth 2, strokeDasharray "4 4" for dashed).
         - Recruiting rank Y-axis: inverted scale (rank 1 at top, higher ranks toward bottom). Normalize: y = chartHeight - ((maxRank - rank) / maxRank) * chartHeight where maxRank = max(all recruitingRank values, 150) so the scale has headroom. Actually simpler: use a fixed scale of 1-150 for recruiting rank, where 1 is at the top and 150 is at the bottom.
       - Legend at bottom: blue circle + "Prestige Rating", amber dashed line + "Recruiting Rank".
       - Axis labels: Y-axis "Rating" on left, years on X-axis.
       - Grid lines: horizontal dashed lines at y=25, 50, 75 (light gray, opacity 0.2).
       - If fewer than 2 data points, show message "Log at least 2 seasons of prestige ratings to see the trend chart." instead of the SVG.
       - Implementation approach:
         - Compute chart area with padding (left: 50px for y-axis labels, right: 20px, top: 20px, bottom: 40px for x-axis labels).
         - Map each data point to SVG coordinates: x = padding.left + ((index) / (dataPoints.length - 1)) * chartWidth, y = padding.top + ((100 - rating) / 100) * chartHeight.
         - For recruiting rank line: y = padding.top + ((rank - 1) / (150 - 1)) * chartHeight (rank 1 at top, 150 at bottom).
         - Connect points with polyline or path.

  2. Update `apps/desktop/src/App.tsx`:
     - Import PrestigeTrackerPage.
     - Add case 'prestige-tracker': return <PrestigeTrackerPage /> to the switch.
  </action>
  <verify>Run `cd /Users/chanmoore/dev/dynasty-os && pnpm turbo build` — full build passes. Verify App.tsx switch has 'prestige-tracker' case. Verify PrestigeTrackerPage contains an <svg> element (no external chart library imports).</verify>
  <done>PrestigeTrackerPage shows trend banner (up/down/stable), rating entry form, ratings table with trend deltas, and SVG line chart with prestige rating + recruiting rank overlay. Chart uses pure SVG, no external library. App.tsx routes to PrestigeTrackerPage. CFB-only guard active.</done>
</task>

</tasks>

<verification>
1. `pnpm turbo build` passes with no errors
2. Prestige service exports CRUD + calculatePrestigeTrend
3. PrestigeTrackerPage has CFB-only guard
4. Trend calculation compares current rating vs average of up to 3 prior years with 5-point threshold
5. SVG chart renders prestige ratings as blue line and recruiting rank as amber dashed line
6. No external chart library imported — pure SVG
7. App.tsx routes 'prestige-tracker' to PrestigeTrackerPage
</verification>

<success_criteria>
- User can log annual prestige ratings (1-100) with optional recruiting rank
- Trend auto-calculates as up/down/stable vs prior 3 years (5-point threshold)
- SVG chart shows year-over-year prestige with recruiting rank overlay
- No external chart library used
- CFB-only guard prevents Madden dynasties from accessing this feature
- Full build compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/05-cfb-features/05-04-SUMMARY.md`
</output>
