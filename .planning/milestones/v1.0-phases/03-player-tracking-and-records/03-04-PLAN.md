---
phase: 03-player-tracking-and-records
plan: "04"
type: execute
wave: 4
depends_on: ["03-02", "03-03"]
files_modified:
  - apps/desktop/src/lib/records-service.ts
  - apps/desktop/src/components/RecordsLeaderboard.tsx
  - apps/desktop/src/components/HeadToHeadRecords.tsx
  - apps/desktop/src/pages/DashboardPage.tsx
  - apps/desktop/src/store/navigation-store.ts
  - apps/desktop/src/pages/RecordsPage.tsx
  - apps/desktop/src/App.tsx
autonomous: true

must_haves:
  truths:
    - "User can view single-season records showing top N per stat category for any season"
    - "User can view career records showing all-time top N per stat category across all seasons"
    - "User can view head-to-head all-time records against every opponent"
    - "User can filter H2H by era (year range)"
    - "Records update automatically as new player seasons and games are logged"
  artifacts:
    - path: "apps/desktop/src/lib/records-service.ts"
      provides: "Record computation functions"
      exports: ["getSingleSeasonLeaders", "getCareerLeaders", "getHeadToHeadRecords"]
    - path: "apps/desktop/src/components/RecordsLeaderboard.tsx"
      provides: "Leaderboard display component"
      min_lines: 60
    - path: "apps/desktop/src/components/HeadToHeadRecords.tsx"
      provides: "H2H record display component"
      min_lines: 50
    - path: "apps/desktop/src/pages/RecordsPage.tsx"
      provides: "Records and leaderboards page"
      min_lines: 100
  key_links:
    - from: "apps/desktop/src/lib/records-service.ts"
      to: "@dynasty-os/db"
      via: "Dexie queries for players, playerSeasons, games"
      pattern: "db\\.(players|playerSeasons|games)"
    - from: "apps/desktop/src/pages/RecordsPage.tsx"
      to: "apps/desktop/src/lib/records-service.ts"
      via: "service calls on mount and filter change"
      pattern: "getSingleSeasonLeaders|getCareerLeaders|getHeadToHeadRecords"
---

<objective>
Build records and leaderboards: single-season top N, career all-time top N, and head-to-head opponent records with year-range era filter.

Purpose: Leaderboards turn individual player stats into program-wide narratives — who is the all-time passing leader, which season had the best rushing performance, what's the all-time record vs the rival. These are the "bragging rights" features that keep users engaged.

Output: A Records page with three tabs: single-season records, career records, and head-to-head opponent records.
</objective>

<execution_context>
@/Users/chanmoore/.claude/get-shit-done/workflows/execute-plan.md
@/Users/chanmoore/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-player-tracking-and-records/03-01-SUMMARY.md
@.planning/phases/03-player-tracking-and-records/03-02-SUMMARY.md

Source files:
@packages/core-types/src/player.ts
@packages/core-types/src/game.ts
@packages/core-types/src/sport-config.ts
@apps/desktop/src/lib/game-service.ts
@apps/desktop/src/lib/career-stats.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Records service with single-season, career, and H2H computation</name>
  <files>
    apps/desktop/src/lib/records-service.ts
  </files>
  <action>
    **records-service.ts** — Computation functions that query DB and return ranked results:

    Define result types:
    ```typescript
    export interface LeaderboardEntry {
      playerId: string;
      playerName: string;  // "firstName lastName"
      position: string;
      value: number;
      year?: number;       // for single-season: which year
      seasonId?: string;   // for single-season: which season
    }

    export interface HeadToHeadRecord {
      opponent: string;
      wins: number;
      losses: number;
      ties: number;
      totalGames: number;
      winPct: number;
      currentStreak: { type: 'W' | 'L' | 'T'; count: number };
      games: Array<{ year: number; week: number; result: string; score: string }>;
    }
    ```

    **getSingleSeasonLeaders(dynastyId: string, statKey: string, limit: number = 10, seasonId?: string): Promise<LeaderboardEntry[]>**
    - If seasonId provided: query playerSeasons where seasonId matches
    - If no seasonId: query ALL playerSeasons for the dynasty
    - For each playerSeason, extract stats[statKey]. Skip if undefined or 0.
    - Join with players table to get playerName and position (db.players.get(playerId))
    - Sort descending by value, take top N
    - Return with year from the playerSeason

    **getCareerLeaders(dynastyId: string, statKey: string, limit: number = 10): Promise<LeaderboardEntry[]>**
    - Query all playerSeasons for the dynasty
    - Group by playerId, sum the stat across all their seasons (for integer stats) or compute weighted average (for decimal stats — same logic as career-stats.ts computeCareerStats)
    - Join with players table for name/position
    - Sort descending by career total, take top N

    **getHeadToHeadRecords(dynastyId: string, options?: { startYear?: number; endYear?: number }): Promise<HeadToHeadRecord[]>**
    - Query all games for the dynasty (via db.games.where('dynastyId').equals(dynastyId))
    - Group games by opponent name
    - For each opponent: count wins, losses, ties; compute win percentage
    - Calculate current streak: sort games by year+week descending, count consecutive same results from most recent
    - Build games array with year (need to join with seasons table for year), week, result, score ("{teamScore}-{opponentScore}")
    - If startYear/endYear provided: filter games to only those in seasons within the year range
    - Sort opponents by totalGames descending (most-played opponents first)
    - To get year for each game: need to look up the season. Optimization: load all seasons for the dynasty into a Map<seasonId, year> first, then use it for all games.

    All functions are async (DB queries). No caching — compute fresh each time (data set is small enough for local-first).
  </action>
  <verify>
    Run `pnpm run build` from root. TypeScript compiles cleanly. Verify records-service.ts exports 3 functions and the 2 interface types.
  </verify>
  <done>
    Single-season leaders query returns top N players for any stat key. Career leaders aggregates across all seasons per player. Head-to-head records compute W/L/T, win percentage, and current streak against every opponent with optional year range filter.
  </done>
</task>

<task type="auto">
  <name>Task 2: Records page with leaderboard and H2H components</name>
  <files>
    apps/desktop/src/components/RecordsLeaderboard.tsx
    apps/desktop/src/components/HeadToHeadRecords.tsx
    apps/desktop/src/pages/RecordsPage.tsx
    apps/desktop/src/store/navigation-store.ts
    apps/desktop/src/App.tsx
    apps/desktop/src/pages/DashboardPage.tsx
  </files>
  <action>
    **navigation-store.ts** — Add 'records' to the currentPage union type. Add `goToRecords()` action.

    **RecordsLeaderboard.tsx** — Reusable leaderboard display component:
    - Props: `entries: LeaderboardEntry[]`, `statLabel: string`, `showYear: boolean` (true for single-season, false for career)
    - Render a ranked table: rank (#), player name, position, value, year (if showYear)
    - Top 3 get visual emphasis (gold/silver/bronze or bold/highlighted)
    - Click a player name to navigate to their profile: useNavigationStore.getState().goToPlayerProfile(entry.playerId)
    - Empty state: "No records yet for this category"

    **HeadToHeadRecords.tsx** — Head-to-head display component:
    - Props: `records: HeadToHeadRecord[]`
    - Render a table: opponent name, record (W-L-T), win %, current streak, total games
    - Streak display: "W3" in green, "L2" in red, etc.
    - Click a row to expand and show individual game results (year, week, result, score) — use a collapsible detail section or accordion
    - Highlight dominant records (>= 75% win) in green tint, losing records (< 25%) in red tint

    **RecordsPage.tsx** — Full records page with three tabs:
    - Header: same style as other pages (dynasty name, sport badge, dynasty switcher)
    - "Back to Dashboard" navigation link
    - Tab bar: "Single-Season Records" | "Career Records" | "Head-to-Head"
    - **Single-Season tab:**
      - Stat category dropdown: populated from sport config statCategories (key + label)
      - Season filter dropdown: "All Seasons" + list of seasons (year) from useSeasonStore
      - On selection change, call getSingleSeasonLeaders(dynastyId, selectedStatKey, 10, selectedSeasonId)
      - Display results in RecordsLeaderboard with showYear=true
      - Default selection: first stat category (passingYards for CFB)
    - **Career Records tab:**
      - Stat category dropdown: same as above
      - On selection change, call getCareerLeaders(dynastyId, selectedStatKey, 10)
      - Display results in RecordsLeaderboard with showYear=false
    - **Head-to-Head tab:**
      - Era filter: "All Time" + decade options derived from dynasty seasons (e.g., "2020-2029", "2030-2039") — compute from min/max season years. Note: coaching staff filter is out of scope for V1 (no coaching era data in the data model); only year-range era filtering is supported.
      - On filter change, call getHeadToHeadRecords(dynastyId, { startYear, endYear })
      - Display results in HeadToHeadRecords component
    - All data loads on tab switch / filter change (no pre-loading all tabs)
    - Loading spinner while fetching
    - Styling: bg-gray-900 base, bg-gray-800 cards, tab bar with active tab indicator (blue underline or bg highlight)

    **App.tsx** — Add 'records' case to the page switch, import RecordsPage.

    **DashboardPage.tsx** — Add "Records" button in the Actions panel:
    ```tsx
    <button onClick={() => useNavigationStore.getState().goToRecords()}
      className="w-full px-4 py-2.5 bg-gray-700 hover:bg-gray-600 ...">
      Records & Leaderboards
    </button>
    ```
  </action>
  <verify>
    Run `pnpm run build` from root. Zero TypeScript errors. Verify via dev server:
    1. Dashboard shows "Records & Leaderboards" button
    2. Records page loads with three tabs
    3. Single-season tab: select a stat, see top 10 players (requires logged season stats from Plan 02)
    4. Filter by specific season narrows results
    5. Career tab: select a stat, see all-time top 10
    6. Head-to-head tab: shows W/L/T record against each opponent
    7. Era filter on H2H narrows to year range
    8. Click a player name on any leaderboard to navigate to their profile
    9. Expanding an H2H row shows individual game results
    10. Empty states show appropriate messages when no data exists
  </verify>
  <done>
    Records page shows single-season and career leaderboards for any stat category. Head-to-head records display W/L/T, win percentage, and current streak against all opponents with year-range era filter (coaching staff filter deferred to future enhancement). Player names link to profiles. All three tabs work with appropriate empty states.
  </done>
</task>

</tasks>

<verification>
- `pnpm run build` passes from repo root
- Single-season leaders correctly rank by stat value
- Career leaders correctly aggregate across all player seasons
- H2H records match actual game log data (wins + losses = total games)
- Current streak calculation is accurate (consecutive same results from most recent game)
- Era filter correctly bounds games by year range
- Tab switching loads fresh data (no stale display)
- Player names on leaderboards link to profile pages
</verification>

<success_criteria>
1. Single-season records show top 10 per stat category, filterable by season
2. Career records show all-time top 10 per stat category
3. Head-to-head records show W/L/T, win %, and streak against every opponent
4. Year-range era filter narrows H2H results
5. Clicking a player name navigates to their profile
6. Records page is accessible from dashboard
7. Zero TypeScript errors on build
</success_criteria>

<output>
After completion, create `.planning/phases/03-player-tracking-and-records/03-04-SUMMARY.md`
</output>
