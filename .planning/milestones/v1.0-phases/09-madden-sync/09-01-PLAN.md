# Plan 09-01: Sidecar Infrastructure + Save File Adapter

## Goal
Establish the Tauri sidecar architecture for reading Madden franchise `.frs` binary save files
using the `madden-franchise` Node.js library, plus the save file picker UI and version-check
guard with clear fallback messaging for unsupported Madden versions.

## Approach: Tauri Sidecar
`madden-franchise` is a Node.js library that calls `fs.readFileSync()` internally — it cannot
run in the Tauri browser sandbox. Solution: bundle a small Node.js script as a Tauri sidecar
(shell wrapper for dev, `pkg`-compiled binary for production), invoked via `tauri-plugin-shell`.

## Tasks

### Task 1: Sidecar script and binaries
- [ ] Create `src-tauri/sidecar/package.json` with `madden-franchise` dep
- [ ] Create `src-tauri/sidecar/madden-reader.cjs` — Node.js script with `validate` and `extract`
      subcommands; outputs JSON to stdout; exits with code 1 on error
- [ ] Create `src-tauri/binaries/madden-reader-aarch64-apple-darwin` — shell wrapper for macOS arm64
- [ ] Create `src-tauri/binaries/madden-reader-x86_64-apple-darwin` — shell wrapper for macOS x86_64
- [ ] `chmod +x` both wrappers

### Task 2: Tauri configuration
- [ ] Add `tauri-plugin-shell = "2"` to `src-tauri/Cargo.toml`
- [ ] Register `tauri_plugin_shell::init()` in `src/lib.rs`
- [ ] Add `"externalBin": ["binaries/madden-reader"]` to `tauri.conf.json` bundle section
- [ ] Add `"shell:allow-execute"`, `"shell:allow-open"` to `capabilities/default.json`

### Task 3: Frontend shell plugin
- [ ] Add `"@tauri-apps/plugin-shell": "^2"` to `apps/desktop/package.json`
- [ ] Run `pnpm install`

### Task 4: madden-sync-service.ts
- [ ] `pickSaveFile()` — Tauri dialog filtered to `.frs`
- [ ] `validateSaveFile(path)` — sidecar validate subcommand
- [ ] `extractSaveData(path)` — sidecar extract subcommand
- [ ] `computeSyncDiff()` — maps extracted data to Dynasty OS types, dedupes
- [ ] `commitSyncDiff()` — writes games, players, draft picks to DB
- [ ] Save path localStorage helpers

### Task 5: MaddenSyncPage.tsx — file picker + validation states
- [ ] SyncState: idle → validating → unsupported | validated
- [ ] File picker with stored path display
- [ ] Unsupported version fallback with manual entry options

## Success Criteria
- Sidecar binary executes when invoked from frontend
- Valid `.frs` file returns `{ valid: true, gameYear, supported }`
- Madden 26 returns clear fallback message with manual entry options
- Invalid file returns clear error message

## Notes
- Production binary: `npx pkg sidecar/madden-reader.cjs --target node18-macos-arm64 --output binaries/madden-reader-aarch64-apple-darwin`
- madden-franchise supports Madden 19–25; Madden 26 schema support in-progress
